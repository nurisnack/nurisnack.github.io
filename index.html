<!DOCTYPE html>
<html lang="id">
<head>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>NURI SNACK</title>
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#046043">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Nuri Snack">
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iZyIgeDE9IjAlIiB5MT0iMCUiIHgyPSIxMDAlIiB5Mj0iMTAwJSI+CiAgICAgIDxzdG9wIG9mZnNldD0iMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiMwNDYwNDMiLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojMmNiOTEwIi8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogIDwvZGVmcz4KICA8cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjExMiIgZmlsbD0idXJsKCNnKSIvPgogIDwhLS0gRGF1biBkZWtvcmFzaSAtLT4KICA8ZWxsaXBzZSBjeD0iNDIwIiBjeT0iODAiIHJ4PSI1NSIgcnk9IjIwIiB0cmFuc2Zvcm09InJvdGF0ZSgtNDAgNDIwIDgwKSIgZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwwLjE1KSIvPgogIDxlbGxpcHNlIGN4PSIzOTAiIGN5PSI1NSIgcng9IjQ1IiByeT0iMTYiIHRyYW5zZm9ybT0icm90YXRlKC02MCAzOTAgNTUpIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMTIpIi8+CiAgPGVsbGlwc2UgY3g9IjkwIiBjeT0iNDMwIiByeD0iNTUiIHJ5PSIyMCIgdHJhbnNmb3JtPSJyb3RhdGUoMTQwIDkwIDQzMCkiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4xNSkiLz4KICA8ZWxsaXBzZSBjeD0iMTIwIiBjeT0iNDU1IiByeD0iNDUiIHJ5PSIxNiIgdHJhbnNmb3JtPSJyb3RhdGUoMTIwIDEyMCA0NTUpIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMTIpIi8+CiAgPCEtLSBUZWtzIE5TIC0tPgogIDx0ZXh0IHg9IjI1NiIgeT0iMzEwIiBmb250LWZhbWlseT0iQXJpYWwgQmxhY2ssc2Fucy1zZXJpZiIgZm9udC13ZWlnaHQ9IjkwMCIKICAgICAgICBmb250LXNpemU9IjIyMCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0id2hpdGUiIGxldHRlci1zcGFjaW5nPSItOCI+TlM8L3RleHQ+CiAgPCEtLSBHYXJpcyBiYXdhaCBkZWtvcmF0aWYgLS0+CiAgPHJlY3QgeD0iMTU2IiB5PSIzMzYiIHdpZHRoPSIyMDAiIGhlaWdodD0iOCIgcng9IjQiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC41KSIvPgogIDwhLS0gVGVrcyBrZWNpbCAtLT4KICA8dGV4dCB4PSIyNTYiIHk9IjM5MCIgZm9udC1mYW1pbHk9IkFyaWFsLHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iNDIiCiAgICAgICAgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwwLjg1KSIgbGV0dGVyLXNwYWNpbmc9IjQiPlNOQUNLPC90ZXh0Pgo8L3N2Zz4=">
  <meta name="msapplication-TileColor" content="#046043">
  <meta name="msapplication-TileImage" content="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iZyIgeDE9IjAlIiB5MT0iMCUiIHgyPSIxMDAlIiB5Mj0iMTAwJSI+CiAgICAgIDxzdG9wIG9mZnNldD0iMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiMwNDYwNDMiLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojMmNiOTEwIi8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogIDwvZGVmcz4KICA8cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjExMiIgZmlsbD0idXJsKCNnKSIvPgogIDwhLS0gRGF1biBkZWtvcmFzaSAtLT4KICA8ZWxsaXBzZSBjeD0iNDIwIiBjeT0iODAiIHJ4PSI1NSIgcnk9IjIwIiB0cmFuc2Zvcm09InJvdGF0ZSgtNDAgNDIwIDgwKSIgZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwwLjE1KSIvPgogIDxlbGxpcHNlIGN4PSIzOTAiIGN5PSI1NSIgcng9IjQ1IiByeT0iMTYiIHRyYW5zZm9ybT0icm90YXRlKC02MCAzOTAgNTUpIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMTIpIi8+CiAgPGVsbGlwc2UgY3g9IjkwIiBjeT0iNDMwIiByeD0iNTUiIHJ5PSIyMCIgdHJhbnNmb3JtPSJyb3RhdGUoMTQwIDkwIDQzMCkiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4xNSkiLz4KICA8ZWxsaXBzZSBjeD0iMTIwIiBjeT0iNDU1IiByeD0iNDUiIHJ5PSIxNiIgdHJhbnNmb3JtPSJyb3RhdGUoMTIwIDEyMCA0NTUpIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMTIpIi8+CiAgPCEtLSBUZWtzIE5TIC0tPgogIDx0ZXh0IHg9IjI1NiIgeT0iMzEwIiBmb250LWZhbWlseT0iQXJpYWwgQmxhY2ssc2Fucy1zZXJpZiIgZm9udC13ZWlnaHQ9IjkwMCIKICAgICAgICBmb250LXNpemU9IjIyMCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0id2hpdGUiIGxldHRlci1zcGFjaW5nPSItOCI+TlM8L3RleHQ+CiAgPCEtLSBHYXJpcyBiYXdhaCBkZWtvcmF0aWYgLS0+CiAgPHJlY3QgeD0iMTU2IiB5PSIzMzYiIHdpZHRoPSIyMDAiIGhlaWdodD0iOCIgcng9IjQiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC41KSIvPgogIDwhLS0gVGVrcyBrZWNpbCAtLT4KICA8dGV4dCB4PSIyNTYiIHk9IjM5MCIgZm9udC1mYW1pbHk9IkFyaWFsLHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iNDIiCiAgICAgICAgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwwLjg1KSIgbGV0dGVyLXNwYWNpbmc9IjQiPlNOQUNLPC90ZXh0Pgo8L3N2Zz4=">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background: #f0f4f8; padding: 10px; }
    .container { max-width: 1000px; margin: 0 auto; }
    .header { background: linear-gradient(135deg, #046043eb, #2cb9109c); color: #f9fafb; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
    .header h1 { font-size: 1.6em; margin-bottom: 5px; }
    .header p { font-size: 0.9em; }
    .tabs { display: flex; gap: 5px; margin-bottom: 15px; flex-wrap: wrap; }
    .tab-btn { padding: 8px 12px; background: white; border: 2px solid #ddd; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 0.85em; flex: 1; min-width: 80px; transition: all 0.3s; }
    .tab-btn:hover { background: #f3ffad; border-color: #2cb910; }
    .tab-btn.active { background: linear-gradient(135deg, #046043eb, #2cb9109c); color: white; border-color: #2cb910; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .card { background: #eaf7e8; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; }
    .card h2 { margin-bottom: 12px; color: #046043; font-size: 1.1em; }
    .form-group { margin-bottom: 12px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #2cb910; font-size: 0.9em; }
    .form-group input, .form-group select { width: 100%; padding: 8px; border: 2px solid #d4f8d4; border-radius: 5px; font-size: 1em; }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: #2cb910; background: #f3ffad; }
    .product-option { display: flex; align-items: center; gap: 8px; padding: 5px; }
    .product-option-img { width: 30px; height: 30px; object-fit: cover; border-radius: 3px; }
    #productSelect { height: auto; min-height: 40px; }
    .btn { padding: 8px 12px; background: linear-gradient(135deg, #046043eb, #2cb9109c); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 0.85em; transition: all 0.3s; }
    .btn:hover:not(:disabled) { background: linear-gradient(135deg, #2cb910, #046043); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(44, 185, 16, 0.3); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-danger { background: #ef4444; }
    .btn-danger:hover { background: #dc2626; transform: translateY(-2px); }
    .btn-success { background: linear-gradient(135deg, #046043eb, #2cb9109c); }
    .btn-success:hover { background: linear-gradient(135deg, #2cb910, #046043); }
    .btn-info { background: linear-gradient(135deg, #046043eb, #2cb9109c); }
    .btn-info:hover { background: linear-gradient(135deg, #2cb910, #046043); }
    .item-row { background: #f3ffad; padding: 10px; border-radius: 5px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #2cb910; gap: 5px; flex-wrap: wrap; }
    .item-info { flex: 1; min-width: 150px; }
    .item-name { font-weight: bold; color: #333; font-size: 0.95em; }
    .item-price { color: #666; font-size: 0.85em; }
    .qty-control { display: flex; gap: 3px; align-items: center; }
    .qty-btn { width: 28px; height: 28px; padding: 0; font-size: 0.85em; }
    .qty-display { width: 30px; text-align: center; font-weight: bold; }
    .total-section { background: linear-gradient(135deg, #d4f8d4, #f3ffad); padding: 12px; border-radius: 5px; font-size: 1.1em; font-weight: bold; text-align: right; border-left: 4px solid #2cb910; color: #2cb910; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; justify-content: center; align-items: center; padding: 20px; }
    .modal.show { display: flex; }
    .modal-content { background: white; padding: 25px; border-radius: 12px; max-width: 450px; width: 100%; max-height: 80vh; overflow-y: auto; border-top: 4px solid #2cb910; box-shadow: 0 10px 40px rgba(44, 185, 16, 0.3); }
    .modal-close { float: right; cursor: pointer; font-size: 1.5em; color: #2cb910; }
    .modal-content h2 { font-size: 1.1em; margin-bottom: 15px; color: #2cb910; }
    .modal-content h3 { font-size: 0.95em; margin-top: 15px; margin-bottom: 10px; color: #2cb910; }
    .empty-msg { text-align: center; color: #999; padding: 20px; font-size: 0.9em; }
    .table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
    .table th { background: linear-gradient(135deg, #d4f8d4, #f3ffad); padding: 8px; text-align: left; border-bottom: 2px solid #2cb910; font-weight: bold; color: #2cb910; }
    .table td { padding: 8px; border-bottom: 1px solid #ddd; }
    .table tbody tr { cursor: pointer; transition: all 0.2s; }
    .table tbody tr:hover { background: #f3ffad; transform: scale(1.01); }
    .struk { border: 2px dashed #2cb910; padding: 12px; font-family: monospace; font-size: 0.85em; margin-bottom: 15px; }
    .stat-item { font-size: 0.9em; margin-bottom: 8px; }
    .stat-item strong { color: #2cb910; }
    .image-preview-container { position: relative; display: inline-block; max-width: 100%; }
    .image-remove-btn { position: absolute; top: 5px; right: 5px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 1.2em; font-weight: bold; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.3); transition: all 0.2s; }
    .image-remove-btn:hover { background: #dc2626; transform: scale(1.1); }
    .product-card { background: white; border: 2px solid #d4f8d4; border-radius: 8px; padding: 10px; cursor: pointer; transition: all 0.3s; text-align: center; }
    .product-card:hover { border-color: #2cb910; background: #f3ffad; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(44, 185, 16, 0.3); }
    .product-card.selected { border-color: #2cb910; background: #f3ffad; border-width: 3px; }
    .product-card-img { width: 100%; height: 80px; object-fit: cover; border-radius: 5px; margin-bottom: 8px; background: #f0f4f8; }
    .product-card-name { font-weight: bold; font-size: 0.85em; margin-bottom: 5px; color: #333; }
    .product-card-price { color: #2cb910; font-size: 0.8em; font-weight: bold; }
    .transaction-card { position: relative; cursor: pointer; transition: all 0.3s; }
    .transaction-card:hover { background: #f3ffad !important; transform: scale(1.02); box-shadow: 0 4px 12px rgba(44, 185, 16, 0.2); }
    .delete-transaction-btn { position: absolute; top: 10px; right: 10px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 1.1em; font-weight: bold; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: all 0.2s; z-index: 10; }
    .delete-transaction-btn:hover { background: #dc2626; transform: scale(1.1); }
    .delete-transaction-btn.hidden { display: none; }
    @media print {
      body * { visibility: hidden; }
      
      /* Hanya tampilkan printModal jika sedang terbuka */
      #printModal.show, #printModal.show * { visibility: visible; }
      #printModal.show { 
        position: fixed !important; 
        left: 0 !important; 
        top: 0 !important; 
        width: 100% !important;
        height: 100vh !important;
        margin: 0 !important;
        padding: 10mm 5mm 10mm 10mm !important;
        background: white !important; 
        display: block !important;
      }
      
      /* Hanya tampilkan invoiceModal jika sedang terbuka */
      #invoiceModal.show, #invoiceModal.show * { visibility: visible; }
      #invoiceModal.show { 
        position: fixed !important; 
        left: 0 !important; 
        top: 0 !important; 
        width: 100% !important;
        height: 100vh !important;
        margin: 0 !important;
        padding: 10mm 5mm 10mm 10mm !important;
        background: white !important; 
        display: block !important;
      }
      
      /* Sembunyikan modal yang tidak aktif */
      #printModal:not(.show), #invoiceModal:not(.show) {
        display: none !important;
        visibility: hidden !important;
      }
      
      .modal-content { 
        max-width: 100% !important; 
        width: 100% !important;
        border: none !important; 
        box-shadow: none !important; 
        padding: 0 !important; 
        margin: 0 !important;
        height: auto !important;
        page-break-inside: avoid !important;
      }
      .modal-close, .modal-content h2, .btn { 
        display: none !important; 
        visibility: hidden !important;
      }
      #strukturDisplay, #invoiceDisplay { 
        margin: 0 !important; 
        padding: 0 !important; 
        border: none !important;
        page-break-inside: avoid !important;
      }
      .struk { 
        border: none !important; 
        margin: 0 !important; 
        padding: 0 !important; 
      }
      @page { 
        margin: 0 !important;
        size: auto;
      }
      html, body {
        height: 100vh !important;
        overflow: hidden !important;
      }
    }
    /* ‚îÄ‚îÄ Tab icon/text span ‚îÄ‚îÄ */
    .tab-icon { display: none; }
    .tab-text  { display: inline; }

    /* ‚îÄ‚îÄ Period selector ‚îÄ‚îÄ */
    .period-selector {
      display: flex; gap: 8px; margin-bottom: 20px;
    }
    .period-btn { flex: 1; padding: 8px 4px; font-size: 0.85em; white-space: nowrap; }

    /* ‚îÄ‚îÄ Barang toolbar ‚îÄ‚îÄ */
    .barang-toolbar {
      display: flex; gap: 6px; align-items: center;
      margin-bottom: 12px; flex-wrap: nowrap;
    }
    .barang-action-btn { padding: 7px 10px; font-size: 0.82em; white-space: nowrap; flex-shrink: 0; }
    .btn-label { display: inline; }

    /* ‚îÄ‚îÄ Filter toolbar ‚îÄ‚îÄ */
    .filter-toolbar {
      display: flex; gap: 5px; align-items: center;
      background: white; border: 1px solid #e5e7eb;
      border-radius: 8px; padding: 8px;
      margin-bottom: 12px; flex-wrap: nowrap;
    }
    .filter-date {
      flex: 1; min-width: 0;
      padding: 6px 4px; border: 1.5px solid #d4f8d4;
      border-radius: 5px; font-size: 0.85em;
    }
    .filter-action-btn { padding: 6px 10px; font-size: 1em; flex-shrink: 0; }

    /* ‚îÄ‚îÄ Mobile overrides ‚îÄ‚îÄ */
    @media (max-width: 520px) {
      .header { padding: 10px; }
      .header h1 { font-size: 1.3em; }
      .card { padding: 12px; margin-bottom: 12px; }
      .item-row { padding: 8px; }
      .form-group input, .form-group select { padding: 7px; font-size: 0.95em; }

      /* Tab: satu baris, ikon saja */
      .tabs { gap: 3px; flex-wrap: nowrap; overflow-x: auto; }
      .tab-btn { padding: 8px; font-size: 1.2em; flex: 1; min-width: 0; }
      .tab-icon { display: inline; }
      .tab-text  { display: none; }

      /* Dashboard period: satu baris, font lebih kecil */
      .period-selector { gap: 5px; }
      .period-btn { padding: 7px 2px; font-size: 0.72em; }

      /* Barang: sembunyikan label teks tombol, ikon saja */
      .barang-action-btn { padding: 7px 8px; font-size: 1em; }
      .btn-label { display: none; }

      /* Filter: date input lebih sempit agar cukup satu baris */
      .filter-date { font-size: 0.72em; padding: 6px 2px; }
      .filter-action-btn { padding: 6px 8px; font-size: 1em; }
    }
    /* Accordion Styles */
    .accordion-container {
      border-radius: 5px;
      overflow: hidden;
    }
    
    .accordion-item {
      margin-bottom: 8px;
      border: 1px solid #e0e0e0;
      border-radius: 5px;
      overflow: hidden;
      background: white;
    }
    
    .accordion-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      cursor: pointer;
      user-select: none;
      transition: all 0.3s ease;
      font-weight: 500;
      color: #1e40af;
    }
    
    .accordion-header:hover {
      background: linear-gradient(135deg, #e0f2fe, #bfdbfe);
    }
    
    .accordion-header:active {
      transform: scale(0.98);
    }
    
    .accordion-icon {
      transition: transform 0.3s ease;
      font-size: 0.8em;
      color: #3b82f6;
    }
    
    .accordion-item.active .accordion-icon {
      transform: rotate(180deg);
    }
    
    .accordion-item.active .accordion-header {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
    }
    
    .accordion-item.active .accordion-header .accordion-icon {
      color: white;
    }
    
    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      background: #fafafa;
    }
    
    .accordion-item.active .accordion-content {
      max-height: 2000px;
      padding: 15px;
      border-top: 1px solid #e0e0e0;
    }
    
  </style>
  <!-- PRICE LIST STYLES -->
  <style>
    #priceListModal .modal-content {
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      padding: 20px;
    }
    .pl-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
      margin-top: 14px;
    }
    .pl-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 1px 4px rgba(0,0,0,0.07);
      transition: box-shadow 0.2s, transform 0.15s, opacity 0.15s;
      cursor: grab;
      position: relative;
    }
    .pl-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.12); }
    .pl-card.pl-dragging {
      opacity: 0.32;
      transform: scale(0.96);
      cursor: grabbing;
    }
    .pl-card.pl-drag-over {
      border: 2px dashed #2cb910;
      box-shadow: 0 0 0 3px rgba(44,185,16,0.18);
      transform: scale(1.03);
    }
    .pl-drag-handle {
      position: absolute;
      top: 5px;
      left: 5px;
      z-index: 10;
      background: rgba(0,0,0,0.42);
      color: white;
      border-radius: 4px;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      cursor: grab;
      opacity: 0;
      transition: opacity 0.18s;
      line-height: 1;
      user-select: none;
    }
    .pl-card:hover .pl-drag-handle { opacity: 1; }
    .pl-card-hidden .pl-drag-handle { display: none; }
    .pl-img-wrap {
      position: relative;
      width: 100%;
      aspect-ratio: 1 / 1;
      background: #f0f4f8;
      overflow: visible;
    }
    .pl-img-wrap img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .pl-img-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5em;
      color: #ccc;
    }
    /* Status badge */
    .pl-status-badge {
      position: absolute;
      top: 6px;
      right: 6px;
      padding: 3px 7px;
      border-radius: 20px;
      font-size: 0.72em;
      font-weight: bold;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
      box-shadow: 0 1px 4px rgba(0,0,0,0.18);
      transition: transform 0.1s;
      z-index: 5;
    }
    .pl-status-badge:hover { transform: scale(1.08); }
    .pl-status-badge:active { transform: scale(0.95); }
    .pl-status-ready   { background: #16a34a; color: white; }
    .pl-status-preorder{ background: #f59e0b; color: white; }
    .pl-status-habis   { background: #ef4444; color: white; }
    .pl-status-sisa    { background: #3b82f6; color: white; }
    /* Popup status picker */
    .pl-status-picker {
      position: absolute;
      top: 32px;
      right: 4px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      z-index: 100;
      overflow: hidden;
      min-width: 130px;
    }
    .pl-status-opt {
      padding: 8px 12px;
      font-size: 0.82em;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 7px;
      transition: background 0.15s;
    }
    .pl-status-opt:hover { background: #f3f4f6; }
    .pl-sisa-input-row {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 6px 10px;
      border-top: 1px solid #f0f0f0;
    }
    .pl-sisa-input-row input {
      width: 52px;
      padding: 4px 6px;
      border: 1.5px solid #3b82f6;
      border-radius: 5px;
      font-size: 0.82em;
      text-align: center;
    }
    .pl-sisa-input-row button {
      padding: 4px 9px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 0.8em;
      cursor: pointer;
    }
    .pl-info {
      padding: 8px 10px 10px;
      text-align: center;
    }
    .pl-name {
      font-size: 0.83em;
      font-weight: bold;
      color: #333;
      margin-bottom: 3px;
      word-break: break-word;
      line-height: 1.3;
    }
    .pl-price {
      font-size: 0.88em;
      color: #2cb910;
      font-weight: bold;
    }
    .pl-status-hidden  { background: #6b7280; color: white; }
    .pl-card-hidden { opacity: 0.45; filter: grayscale(60%); }
    .pl-hidden-accordion {
      margin-top: 14px;
      border: 1.5px dashed #d1d5db;
      border-radius: 8px;
      overflow: hidden;
    }
    .pl-hidden-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 9px 13px;
      background: #f9fafb;
      cursor: pointer;
      user-select: none;
      font-size: 0.85em;
      color: #6b7280;
      font-weight: 600;
      gap: 8px;
    }
    .pl-hidden-header:hover { background: #f3f4f6; }
    .pl-hidden-body { padding: 10px; display: none; }
    .pl-hidden-body.open { display: block; }
    @media (max-width: 480px) {
      .pl-grid { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 8px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div style="display: flex; align-items: center; gap: 15px;">
        <img id="logoImg" src="" alt="Logo" style="height: 60px; display: none;">
        <div>
          <h1>NURI SNACK</h1>
          <p>Cemilan Seru Buat Semua</p>
        </div>
      </div>
    </div>

    <!-- PWA Install Banner -->
    <div id="pwa-banner" style="display:none; background:linear-gradient(135deg,#046043,#2cb910);
      padding:10px 16px; margin-bottom:8px; border-radius:8px;
      display:none; align-items:center; justify-content:space-between; gap:10px;">
      <div style="color:white; font-size:0.85em; line-height:1.4;">
        <strong>üì≤ Install Aplikasi</strong><br>
        <span style="opacity:0.9; font-size:0.92em;">Tambahkan ke layar utama HP</span>
      </div>
      <div style="display:flex; gap:8px; flex-shrink:0;">
        <button id="pwa-install-btn" style="background:white; color:#046043; border:none;
          padding:7px 14px; border-radius:6px; font-weight:700; font-size:0.85em; cursor:pointer;">
          Install
        </button>
        <button id="pwa-dismiss-btn" style="background:rgba(255,255,255,0.25); color:white; border:none;
          padding:7px 10px; border-radius:6px; font-size:0.85em; cursor:pointer;">
          ‚úï
        </button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" onclick="showTab('penjualan')"><span class="tab-icon">üõí</span><span class="tab-text">Penjualan</span></button>
      <button class="tab-btn" onclick="showTab('dashboard')"><span class="tab-icon">üìä</span><span class="tab-text">Dashboard</span></button>
      <button class="tab-btn" onclick="showTab('barang')"><span class="tab-icon">üì¶</span><span class="tab-text">Barang</span></button>
      <button class="tab-btn" onclick="showTab('riwayat')"><span class="tab-icon">üìã</span><span class="tab-text">Riwayat</span></button>
      <button class="tab-btn" onclick="openPriceList()" title="Price List"><span class="tab-icon">üè∑Ô∏è</span><span class="tab-text">Harga</span></button>
      <button class="tab-btn" onclick="openSettings()"><span class="tab-icon">‚öôÔ∏è</span><span class="tab-text">Pengaturan</span></button>
    </div>

    <!-- TAB DASHBOARD -->
    <div id="dashboard" class="tab-content">
      <div class="card">
        <h2>üìä Dashboard Analytics</h2>
        
        <!-- Period Selector -->
        <div class="period-selector">
          <button class="btn period-btn" onclick="changePeriod('today')" id="btnToday">Hari Ini</button>
          <button class="btn period-btn" onclick="changePeriod('week')"  id="btnWeek">7 Hari</button>
          <button class="btn period-btn" onclick="changePeriod('month')" id="btnMonth">30 Hari</button>
          <button class="btn period-btn" onclick="changePeriod('all')"   id="btnAll">Semua</button>
        </div>

        <!-- Summary Cards -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">
          <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 0.85em; opacity: 0.9;">Total Penjualan</div>
            <div style="font-size: 1.8em; font-weight: bold; margin-top: 5px;" id="totalSales">Rp 0</div>
          </div>
          <div style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 0.85em; opacity: 0.9;">Jumlah Transaksi</div>
            <div style="font-size: 1.8em; font-weight: bold; margin-top: 5px;" id="totalTransactions">0</div>
          </div>
          <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 0.85em; opacity: 0.9;">Rata-rata/Transaksi</div>
            <div style="font-size: 1.8em; font-weight: bold; margin-top: 5px;" id="avgTransaction">Rp 0</div>
          </div>
          <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 0.85em; opacity: 0.9;">Invoice Pending</div>
            <div style="font-size: 1.8em; font-weight: bold; margin-top: 5px;" id="pendingInvoices">0</div>
          </div>
        </div>

        <!-- Chart -->
        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
          <h3 style="margin-bottom: 15px; color: #2cb910;">Grafik Penjualan</h3>
          <canvas id="salesChart"></canvas>
        </div>

        <!-- Top Products -->
        <div style="background: white; padding: 15px; border-radius: 8px;">
          <h3 style="margin-bottom: 15px; color: #2cb910;">Produk Terlaris</h3>
          <div id="topProducts"></div>
        </div>
      </div>
    </div>

    <!-- TAB PENJUALAN -->
    <div id="penjualan" class="tab-content active">
      <div class="card">
        <h2>Pilih Barang</h2>
        <!-- Tanggal Transaksi: label kiri, input kanan -->
        <div style="display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 10px;">
          <label style="font-weight: bold; color: #2cb910; font-size: 0.9em; white-space: nowrap; margin: 0;">üìÖ Tanggal Transaksi</label>
          <input type="date" id="saleDate" style="padding: 7px 10px; border: 2px solid #d4f8d4; border-radius: 5px; font-size: 0.9em;">
        </div>
        <button class="btn btn-success" onclick="openProductModal()" style="width: 100%; padding: 12px; font-size: 1em;">
          <span style="color: #f3ffad; font-weight: bold; font-size: 1.3em;">+</span> Tambah Barang ke Keranjang
        </button>
      </div>

      <div class="card">
        <h2>Keranjang</h2>
        <div id="cartList"></div>
      </div>

      <div class="card">
        <div class="total-section">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="text-align: left; font-size: 0.95em;">
              <div style="margin-bottom: 5px;">Jenis Barang: <span id="itemTypeCount">0</span></div>
              <div>Total Pcs: <span id="totalQtyCount">0</span></div>
            </div>
            <div style="text-align: right;">
              Total: <span id="cartTotal">Rp 0</span>
            </div>
          </div>
        </div>

        <div class="form-group" style="margin-top: 15px;">
          <div style="display: flex; gap: 8px; align-items: flex-end; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 130px;">
              <label>Metode Pembayaran</label>
              <select id="paymentMethod" onchange="toggleCashUI()">
                <option value="cash">Tunai</option>
                <option value="card">Kartu</option>
                <option value="transfer">Transfer</option>
                <option value="qris">QRIS</option>
                <option value="dana">Dana</option>
                <option value="ovo">Ovo</option>
                <option value="gopay">GoPay</option>
                <option value="shopeepay">ShopeePay</option>
              </select>
            </div>
            <div id="cashUI" style="flex: 1; min-width: 130px;">
              <label>Uang Bayar</label>
              <input type="number" id="amountPaid" placeholder="Masukkan jumlah uang" oninput="calcChange()">
            </div>
          </div>
          <div id="changeUI" style="background: #f0fdf4; padding: 10px; border-radius: 5px; display: none; margin-top: 8px;">
            Kembalian: <strong id="changeAmt">Rp 0</strong>
          </div>
        </div>

        <div style="display: flex; gap: 8px; margin-top: 10px;">
          <button id="saveCartBtn" class="btn" onclick="saveCartAsInvoice()" style="flex: 1; padding: 10px; font-size: 0.95em; background: linear-gradient(135deg, #fbbf24, #f59e0b);">üíæ Simpan Keranjang</button>
          <button class="btn btn-success" onclick="checkout()" style="flex: 1; padding: 10px; font-size: 0.95em;">üí∞ Checkout & Bayar</button>
        </div>
      </div>
    </div>

    <!-- TAB BARANG -->
    <div id="barang" class="tab-content">
      <div class="card">
        <h2 style="margin-bottom: 12px;">Daftar Barang</h2>

        <!-- Search + aksi satu baris -->
        <div class="barang-toolbar">
          <div style="position: relative; flex: 1; min-width: 0;">
            <span style="position: absolute; left: 8px; top: 50%; transform: translateY(-50%); color: #aaa; font-size: 0.9em; pointer-events:none;">üîç</span>
            <input type="text" id="productSearch" placeholder="Cari..." oninput="searchProducts()"
              style="width: 100%; padding: 7px 8px 7px 28px; border: 2px solid #d4f8d4; border-radius: 5px; font-size: 0.85em; box-sizing: border-box;">
          </div>
          <button class="btn barang-action-btn" onclick="exportProducts()" title="Export">üì§ <span class="btn-label">Export</span></button>
          <button class="btn barang-action-btn" onclick="document.getElementById('importProductsFile').click()" title="Import">üì• <span class="btn-label">Import</span></button>
          <input type="file" id="importProductsFile" accept=".json" style="display: none;" onchange="importProducts(event)">
          <button class="btn btn-success barang-action-btn" onclick="openAddProductModal()">Ôºã <span class="btn-label">Tambah</span></button>
        </div>

        <p style="font-size: 0.82em; color: #999; margin-bottom: 10px;">üí° Klik pada barang untuk mengedit</p>
        
        <table class="table" id="productTable">
          <thead>
            <tr>
              <th style="width: 46px;">Gambar</th>
              <th>Nama</th>
              <th>Harga</th>
            </tr>
          </thead>
          <tbody id="productList"></tbody>
        </table>
        <div class="empty-msg" id="emptyProducts">Belum ada barang</div>
      </div>
    </div>

    <!-- TAB RIWAYAT -->
    <div id="riwayat" class="tab-content">
      <div class="card">
        <h2>Riwayat</h2>
        
        <!-- Sub-tabs untuk Penjualan dan Invoice -->
        <div style="display: flex; gap: 5px; margin-bottom: 15px;">
          <button class="tab-btn active" onclick="showHistoryTab('sales')" id="salesTabBtn" style="flex: 1;">Penjualan</button>
          <button class="tab-btn" onclick="showHistoryTab('invoices')" id="invoicesTabBtn" style="flex: 1;">Invoice</button>
        </div>

        <!-- Riwayat Penjualan -->
        <div id="salesHistory" style="display: block;">
          <!-- Checkbox tetap di DOM (dipakai JS), tapi tidak terlihat -->
          <input type="checkbox" id="showDeleteBtn" onchange="toggleDeleteButtons()" style="display: none;">
          <button class="btn" onclick="undo()" id="undoBtn" style="display: none;" disabled>‚Ü∂ Undo</button>
          <button class="btn" onclick="redo()" id="redoBtn" style="display: none;" disabled>‚Ü∑ Redo</button>

          <!-- Toolbar filter ‚Äî satu baris -->
          <div class="filter-toolbar">
            <button id="deleteBtnToggleSales" onclick="toggleDeleteBtnSales()" title="Hapus"
              style="padding: 6px 8px; font-size: 1em; border-radius: 5px; border: 1.5px solid #e5e7eb; background: #f9fafb; color: #9ca3af; cursor: pointer; flex-shrink:0; line-height:1;">üóëÔ∏è</button>
            <input type="date" id="filterStartDate" onchange="filterTransactions()" class="filter-date">
            <span style="color:#aaa; font-size:0.8em; flex-shrink:0;">‚Äî</span>
            <input type="date" id="filterEndDate" onchange="filterTransactions()" class="filter-date">
            <button class="btn filter-action-btn" id="sortBtnSales" onclick="toggleSortSales()" title="Urutkan">‚áÖ</button>
            <button class="btn filter-action-btn" onclick="clearFilter()"
              style="background:#f3f4f6; color:#374151; border:1px solid #d1d5db;">‚úï</button>
          </div>
          
          <div id="transactionList"></div>
          <div class="empty-msg" id="emptyTransactions">Belum ada transaksi</div>
        </div>

        <!-- Riwayat Invoice -->
        <div id="invoicesHistory" style="display: none;">
          <!-- Checkbox tetap di DOM (dipakai JS), tapi tidak terlihat -->
          <input type="checkbox" id="showDeleteBtnInvoice" onchange="toggleDeleteButtonsInvoice()" style="display: none;">
          <button class="btn" onclick="undoInvoice()" id="undoBtnInvoice" style="display: none;" disabled>‚Ü∂ Undo</button>
          <button class="btn" onclick="redoInvoice()" id="redoBtnInvoice" style="display: none;" disabled>‚Ü∑ Redo</button>

          <!-- Toolbar filter invoice ‚Äî satu baris -->
          <div class="filter-toolbar">
            <button id="deleteBtnToggleInvoice" onclick="toggleDeleteBtnInvoice()" title="Hapus"
              style="padding: 6px 8px; font-size: 1em; border-radius: 5px; border: 1.5px solid #e5e7eb; background: #f9fafb; color: #9ca3af; cursor: pointer; flex-shrink:0; line-height:1;">üóëÔ∏è</button>
            <input type="date" id="filterStartDateInvoice" onchange="filterInvoices()" class="filter-date">
            <span style="color:#aaa; font-size:0.8em; flex-shrink:0;">‚Äî</span>
            <input type="date" id="filterEndDateInvoice" onchange="filterInvoices()" class="filter-date">
            <button class="btn filter-action-btn" id="sortBtnInvoice" onclick="toggleSortInvoice()" title="Urutkan">‚áÖ</button>
            <button class="btn filter-action-btn" onclick="clearFilterInvoice()"
              style="background:#f3f4f6; color:#374151; border:1px solid #d1d5db;">‚úï</button>
          </div>
          
          <div id="invoiceList"></div>
          <div class="empty-msg" id="emptyInvoices">Belum ada invoice</div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL NOTIFIKASI -->
  <div id="notificationModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
      <p id="notificationMessage" style="margin-bottom: 20px; font-size: 0.95em; text-align: center;"></p>
      <button class="btn" onclick="closeNotification()" style="width: 100%; padding: 10px; background: linear-gradient(135deg, #046043eb, #2cb9109c);">OK</button>
    </div>
  </div>

  <!-- MODAL PENGATURAN -->
  <div id="settingsModal" class="modal">
    <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
      <span class="modal-close" onclick="closeSettings()">‚úï</span>
      <h2>‚öôÔ∏è Pengaturan</h2>
      
      <!-- ACCORDION STYLE -->
      <div class="accordion-container" style="margin-top: 15px;">
        
        <!-- Section 1: Logo Toko -->
        <div class="accordion-item">
          <div class="accordion-header" onclick="toggleAccordion(this)">
            <span>üé® Logo Toko</span>
            <span class="accordion-icon">‚ñº</span>
          </div>
          <div class="accordion-content">
            <div class="form-group">
              <label>Upload Logo (atau paste URL)</label>
              <input type="text" id="logoUrl" placeholder="Paste URL logo atau gunakan tombol di bawah">
              <button class="btn" onclick="document.getElementById('logoFile').click()" style="width: 100%; margin-top: 8px; padding: 8px;">üì∑ Upload Logo</button>
              <input type="file" id="logoFile" accept="image/*" style="display: none;" onchange="uploadLogo()">
              <button class="btn btn-danger" onclick="removeLogo()" style="width: 100%; margin-top: 5px; padding: 8px;">Hapus Logo</button>
            </div>
          </div>
        </div>

        <!-- Section 2: Informasi Toko -->
        <div class="accordion-item">
          <div class="accordion-header" onclick="toggleAccordion(this)">
            <span>üè™ Informasi Toko</span>
            <span class="accordion-icon">‚ñº</span>
          </div>
          <div class="accordion-content">
            <div class="form-group">
              <label>Nama Toko</label>
              <input type="text" id="storeName" placeholder="Nama toko">
            </div>
            <div class="form-group">
              <label>Nomor Telepon</label>
              <input type="text" id="storePhone" placeholder="Nomor telepon">
            </div>
          </div>
        </div>

        <!-- Section 3: Kelola Data -->
        <div class="accordion-item">
          <div class="accordion-header" onclick="toggleAccordion(this)">
            <span>üíæ Kelola Data</span>
            <span class="accordion-icon">‚ñº</span>
          </div>
          <div class="accordion-content">
            <button class="btn" onclick="backup()" style="width: 100%; margin-bottom: 8px; padding: 8px;">üíæ Backup</button>
            <button class="btn" onclick="document.getElementById('fileRestore').click()" style="width: 100%; margin-bottom: 8px; padding: 8px;">üì• Restore</button>
            <input type="file" id="fileRestore" accept=".json" style="display: none;" onchange="restore()">
          </div>
        </div>

        <!-- Section 4: Statistik -->
        <div class="accordion-item">
          <div class="accordion-header" onclick="toggleAccordion(this)">
            <span>üìä Statistik</span>
            <span class="accordion-icon">‚ñº</span>
          </div>
          <div class="accordion-content">
            <div class="stat-item">Total Transaksi: <strong id="statTrans">0</strong></div>
            <div class="stat-item">Total Pendapatan: <strong id="statRevenue">Rp 0</strong></div>
            <div class="stat-item">Total Invoice: <strong id="statInvoices">0</strong></div>
            <div class="stat-item">Invoice Pending: <strong id="statInvoicesPending">0</strong></div>
          </div>
        </div>

        <!-- Section 5: Pengaturan Database (Firebase) -->
        <div class="accordion-item">
          <div class="accordion-header" onclick="toggleAccordion(this)">
            <span>üî• Pengaturan Database (Firebase)</span>
            <span class="accordion-icon">‚ñº</span>
          </div>
          <div class="accordion-content">
            <p style="font-size: 0.85em; color: #666; margin-bottom: 10px;">Hubungkan ke Firebase untuk backup otomatis ke cloud</p>
            
            <div class="form-group">
              <label>API Key</label>
              <input type="text" id="firebaseApiKey" placeholder="AIzaSy..." style="font-size: 0.85em;">
            </div>
            <div class="form-group">
              <label>Auth Domain</label>
              <input type="text" id="firebaseAuthDomain" placeholder="your-app.firebaseapp.com" style="font-size: 0.85em;">
            </div>
            <div class="form-group">
              <label>Project ID</label>
              <input type="text" id="firebaseProjectId" placeholder="your-app" style="font-size: 0.85em;">
            </div>
            <div class="form-group">
              <label>Storage Bucket</label>
              <input type="text" id="firebaseStorageBucket" placeholder="your-app.appspot.com" style="font-size: 0.85em;">
            </div>
            <div class="form-group">
              <label>Messaging Sender ID</label>
              <input type="text" id="firebaseMessagingSenderId" placeholder="123456789" style="font-size: 0.85em;">
            </div>
            <div class="form-group">
              <label>App ID</label>
              <input type="text" id="firebaseAppId" placeholder="1:123:web:abc" style="font-size: 0.85em;">
            </div>
            
            <div style="display: flex; gap: 5px; margin-bottom: 8px;">
              <button class="btn btn-success" onclick="saveFirebaseConfig()" style="flex: 1; padding: 8px; font-size: 0.9em;">üíæ Simpan</button>
              <button class="btn btn-info" onclick="testFirebase()" style="flex: 1; padding: 8px; font-size: 0.9em;">üß™ Test</button>
            </div>
            <button class="btn" onclick="manualSync()" style="width: 100%; margin-bottom: 8px; padding: 8px; background: linear-gradient(135deg, #10b981, #059669); color: white;">üîÑ Sync Data dari Firebase</button>
            <div id="firebaseStatus" style="padding: 8px; border-radius: 5px; font-size: 0.85em; display: none; margin-bottom: 8px;"></div>
          </div>
        </div>

        <!-- Section 6: Perbaikan Data -->
        <div class="accordion-item">
          <div class="accordion-header" onclick="toggleAccordion(this)">
            <span>üîß Perbaikan Data</span>
            <span class="accordion-icon">‚ñº</span>
          </div>
          <div class="accordion-content">
            <p style="font-size: 0.85em; color: #666; margin-bottom: 10px;">Gunakan jika ada masalah dengan data invoice</p>
            <button class="btn" onclick="forceFixInvoiceStatus()" style="width: 100%; margin-bottom: 8px; padding: 8px; background: linear-gradient(135deg, #f59e0b, #d97706);">‚öôÔ∏è Perbaiki Status Invoice</button>
          </div>
        </div>

      </div>

      <button class="btn" onclick="closeSettings()" style="width: 100%; margin-top: 15px; padding: 8px;">Tutup</button>
    </div>
  </div>

  <!-- MODAL PRINT -->
  <div id="printModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closePrint()">‚úï</span>
      <h2>Rincian Transaksi</h2>
      <div id="strukDisplay" class="struk"></div>      
      <button class="btn" onclick="doPrint()" style="width: 100%; margin-right: 0; margin-bottom: 8px; padding: 8px;">üñ®Ô∏è Cetak</button>
      <button id="copySaleBtn" class="btn btn-success" onclick="copyToNewSale()" style="width: 100%; margin-bottom: 8px; padding: 8px;">üìã Salin sebagai Penjualan Baru</button>
      <button class="btn btn-danger" onclick="closePrint()" style="width: 100%; padding: 8px;">Tutup</button>
    </div>
  </div>

  <!-- MODAL INVOICE -->
  <div id="invoiceModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeInvoice()">‚úï</span>
      <h2>Invoice / Tagihan</h2>
      <div id="invoiceDisplay" class="struk"></div>
      <button class="btn" onclick="printInvoice()" style="width: 100%; margin-right: 0; margin-bottom: 8px; padding: 8px;">üñ®Ô∏è Cetak Invoice</button>
      <button class="btn btn-danger" onclick="closeInvoice()" style="width: 100%; padding: 8px;">Tutup</button>
    </div>
  </div>

  <!-- MODAL EDIT BARANG -->
  <div id="editProductModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeEditProduct()">‚úï</span>
      <h2>Edit Barang</h2>
      <div class="form-group">
        <label>Nama Barang</label>
        <input type="text" id="editProductName" placeholder="Nama barang">
      </div>
      <div class="form-group">
        <label>Harga</label>
        <input type="number" id="editProductPrice" placeholder="Harga barang">
      </div>
      <div class="form-group">
        <label>Gambar Produk</label>
        <button class="btn" onclick="document.getElementById('editProductImageFile').click()" style="width: 100%; margin-bottom: 8px; padding: 8px;">üì∑ Ubah Gambar</button>
        <input type="file" id="editProductImageFile" accept="image/*" style="display: none;" onchange="previewEditProductImage()">
        <div class="image-preview-container" id="editProductImageContainer" style="display: none;">
          <img id="editProductImagePreview" style="max-width: 100%; max-height: 150px; margin-top: 10px; border-radius: 5px;">
          <button class="image-remove-btn" onclick="removeEditProductImage(event)" title="Hapus gambar">‚úï</button>
        </div>
      </div>
      <div style="display: flex; gap: 10px;">
        <button class="btn btn-danger" onclick="deleteProductFromModal()" style="flex: 1;">üóëÔ∏è Hapus</button>
        <button class="btn btn-success" onclick="saveEditProduct()" style="flex: 1;">üíæ Simpan</button>
      </div>
    </div>
  </div>

  <!-- MODAL TAMBAH BARANG BARU -->
  <div id="addProductModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeAddProductModal()">‚úï</span>
      <h2>‚ûï Tambah Barang Baru</h2>
      <div class="form-group">
        <label>Nama Barang</label>
        <input type="text" id="productName" placeholder="Nama barang" onkeydown="if(event.key==='Enter') document.getElementById('productPrice').focus()">
      </div>
      <div class="form-group">
        <label>Harga</label>
        <input type="number" id="productPrice" placeholder="Harga barang" onkeydown="if(event.key==='Enter') addProductFromModal()">
      </div>
      <div class="form-group">
        <label>Gambar Produk (Opsional)</label>
        <button class="btn" onclick="document.getElementById('productImageFile').click()" style="width: 100%; margin-bottom: 8px; padding: 8px;">üì∑ Upload Gambar</button>
        <input type="file" id="productImageFile" accept="image/*" style="display: none;" onchange="previewProductImage()">
        <div class="image-preview-container" id="productImageContainer" style="display: none;">
          <img id="productImagePreview" style="max-width: 100%; max-height: 150px; margin-top: 10px; border-radius: 5px;">
          <button class="image-remove-btn" onclick="removeProductImage(event)" title="Hapus gambar">‚úï</button>
        </div>
      </div>
      <div style="display: flex; gap: 10px; margin-top: 5px;">
        <button class="btn" onclick="closeAddProductModal()" style="flex: 1; background: #6b7280;">Batal</button>
        <button class="btn btn-success" onclick="addProductFromModal()" style="flex: 1;">‚úî Simpan Barang</button>
      </div>
    </div>
  </div>

  <!-- MODAL PILIH BARANG -->
  <div id="selectProductModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <span class="modal-close" onclick="closeProductModal()">‚úï</span>
      <h2>Pilih Barang</h2>
      <div id="productGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-bottom: 15px; max-height: 400px; overflow-y: auto;"></div>
      <div id="emptyProductsModal" class="empty-msg" style="display: none;">Belum ada barang. Tambah barang terlebih dahulu.</div>
      
      <div id="selectedProductInfo" style="display: none; background: #f3ffad; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #2cb910;">
        <div style="font-weight: bold; margin-bottom: 8px; color: #2cb910;">Barang Dipilih:</div>
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
          <img id="selectedProductImage" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;">
          <div style="flex: 1;">
            <div id="selectedProductName" style="font-weight: bold;"></div>
            <div id="selectedProductPrice" style="color: #2cb910;"></div>
          </div>
        </div>

        <div class="form-group" style="margin-bottom: 0;">
          <label>Catatan (Opsional)</label>
          <input type="text" id="itemNote" placeholder="Contoh: Warna merah, ukuran besar">
        </div>
        
        <div class="form-group" style="margin-bottom: 10px;">
          <label>Jumlah</label>
          <div style="display: flex; align-items: center; gap: 10px;">
            <button class="btn qty-btn" onclick="changeModalQty(-1)" style="width: 40px; height: 40px; font-size: 1.2em;">‚àí</button>
            <input type="number" id="modalQty" value="1" min="1" style="width: 80px; text-align: center; padding: 8px; border: 2px solid #2cb910; border-radius: 5px; font-weight: bold; font-size: 1.1em;" onchange="validateModalQty()">
            <button class="btn qty-btn" onclick="changeModalQty(1)" style="width: 40px; height: 40px; font-size: 1.2em;">+</button>
            <button class="btn btn-success" onclick="addToCartFromModal()" style="flex: 1; padding: 10px; display: none;" id="addToCartBtn">+ ke Keranjang</button>
          </div>
        </div>
        
      </div>
    </div>
  </div>

  <!-- MODAL DETAIL PRODUK -->
  <div id="productDetailModal" class="modal">
    <div class="modal-content" style="max-width: 500px; position: relative;">
      <span onclick="closeDetailModal()" style="position: absolute; top: 15px; right: 15px; color: #ef4444; background: #fee; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 1.3em; font-weight: bold; cursor: pointer; z-index: 10;">‚úï</span>
      
      <h2 style="color: #2cb910; margin-bottom: 20px; margin-top: 5px;">Barang Dipilih:</h2>
      
      <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px; padding: 15px; background: #f3ffad; border-radius: 8px; border-left: 4px solid #2cb910;">
        <img id="detailProdImg" style="width: 70px; height: 70px; object-fit: cover; border-radius: 8px; border: 2px solid #2cb910;">
        <div style="flex: 1;">
          <div id="detailProdName" style="font-weight: bold; font-size: 1.1em; color: #333; margin-bottom: 5px;"></div>
          <div id="detailProdPrice" style="color: #2cb910; font-weight: bold; font-size: 1.2em;"></div>
        </div>
      </div>

      <div class="form-group">
        <label style="color: #2cb910; font-weight: bold;">Catatan (Opsional)</label>
        <input type="text" id="detailNote" placeholder="Contoh: Warna merah, ukuran besar">
      </div>

      <div class="form-group" style="margin-bottom: 0;">
        <label style="color: #2cb910; font-weight: bold;">Jumlah</label>
        <div style="display: flex; align-items: center; gap: 10px;">
          <button class="btn btn-danger" onclick="changeDetailQty(-1)" style="width: 60px; height: 60px; font-size: 1.8em; font-weight: bold; border-radius: 8px;">‚àí</button>
          <input type="number" id="detailQtyInput" value="1" min="1" readonly style="width: 100px; text-align: center; padding: 15px; border: 3px solid #2cb910; border-radius: 8px; font-weight: bold; font-size: 1.5em; background: white;">
          <button class="btn btn-success" onclick="changeDetailQty(1)" style="width: 60px; height: 60px; font-size: 1.8em; font-weight: bold; border-radius: 8px;">+</button>
        </div>
      </div>

      <button class="btn btn-success" onclick="confirmAddToCart()" style="width: 100%; padding: 15px; font-size: 1.1em; margin-top: 20px; border-radius: 8px; font-weight: bold;">+ ke Keranjang</button>
    </div>
  </div>

  <!-- MODAL PRICE LIST -->
  <div id="priceListModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closePriceList()">‚úï</span>

      <!-- Header: logo + judul -->
      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
        <img id="plLogoImg" src="" alt="Logo" style="height: 48px; border-radius: 6px; display: none; object-fit: contain;">
        <h2 style="margin: 0;">üè∑Ô∏è Price List</h2>
      </div>

      <!-- Tombol Ekspor -->
      <div style="display:flex; gap:6px; flex-wrap:wrap; margin-bottom:12px;">
        <button class="btn" onclick="printPriceList()" style="padding:7px 14px; font-size:0.82em;">üñ®Ô∏è Print</button>
        <button class="btn" onclick="downloadPriceList('png')" style="padding:7px 14px; font-size:0.82em; background:linear-gradient(135deg,#3b82f6,#2563eb);">üñºÔ∏è Simpan Gambar</button>
        <button class="btn" onclick="downloadPriceList('pdf')" style="padding:7px 14px; font-size:0.82em; background:linear-gradient(135deg,#ef4444,#dc2626);">üì• PDF</button>
      </div>

      <!-- Drag hint + reset -->
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:4px; margin-top:2px;">
        <span style="font-size:0.72em; color:#aaa;">‚†ø Seret kartu untuk mengatur urutan</span>
        <button onclick="resetPlOrder()" style="font-size:0.72em; color:#888; background:none; border:none; cursor:pointer; padding:2px 6px; border-radius:4px;" title="Reset ke urutan semula">‚Ü∫ Reset urutan</button>
      </div>

      <!-- Visible products grid -->
      <div class="pl-grid" id="priceListGrid"></div>
      <div class="empty-msg" id="priceListEmpty" style="display:none;">Belum ada barang. Tambah barang di tab Barang.</div>

      <!-- Hidden products accordion -->
      <div class="pl-hidden-accordion" id="plHiddenAccordion" style="display:none;">
        <div class="pl-hidden-header" onclick="togglePlHiddenAccordion()">
          <span>üôà Produk Disembunyikan (<span id="plHiddenCount">0</span>)</span>
          <span id="plHiddenChevron">‚ñº</span>
        </div>
        <div class="pl-hidden-body" id="plHiddenBody">
          <div class="pl-grid" id="plHiddenGrid"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL KONFIRMASI CUSTOM -->
  <div id="confirmDialog" class="modal">
    <div class="modal-content" style="max-width: 400px; text-align: center;">
      <h2 id="confirmTitle" style="color: #f59e0b; margin-bottom: 15px;">‚ö†Ô∏è Konfirmasi</h2>
      <p id="confirmMessage" style="color: #666; margin-bottom: 25px; line-height: 1.6;"></p>
      <div style="display: flex; gap: 10px;">
        <button id="confirmCancelBtn" class="btn" style="flex: 1; padding: 12px; background: #6b7280;">Batal</button>
        <button id="confirmOkBtn" class="btn btn-danger" style="flex: 1; padding: 12px;">Hapus</button>
      </div>
    </div>
  </div>

  <script>

    // ============================================
    // FIREBASE INITIALIZATION
    // ============================================
    let firebaseDB = null;
    let firebaseStorage = null;
    let isFirebaseReady = false;

    function initFirebase() {
      const configStr = localStorage.getItem('firebase_config');
      if (!configStr) {
        console.warn('Firebase not configured. Using localStorage only.');
        return false;
      }
      
      try {
        const config = JSON.parse(configStr);
        if (!firebase.apps.length) {
          firebase.initializeApp(config);
        }
        firebaseDB = firebase.firestore();
        firebaseStorage = firebase.storage();
        isFirebaseReady = true;
        console.log('Firebase initialized');
        return true;
      } catch (error) {
        console.error('Firebase init error:', error);
        return false;
      }
    }

    // Try to init Firebase on load
    try {
      initFirebase();
    } catch (e) {
      console.log('Firebase init deferred');
    }

    // ============================================
    // FIREBASE SYNC FUNCTIONS
    // ============================================
    
    async function syncToFirebase() {
      if (!isFirebaseReady) return;
      
      try {
        // Sync ALL products (tidak dibatasi, semua data)
        for (const product of products) {
          const exists = await firebaseDB.collection('products')
            .where('id', '==', product.id)
            .get();
          
          if (exists.empty) {
            await firebaseDB.collection('products').add({
              id: product.id,  // ‚Üê TAMBAHKAN ID!
              name: product.name,
              price: product.price,
              image: product.image || '',
              timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
        }
        
        // Sync ALL transactions (tidak dibatasi, semua data)
        for (const tx of transactions) {
          const exists = await firebaseDB.collection('transactions')
            .where('date', '==', tx.date)
            .where('invoiceNumber', '==', tx.invoiceNumber || '')
            .get();
          
          if (exists.empty) {
            const timestamp = parseDateToFirebaseTimestamp(tx.date);
            await firebaseDB.collection('transactions').add({
              items: tx.items,
              total: tx.total,
              // Normalize local `method`/`payment`/`paymentMethod` to Firebase `payment`
              payment: tx.method || tx.payment || tx.paymentMethod || 'cash',
              date: tx.date,
              invoiceNumber: tx.invoiceNumber,
              timestamp: timestamp
            });
          }
        }
        
        // Sync ALL invoices (tidak dibatasi, semua data)
        for (const inv of invoices) {
          const exists = await firebaseDB.collection('invoices')
            .where('date', '==', inv.date)
            .where('invoiceNumber', '==', inv.invoiceNumber)
            .get();
          
          if (exists.empty) {
            await firebaseDB.collection('invoices').add({
              items: inv.items,
              total: inv.total,
              // Normalize local invoice payment field
              payment: inv.paymentMethod || inv.payment || inv.method || 'cash',
              date: inv.date,
              invoiceNumber: inv.invoiceNumber,
              status: inv.status || 'pending',
              timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
        }
      } catch (error) {
        console.error('Sync error:', error);
      }
    }
    
    // ============================================
    // DELETE FROM FIREBASE
    // ============================================
    async function deleteFromFirebase(collection, docId) {
      if (!isFirebaseReady) {
        console.log('Firebase not ready, skip delete');
        return;
      }
      
      try {
        await firebaseDB.collection(collection).doc(docId).delete();
        console.log(`‚úì Deleted from Firebase: ${collection}/${docId}`);
      } catch (error) {
        console.error(`Firebase delete error (${collection}/${docId}):`, error);
      }
    }
    
    async function deleteProductFromFirebase(productId) {
      if (!isFirebaseReady) {
        console.log('Firebase not ready, skip delete');
        return;
      }
      
      try {
        console.log('Deleting product from Firebase, ID:', productId);
        
        // Strategy 1: Delete by ID (for new products)
        const snapshotById = await firebaseDB.collection('products')
          .where('id', '==', productId)
          .get();
        
        console.log('Found by ID:', snapshotById.size, 'document(s)');
        
        // Strategy 2: If not found by ID, try by name (for old products)
        let snapshotByName = { size: 0, docs: [] };
        if (snapshotById.empty) {
          // Find product in local array
          const product = products.find(p => p.id == productId);
          if (product) {
            console.log('Product not found by ID, trying by name:', product.name);
            snapshotByName = await firebaseDB.collection('products')
              .where('name', '==', product.name)
              .where('price', '==', product.price)
              .get();
            console.log('Found by name+price:', snapshotByName.size, 'document(s)');
          }
        }
        
        // Combine results
        const allDocs = [
          ...snapshotById.docs,
          ...snapshotByName.docs
        ];
        
        if (allDocs.length === 0) {
          console.warn('‚ö†Ô∏è Product not found in Firebase (id:', productId, ')');
          return;
        }
        
        // Delete all matching documents
        const deletePromises = [];
        allDocs.forEach(doc => {
          console.log('Deleting document:', doc.id);
          deletePromises.push(doc.ref.delete());
        });
        
        await Promise.all(deletePromises);
        console.log(`‚úÖ Deleted ${deletePromises.length} product(s) from Firebase`);
      } catch (error) {
        console.error('‚ùå Firebase delete product error:', error);
      }
    }
    
    async function deleteTransactionFromFirebase(invoiceNumber, transactionData = null) {
      if (!isFirebaseReady) {
        console.log('Firebase not ready');
        return;
      }
      
      try {
        console.log(`üóëÔ∏è Attempting to delete transaction: ${invoiceNumber}`);
        
        // Strategi 1: Hapus dengan query berdasarkan invoiceNumber
        let snapshot = await firebaseDB.collection('transactions')
          .where('invoiceNumber', '==', invoiceNumber)
          .get();
        
        let deletedCount = 0;
        
        if (!snapshot.empty) {
          console.log(`  ‚Üí Found ${snapshot.size} document(s) by invoiceNumber`);
          const deletePromises = [];
          snapshot.forEach(doc => {
            deletePromises.push(doc.ref.delete());
          });
          await Promise.all(deletePromises);
          deletedCount = snapshot.size;
        } else {
          console.warn(`  ‚ö†Ô∏è No transaction found with invoiceNumber: ${invoiceNumber}`);
          
          // Strategi 2: Fallback - hapus dengan query date + total untuk data lama
          if (transactionData && transactionData.date && transactionData.total) {
            console.log(`  ‚Üí Trying fallback: delete by date (${transactionData.date}) + total (${transactionData.total})`);
            
            snapshot = await firebaseDB.collection('transactions')
              .where('date', '==', transactionData.date)
              .where('total', '==', transactionData.total)
              .get();
            
            if (!snapshot.empty) {
              console.log(`  ‚Üí Found ${snapshot.size} document(s) by date + total`);
              const deletePromises = [];
              snapshot.forEach(doc => {
                deletePromises.push(doc.ref.delete());
              });
              await Promise.all(deletePromises);
              deletedCount = snapshot.size;
            } else {
              console.warn(`  ‚ö†Ô∏è No transaction found with date + total fallback either`);
            }
          }
        }
        
        if (deletedCount > 0) {
          console.log(`‚úì Deleted ${deletedCount} transaction(s) from Firebase`);
        }
      } catch (error) {
        console.error('Firebase delete transaction error:', error);
        throw error;
      }
    }
    
    async function deleteInvoiceFromFirebase(invoiceNumber, invoiceData = null) {
      if (!isFirebaseReady) {
        console.log('Firebase not ready');
        return;
      }
      
      try {
        console.log(`üóëÔ∏è Attempting to delete invoice: ${invoiceNumber}`);
        
        // Strategi 1: Hapus dengan query berdasarkan invoiceNumber
        let snapshot = await firebaseDB.collection('invoices')
          .where('invoiceNumber', '==', invoiceNumber)
          .get();
        
        let deletedCount = 0;
        
        if (!snapshot.empty) {
          console.log(`  ‚Üí Found ${snapshot.size} document(s) by invoiceNumber`);
          const deletePromises = [];
          snapshot.forEach(doc => {
            deletePromises.push(doc.ref.delete());
          });
          await Promise.all(deletePromises);
          deletedCount = snapshot.size;
        } else {
          console.warn(`  ‚ö†Ô∏è No invoice found with invoiceNumber: ${invoiceNumber}`);
          
          // Strategi 2: Fallback - hapus dengan query date + total untuk data lama
          if (invoiceData && invoiceData.date && invoiceData.total) {
            console.log(`  ‚Üí Trying fallback: delete by date (${invoiceData.date}) + total (${invoiceData.total})`);
            
            snapshot = await firebaseDB.collection('invoices')
              .where('date', '==', invoiceData.date)
              .where('total', '==', invoiceData.total)
              .get();
            
            if (!snapshot.empty) {
              console.log(`  ‚Üí Found ${snapshot.size} document(s) by date + total`);
              const deletePromises = [];
              snapshot.forEach(doc => {
                deletePromises.push(doc.ref.delete());
              });
              await Promise.all(deletePromises);
              deletedCount = snapshot.size;
            } else {
              console.warn(`  ‚ö†Ô∏è No invoice found with date + total fallback either`);
            }
          }
        }
        
        if (deletedCount > 0) {
          console.log(`‚úì Deleted ${deletedCount} invoice(s) from Firebase`);
        }
      } catch (error) {
        console.error('Firebase delete invoice error:', error);
        throw error;
      }
    }
    
    async function updateProductInFirebase(product) {
      if (!isFirebaseReady) {
        console.log('Firebase not ready, skip update');
        return;
      }
      
      try {
        console.log('Updating product in Firebase, ID:', product.id);
        
        // Find document by product ID
        const snapshot = await firebaseDB.collection('products')
          .where('id', '==', product.id)
          .get();
        
        if (snapshot.empty) {
          console.log('Product not found in Firebase, adding as new...');
          // Add as new product if not exists
          await firebaseDB.collection('products').add({
            id: product.id,
            name: product.name,
            price: product.price,
            image: product.image || '',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
          console.log('‚úÖ Added new product to Firebase');
        } else {
          // Update existing document(s)
          const updatePromises = [];
          snapshot.forEach(doc => {
            console.log('Updating document:', doc.id);
            updatePromises.push(doc.ref.update({
              name: product.name,
              price: product.price,
              image: product.image || '',
              timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }));
          });
          
          await Promise.all(updatePromises);
          console.log(`‚úÖ Updated ${updatePromises.length} product(s) in Firebase`);
        }
      } catch (error) {
        console.error('‚ùå Firebase update product error:', error);
      }
    }
    
    async function loadFromFirebase() {
      if (!isFirebaseReady) {
        console.log('Firebase not ready');
        return;
      }
      
      try {
        console.log('Loading from Firebase...');
        // Load products (without orderBy to avoid missing field error)
        const productsSnapshot = await firebaseDB.collection('products')
          .limit(500)
          .get();
        console.log('Products found:', productsSnapshot.size);
        
        const fbProducts = [];
        productsSnapshot.forEach(doc => {
          const data = doc.data();
          fbProducts.push({
            id: data.id || doc.id,  // Use data.id (actual product ID), fallback to doc.id
            name: data.name,
            price: data.price,
            image: data.image || ''
          });
        });
        
        // Merge with local - load if empty OR firebase has more
        if (products.length === 0 || fbProducts.length > products.length) {
          products = fbProducts;
          localStorage.setItem('nuri_products', JSON.stringify(products));
          console.log('‚úì Loaded', products.length, 'products from Firebase');
        } else {
          console.log('‚úì Local products up to date');
        }
        
        // Load transactions
        const txSnapshot = await firebaseDB.collection('transactions')
          .orderBy('timestamp', 'desc')
          .limit(200)
          .get();
        
        const fbTransactions = [];
        txSnapshot.forEach(doc => {
          const data = doc.data();
          fbTransactions.push({
            id: doc.id,
            items: data.items,
            total: data.total,
            // Map various possible field names to local `method`
            method: data.payment || data.method || data.paymentMethod || 'cash',
            paid: data.paid || 0,
            change: data.change || 0,
            date: data.date,
            invoiceNumber: data.invoiceNumber
          });
        });
        
        if (fbTransactions.length > 0) {
          transactions = mergeArrays(transactions, fbTransactions, 'date');
          localStorage.setItem('nuri_transactions', JSON.stringify(transactions));
        }
        
        // Load invoices
        const invSnapshot = await firebaseDB.collection('invoices')
          .orderBy('timestamp', 'desc')
          .limit(100)
          .get();
        
        const fbInvoices = [];
        invSnapshot.forEach(doc => {
          const data = doc.data();
          fbInvoices.push({
            id: doc.id,
            items: data.items,
            total: data.total,
            // Normalize payment field to `paymentMethod`
            paymentMethod: data.payment || data.paymentMethod || data.method || '',
            date: data.date,
            invoiceNumber: data.invoiceNumber,
            status: data.status || 'pending'
          });
        });
        
        if (fbInvoices.length > 0) {
          invoices = mergeArrays(invoices, fbInvoices, 'date');
          localStorage.setItem('nuri_invoices', JSON.stringify(invoices));
        }
        
        console.log('Data loaded from Firebase');
      } catch (error) {
        console.error('Load error:', error);
      }
    }
    
    function mergeArrays(local, remote, keyField) {
      const map = new Map();
      
      // Gunakan invoiceNumber sebagai key utama jika ada
      local.forEach(item => {
        if (item.invoiceNumber) {
          map.set(item.invoiceNumber, item);
        } else {
          map.set(item[keyField] + '_' + item.total, item);
        }
      });
      
      remote.forEach(item => {
        const key = item.invoiceNumber ? item.invoiceNumber : (item[keyField] + '_' + item.total);
        if (map.has(key)) {
          const existing = map.get(key);
          // Gabungkan properti: keep existing, overwrite with remote when present
          map.set(key, Object.assign({}, existing, item));
        } else {
          map.set(key, item);
        }
      });
      
      return Array.from(map.values());
    }
    
    function parseDateToFirebaseTimestamp(dateStr) {
      try {
        const parts = dateStr.split(/[\s,]+/);
        const datePart = parts[0];
        const [day, month, year] = datePart.split('/');
        const dateObj = new Date(year, month - 1, day);
        return firebase.firestore.Timestamp.fromDate(dateObj);
      } catch (e) {
        return firebase.firestore.FieldValue.serverTimestamp();
      }
    }
    
    async function uploadImageToStorage(base64Data) {
      if (!isFirebaseReady || !firebaseStorage || !base64Data.startsWith('data:image')) {
        return base64Data;
      }
      
      try {
        const response = await fetch(base64Data);
        const blob = await response.blob();
        const filename = Date.now() + '.jpg';
        const ref = firebaseStorage.ref().child('products/' + filename);
        const snapshot = await ref.put(blob);
        const url = await snapshot.ref.getDownloadURL();
        return url;
      } catch (error) {
        console.error('Upload error:', error);
        return base64Data;
      }
    }
    
    // ============================================
    // SAVE DATA FUNCTION
    // ============================================
    function saveData() {
      try {
        // Save to localStorage (instant, synchronous)
        localStorage.setItem('nuri_products', JSON.stringify(products));
        localStorage.setItem('nuri_transactions', JSON.stringify(transactions));
        localStorage.setItem('nuri_invoices', JSON.stringify(invoices));
        localStorage.setItem('nuri_cart', JSON.stringify(cart));
      } catch (e) {
        if (e.name === 'QuotaExceededError') {
          console.error('‚ùå LocalStorage quota exceeded! Attempting cleanup...');
          
          // Cleanup: Hapus transaksi lebih dari 7 hari
          const oneWeekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
          const oldTxCount = transactions.length;
          transactions = transactions.filter(tx => {
            const txDate = new Date(tx.date.split(',')[0].split('/').reverse().join('-'));
            return txDate.getTime() > oneWeekAgo;
          });
          
          // Cleanup: Hapus invoice lebih dari 7 hari
          const oldInvCount = invoices.length;
          invoices = invoices.filter(inv => {
            const invDate = new Date(inv.date.split(',')[0].split('/').reverse().join('-'));
            return invDate.getTime() > oneWeekAgo;
          });
          
          console.log(`üßπ Cleaned ${oldTxCount - transactions.length} old transactions`);
          console.log(`üßπ Cleaned ${oldInvCount - invoices.length} old invoices`);
          
          // Try saving again after cleanup
          try {
            localStorage.setItem('nuri_products', JSON.stringify(products));
            localStorage.setItem('nuri_transactions', JSON.stringify(transactions));
            localStorage.setItem('nuri_invoices', JSON.stringify(invoices));
            localStorage.setItem('nuri_cart', JSON.stringify(cart));
            console.log('‚úì Data saved after cleanup');
            
            // Show notification to user
            showNotification('Data berhasil disimpan setelah membersihkan data lama (>7 hari)');
          } catch (e2) {
            console.error('‚ùå Still failed after cleanup:', e2);
            showNotification('‚ö†Ô∏è Storage penuh! Silakan backup data dan hapus data lama di Pengaturan');
          }
        } else {
          console.error('LocalStorage error:', e);
        }
      }
      
      // Sync to Firebase in background (non-blocking, fire and forget)
      if (isFirebaseReady) {
        syncToFirebase().catch(e => console.warn('Background sync failed:', e));
      }
    }
    

    let products = JSON.parse(localStorage.getItem('nuri_products') || '[]');
    let transactions = JSON.parse(localStorage.getItem('nuri_transactions') || '[]');
    let invoices = JSON.parse(localStorage.getItem('nuri_invoices') || '[]');
    let cart = JSON.parse(localStorage.getItem('nuri_cart') || '[]');
    let currentPrint = null;
    let currentInvoice = null;
    let notificationCallback = null;
    let currentEditProduct = null;
    let productImageData = null;
    let editProductImageData = null;
    let selectedProductId = null;
    let history = [];
    let historyIndex = -1;
    let invoiceHistory = [];
    let invoiceHistoryIndex = -1;
    const MAX_HISTORY = 50;
    
    // Sort order state (default: descending = terbaru di atas)
    let salesSortOrder = localStorage.getItem('sales_sort_order') || 'desc'; // 'desc' atau 'asc'
    let invoiceSortOrder = localStorage.getItem('invoice_sort_order') || 'desc'; // 'desc' atau 'asc'
    
    // Make them accessible globally
    window.salesSortOrder = salesSortOrder;
    window.invoiceSortOrder = invoiceSortOrder;

    // ============================================
    // INDEXEDDB SETUP (untuk History)
    // ============================================
    const DB_NAME = 'NuriSnackHistoryDB';
    const DB_VERSION = 1;
    let db = null;
    let dbReady = false;

    function initHistoryDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          db = request.result;
          dbReady = true;
          resolve(db);
        };
        
        request.onupgradeneeded = (event) => {
          db = event.target.result;
          if (!db.objectStoreNames.contains('transactionHistory')) {
            db.createObjectStore('transactionHistory', { keyPath: 'id', autoIncrement: true });
          }
          if (!db.objectStoreNames.contains('invoiceHistory')) {
            db.createObjectStore('invoiceHistory', { keyPath: 'id', autoIncrement: true });
          }
        };
      });
    }

    // ============================================
    // INDEXEDDB BACKUP STORAGE (untuk data utama)
    // ============================================
    let backupDB = null;
    
    function initBackupDB() {
      const request = indexedDB.open('NuriSnackBackupDB', 1);
      
      request.onupgradeneeded = (e) => {
        backupDB = e.target.result;
        if (!backupDB.objectStoreNames.contains('backup')) {
          backupDB.createObjectStore('backup');
        }
      };
      
      request.onsuccess = (e) => {
        backupDB = e.target.result;
        
        // Auto-sync setiap 3 detik
        setInterval(() => {
          if (!backupDB) return;
          try {
            const tx = backupDB.transaction('backup', 'readwrite');
            const store = tx.objectStore('backup');
            
            const keys = ['nuri_products', 'nuri_transactions', 'nuri_invoices', 'nuri_cart'];
            keys.forEach(key => {
              const value = localStorage.getItem(key);
              if (value) {
                store.put(value, key);
              }
            });
          } catch(e) {
            // Silent fail - backup adalah bonus
          }
        }, 3000);
      };
      
      request.onerror = () => {
        // Silent fail
      };
    }
    
    // Init backup DB
    initBackupDB();


    const HistoryDB = {
      getAll: (storeName) => {
        if (!dbReady) return Promise.resolve([]);
        return new Promise((resolve, reject) => {
          const transaction = db.transaction(storeName, 'readonly');
          const store = transaction.objectStore(storeName);
          const request = store.getAll();
          request.onsuccess = () => resolve(request.result || []);
          request.onerror = () => reject(request.error);
        });
      },
      
      add: (storeName, item) => {
        if (!dbReady) return Promise.resolve(null);
        return new Promise((resolve, reject) => {
          const transaction = db.transaction(storeName, 'readwrite');
          const store = transaction.objectStore(storeName);
          const request = store.add(item);
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        });
      },
      
      clear: (storeName) => {
        if (!dbReady) return Promise.resolve();
        return new Promise((resolve, reject) => {
          const transaction = db.transaction(storeName, 'readwrite');
          const store = transaction.objectStore(storeName);
          const request = store.clear();
          request.onsuccess = () => resolve();
          request.onerror = () => reject(request.error);
        });
      },
      
      deleteOldest: async (storeName, keepCount) => {
        if (!dbReady) return;
        const all = await HistoryDB.getAll(storeName);
        if (all.length <= keepCount) return;
        
        const deleteCount = all.length - keepCount;
        const transaction = db.transaction(storeName, 'readwrite');
        const store = transaction.objectStore(storeName);
        
        for (let i = 0; i < deleteCount; i++) {
          store.delete(all[i].id);
        }
      }
    };

    // ============================================
    // DATA MIGRATION
    // ============================================
    function migrateInvoiceStatus() {
      console.log('=== Starting Invoice Status Migration ===');
      console.log('Total invoices:', invoices.length);
      console.log('Total transactions:', transactions.length);
      
      let migrated = 0;
      let paidCount = 0;
      let pendingCount = 0;
      let deleted = 0;
      const deletedInvoiceNumbers = []; // Track deleted invoices
      
      // Filter out invalid invoices AND migrate valid ones
      invoices = invoices.filter((inv, index) => {
        // Skip jika sudah punya status
        if (inv.status) {
          console.log(`Invoice #${index + 1} already has status:`, inv.status);
          return true; // Keep
        }
        
        migrated++;
        
        console.log('');
        console.log(`=== Migrating Invoice #${index + 1} ===`);
        console.log('  Invoice Number:', inv.invoiceNumber || 'MISSING!');
        console.log('  Date:', inv.date);
        console.log('  Total:', inv.total);
        console.log('  Items count:', inv.items?.length || 0);
        
        // VALIDASI: Invoice harus punya invoiceNumber
        if (!inv.invoiceNumber) {
          console.warn('  ‚ö†Ô∏è WARNING: Invoice without invoiceNumber!');
          console.warn('  ‚Üí DELETING this invalid invoice');
          deleted++;
          return false; // DELETE INVOICE INVALID!
        }
        
        // VALIDASI: Invoice number tidak boleh "undefined" (string)
        if (inv.invoiceNumber === 'undefined' || inv.invoiceNumber === 'null') {
          console.warn('  ‚ö†Ô∏è WARNING: Invoice with invalid number:', inv.invoiceNumber);
          console.warn('  ‚Üí DELETING this invalid invoice');
          deletedInvoiceNumbers.push(inv.invoiceNumber); // Track untuk delete di Firebase
          deleted++;
          return false; // DELETE!
        }
        
        // Cek data pembayaran
        const hasPaid = inv.paid !== undefined && inv.paid !== null;
        const hasPaymentMethod = inv.paymentMethod !== undefined && inv.paymentMethod !== null && inv.paymentMethod !== '';
        const hasChange = inv.change !== undefined && inv.change !== null;
        
        console.log('  Payment Data Check:');
        console.log('    - paid:', inv.paid, '‚Üí', hasPaid ? 'YES' : 'NO');
        console.log('    - paymentMethod:', inv.paymentMethod, '‚Üí', hasPaymentMethod ? 'YES' : 'NO');
        console.log('    - change:', inv.change, '‚Üí', hasChange ? 'YES' : 'NO');
        
        // Cek di transactions
        const inTransactions = transactions.some(tx => 
          tx.invoiceNumber && tx.invoiceNumber === inv.invoiceNumber
        );
        console.log('  Found in transactions:', inTransactions ? 'YES' : 'NO');
        
        // DECISION LOGIC
        // 1. Jika ada payment data lengkap ‚Üí PAID
        if (hasPaid && hasPaymentMethod) {
          inv.status = 'paid';
          paidCount++;
          console.log('  ‚úÖ Decision: PAID (has complete payment data)');
        }
        // 2. Jika ada di transactions ‚Üí PAID (sudah checkout)
        else if (inTransactions) {
          inv.status = 'paid';
          paidCount++;
          console.log('  ‚úÖ Decision: PAID (found in transactions = already checkout)');
        }
        // 3. Jika punya salah satu payment data ‚Üí PAID
        else if (hasPaid || hasPaymentMethod || hasChange) {
          inv.status = 'paid';
          paidCount++;
          console.log('  ‚úÖ Decision: PAID (has partial payment data)');
        }
        // 4. Tidak ada payment data DAN tidak di transactions ‚Üí PENDING
        else {
          inv.status = 'pending';
          pendingCount++;
          console.log('  üü° Decision: PENDING (no payment data, not in transactions)');
        }
        
        return true; // Keep valid invoice
      });
      
      // Save jika ada yang dimigrate atau dihapus
      if (migrated > 0 || deleted > 0) {
        localStorage.setItem('nuri_invoices', JSON.stringify(invoices));
        console.log('');
        console.log('=== Migration Summary ===');
        console.log('‚úì Total processed:', migrated);
        console.log('‚úì Migrated to PAID:', paidCount);
        console.log('‚úì Migrated to PENDING:', pendingCount);
        console.log('üóëÔ∏è Deleted (invalid invoices):', deleted);
        
        // DELETE invalid invoices from Firebase
        if (isFirebaseReady && deletedInvoiceNumbers.length > 0) {
          console.log('Deleting invalid invoices from Firebase...');
          deletedInvoiceNumbers.forEach(async (invNumber) => {
            await deleteInvoiceFromFirebase(invNumber);
          });
        }
        
        console.log('‚úì Invoice status migration completed');
        console.log('');
      } else {
        console.log('=== No Migration Needed ===');
        console.log('All invoices already have status field');
        console.log('');
      }
    }

    // ============================================
    // PAYMENT FIELD MIGRATION (transactions & invoices)
    // ============================================
    function migratePaymentField() {
      let changed = false;

      transactions = transactions.map(tx => {
        const paymentMethod = tx.paymentMethod || tx.payment || tx.method || 'cash';
        if (tx.paymentMethod !== paymentMethod) {
          changed = true;
          tx.paymentMethod = paymentMethod;
        }
        // keep legacy `method` for compatibility
        if (!tx.method) tx.method = paymentMethod;
        return tx;
      });

      invoices = invoices.map(inv => {
        const paymentMethod = inv.paymentMethod || inv.payment || inv.method || '';
        if (inv.paymentMethod !== paymentMethod) {
          changed = true;
          inv.paymentMethod = paymentMethod;
        }
        // keep legacy `payment` for compatibility
        if (!inv.payment) inv.payment = paymentMethod;
        return inv;
      });

      if (changed) {
        localStorage.setItem('nuri_transactions', JSON.stringify(transactions));
        localStorage.setItem('nuri_invoices', JSON.stringify(invoices));
        console.log('‚úì Payment field migration applied to local data');
      }
    }

    // ============================================
    // DEFAULT DATE FILTERS (30 DAYS)
    // ============================================
    function setDefaultDateFilters() {
      console.log('=== Setting Default Date Filters (30 days) ===');

      const today = new Date();
      const daysAgo = new Date();
      daysAgo.setDate(daysAgo.getDate() - 30);

      // Format: YYYY-MM-DD (required for input type="date")
      const formatDate = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      };

      const startDate = formatDate(daysAgo);
      const endDate = formatDate(today);

      console.log('Default start date:', startDate);
      console.log('Default end date:', endDate);

      // Set filter untuk tab Penjualan - RESTORE dari localStorage jika ada (SAMA SEPERTI INVOICE)
      const filterStartDate = document.getElementById('filterStartDate');
      const filterEndDate = document.getElementById('filterEndDate');

      if (filterStartDate && filterEndDate) {
        // Cek apakah ada saved filter
        const savedStart = localStorage.getItem('sales_filter_start');
        const savedEnd = localStorage.getItem('sales_filter_end');
        
        // PENTING: Hapus event listener dulu untuk avoid multiple trigger
        const oldOnChangeStart = filterStartDate.onchange;
        const oldOnChangeEnd = filterEndDate.onchange;
        filterStartDate.onchange = null;
        filterEndDate.onchange = null;
        
        if (savedStart && savedEnd) {
          // Restore dari localStorage
          filterStartDate.value = savedStart;
          filterEndDate.value = savedEnd;
          console.log('‚úì Sales filter RESTORED:', savedStart, 'to', savedEnd);
        } else {
          // Set default 30 days
          filterStartDate.value = startDate;
          filterEndDate.value = endDate;
          console.log('‚úì Sales filter set to default (30 days)');
        }
        
        // Restore event listener
        filterStartDate.onchange = oldOnChangeStart;
        filterEndDate.onchange = oldOnChangeEnd;
      }

      // Set filter untuk tab Invoice - HANYA jika BELUM ada nilai
      const filterStartDateInvoice = document.getElementById('filterStartDateInvoice');
      const filterEndDateInvoice = document.getElementById('filterEndDateInvoice');

      if (filterStartDateInvoice && filterEndDateInvoice) {
        // Cek apakah sudah ada nilai (dari localStorage atau user set)
        const savedStart = localStorage.getItem('invoice_filter_start');
        const savedEnd = localStorage.getItem('invoice_filter_end');
        
        // PENTING: Hapus event listener dulu untuk avoid multiple trigger
        const oldOnChangeStart = filterStartDateInvoice.onchange;
        const oldOnChangeEnd = filterEndDateInvoice.onchange;
        filterStartDateInvoice.onchange = null;
        filterEndDateInvoice.onchange = null;
        
        if (savedStart && savedEnd) {
          // Restore dari localStorage
          filterStartDateInvoice.value = savedStart;
          filterEndDateInvoice.value = savedEnd;
          console.log('‚úì Invoice filter RESTORED:', savedStart, 'to', savedEnd);
        } else if (!filterStartDateInvoice.value && !filterEndDateInvoice.value) {
          // Set default HANYA jika kosong
          filterStartDateInvoice.value = startDate;
          filterEndDateInvoice.value = endDate;
          console.log('‚úì Invoice filter set to default (30 days)');
        } else {
          console.log('‚úì Invoice filter already set, keeping current values');
        }
        
        // Restore event listener
        filterStartDateInvoice.onchange = oldOnChangeStart;
        filterEndDateInvoice.onchange = oldOnChangeEnd;
      }

      console.log('=== Default Date Filters Applied ===');
    }

    // setInvoiceLast30Days removed (using inline default-fill in showHistoryTab)

    function init() {
      // MIGRATION: Fix old invoices without status field
      migrateInvoiceStatus();
      // MIGRATION: Normalize payment fields
      migratePaymentField();
      
      // Load from Firebase if configured
      if (isFirebaseReady) {
        loadFromFirebase().then(() => {
          renderProducts();
          // JANGAN render transactions/invoices di sini!
          // Biarkan showHistoryTab() yang handle!
        }).catch(e => console.warn('Firebase load failed:', e));
      }
      
      // Init IndexedDB di background
      initHistoryDB().then(async () => {
        try {
          const txHistory = await HistoryDB.getAll('transactionHistory');
          if (txHistory.length > 0) {
            history = txHistory;
            historyIndex = history.length - 1;
          }
          
          const invHistory = await HistoryDB.getAll('invoiceHistory');
          if (invHistory.length > 0) {
            invoiceHistory = invHistory;
            invoiceHistoryIndex = invoiceHistory.length - 1;
          }
          
          updateUndoRedoButtons();
          updateUndoRedoButtonsInvoice();
        } catch (e) {
          console.warn('History load failed:', e);
        }
      }).catch(e => console.warn('IndexedDB init failed:', e));
      
      loadSettings();
      renderProducts();
      renderCart();
      // JANGAN panggil renderTransactions() di sini!
      // Biarkan showHistoryTab() yang handle dengan filter!
      updateUndoRedoButtons();
      
      // Restore payment method dan uang bayar jika ada
      const savedPaymentMethod = localStorage.getItem('nuri_payment_method');
      const savedAmountPaid = localStorage.getItem('nuri_amount_paid');
      
      if (savedPaymentMethod) {
        document.getElementById('paymentMethod').value = savedPaymentMethod;
        toggleCashUI();
      }
      
      if (savedAmountPaid) {
        document.getElementById('amountPaid').value = savedAmountPaid;
        calcChange();
      }
      
      // Restore state checkbox tampilkan tombol hapus
      const showDeleteBtn = localStorage.getItem('nuri_show_delete_btn') === 'true';
      const checkbox = document.getElementById('showDeleteBtn');
      if (checkbox) {
        checkbox.checked = showDeleteBtn;
        applyDeleteButtonVisibility();
      }
      
      // Restore state checkbox tampilkan tombol hapus invoice
      const showDeleteBtnInvoice = localStorage.getItem('nuri_show_delete_btn_invoice') === 'true';
      const checkboxInvoice = document.getElementById('showDeleteBtnInvoice');
      if (checkboxInvoice) {
        checkboxInvoice.checked = showDeleteBtnInvoice;
        applyDeleteButtonVisibilityInvoice();
      }
      
      // Restore state tab aktif dari localStorage
      const activeTab = localStorage.getItem('nuri_active_tab') || 'penjualan';
      const activeHistoryTab = localStorage.getItem('nuri_active_history_tab') || 'sales';
      
      // Set tab utama aktif
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
      document.getElementById(activeTab).classList.add('active');
      document.querySelector(`[onclick="showTab('${activeTab}')"]`)?.classList.add('active');
      
      // Set default filter tanggal untuk Riwayat DULU sebelum showHistoryTab
      setDefaultDateFilters();
      
      // Jika tab riwayat yang aktif, restore sub-tab juga (SETELAH filter di-set)
      if (activeTab === 'riwayat') {
        showHistoryTab(activeHistoryTab);
      } else {
        // Jika BUKAN di tab Riwayat, render tanpa filter (akan di-filter nanti saat buka tab)
        renderTransactions();
        renderInvoices();
      }
      
      // Jika tab dashboard yang aktif, refresh dashboard
      if (activeTab === 'dashboard') {
        setTimeout(() => refreshDashboard(), 100);
      }
      
      // Set default period button
      changePeriod('month');  // Default ke 'month' (1 bulan) bukan 'week'
      
      // Set default tanggal transaksi ke hari ini
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      const todayString = `${yyyy}-${mm}-${dd}`;
      const saleDateEl = document.getElementById('saleDate');
      if (saleDateEl) {
        saleDateEl.value = todayString;
      }
    }

    function showTab(name) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
      document.getElementById(name).classList.add('active');
      event.target.classList.add('active');
      
      // Simpan state tab aktif ke localStorage
      localStorage.setItem('nuri_active_tab', name);
      
      // Jika tab riwayat dibuka, aktifkan sub-tab Penjualan secara default
      if (name === 'riwayat') {
        showHistoryTab('sales');
      }
      // Jika tab dashboard dibuka, refresh analytics
      if (name === 'dashboard') {
        refreshDashboard();
      }
      // Perbarui visibilitas tombol Simpan Keranjang saat masuk ke tab penjualan
      if (name === 'penjualan') {
        updateSaveCartButtonVisibility();
        // Pastikan kolom tanggal transaksi menampilkan tanggal hari ini jika kosong
        const saleDateEl = document.getElementById('saleDate');
        if (saleDateEl && !saleDateEl.value) {
          const today = new Date();
          const yyyy = today.getFullYear();
          const mm = String(today.getMonth() + 1).padStart(2, '0');
          const dd = String(today.getDate()).padStart(2, '0');
          saleDateEl.value = `${yyyy}-${mm}-${dd}`;
        }
      }
    }

    function loadSettings() {
      document.getElementById('storeName').value = localStorage.getItem('nuri_store_name') || 'NURI SNACK';
      document.getElementById('storePhone').value = localStorage.getItem('nuri_store_phone') || '0812-3456-7890';
      
      const logoUrl = localStorage.getItem('nuri_logo');
      if (logoUrl) {
        document.getElementById('logoImg').src = logoUrl;
        document.getElementById('logoImg').style.display = 'block';
        document.getElementById('logoUrl').value = logoUrl;
      }
      
      // Load Firebase config
      loadFirebaseConfig();
    }

    document.getElementById('storeName').addEventListener('change', function() {
      localStorage.setItem('nuri_store_name', this.value);
    });

    document.getElementById('storePhone').addEventListener('change', function() {
      localStorage.setItem('nuri_store_phone', this.value);
    });

    function showNotification(message, callback) {
      const modal = document.getElementById('notificationModal');
      document.getElementById('notificationMessage').textContent = message;
      notificationCallback = callback;
      modal.classList.add('show');
      
      setTimeout(() => {
        const okBtn = modal.querySelector('.btn');
        if (okBtn) okBtn.focus();
      }, 100);
    }

    function closeNotification() {
      const modal = document.getElementById('notificationModal');
      modal.classList.remove('show');
      if (notificationCallback) {
        notificationCallback();
      }
      notificationCallback = null;
    }

    // ============================================
    // CUSTOM CONFIRM DIALOG
    // ============================================
    let confirmCallback = null;
    
    function showConfirmDialog(title, message, onConfirm) {
      const modal = document.getElementById('confirmDialog');
      document.getElementById('confirmTitle').textContent = title;
      document.getElementById('confirmMessage').textContent = message;
      confirmCallback = onConfirm;
      
      modal.classList.add('show');
      
      // Focus ke tombol batal by default
      setTimeout(() => {
        const cancelBtn = document.getElementById('confirmCancelBtn');
        if (cancelBtn) cancelBtn.focus();
      }, 100);
    }
    
    // Event listeners untuk confirm dialog
    document.addEventListener('DOMContentLoaded', () => {
      const cancelBtn = document.getElementById('confirmCancelBtn');
      const okBtn = document.getElementById('confirmOkBtn');
      const modal = document.getElementById('confirmDialog');
      
      if (cancelBtn) {
        cancelBtn.onclick = () => {
          modal.classList.remove('show');
          confirmCallback = null;
        };
      }
      
      if (okBtn) {
        okBtn.onclick = () => {
          modal.classList.remove('show');
          if (confirmCallback) {
            confirmCallback();
          }
          confirmCallback = null;
        };
      }
      
      // Close on background click
      if (modal) {
        modal.onclick = (e) => {
          if (e.target === modal) {
            modal.classList.remove('show');
            confirmCallback = null;
          }
        };
      }
    });

    // Pastikan inisialisasi utama dijalankan saat DOM siap
    document.addEventListener('DOMContentLoaded', init);

    // ============================================
    // TOGGLE SORT FUNCTIONS
    // ============================================
    function toggleSortSales() {
      console.log('=== toggleSortSales clicked ===');
      console.log('  Current salesSortOrder:', salesSortOrder);
      
      // Toggle between desc and asc
      salesSortOrder = salesSortOrder === 'desc' ? 'asc' : 'desc';
      window.salesSortOrder = salesSortOrder; // Update global
      
      console.log('  New salesSortOrder:', salesSortOrder);
      
      // Save to localStorage
      localStorage.setItem('sales_sort_order', salesSortOrder);
      
      // Update button appearance
      const btn = document.getElementById('sortBtnSales');
      if (btn) {
        if (salesSortOrder === 'desc') {
          btn.textContent = '‚áÖ'; // Terbaru di atas
          btn.title = 'Urutkan: Terbaru di atas';
          btn.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
          btn.style.color = 'white';
        } else {
          btn.textContent = '‚áÖ'; // Lama di atas
          btn.title = 'Urutkan: Lama di atas';
          btn.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
          btn.style.color = 'white';
        }
      }
      
      // Re-render
      const startDate = document.getElementById('filterStartDate').value;
      const endDate = document.getElementById('filterEndDate').value;
      
      console.log('  Re-rendering with filter:', startDate, 'to', endDate);
      
      if (startDate || endDate) {
        filterTransactions();
      } else {
        renderTransactions();
      }
      
      console.log('  Sort toggle completed');
    }

    function toggleSortInvoice() {
      console.log('=== toggleSortInvoice clicked ===');
      console.log('  Current invoiceSortOrder:', invoiceSortOrder);
      
      // Toggle between desc and asc
      invoiceSortOrder = invoiceSortOrder === 'desc' ? 'asc' : 'desc';
      window.invoiceSortOrder = invoiceSortOrder; // Update global
      
      console.log('  New invoiceSortOrder:', invoiceSortOrder);
      
      // Save to localStorage
      localStorage.setItem('invoice_sort_order', invoiceSortOrder);
      
      // Update button appearance
      const btn = document.getElementById('sortBtnInvoice');
      if (btn) {
        if (window.invoiceSortOrder === 'desc') {
          btn.textContent = '‚áÖ'; // Terbaru di atas
          btn.title = 'Urutkan: Terbaru di atas';
          btn.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
          btn.style.color = 'white';
        } else {
          btn.textContent = '‚áÖ'; // Lama di atas
          btn.title = 'Urutkan: Lama di atas';
          btn.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
          btn.style.color = 'white';
        }
      }
      
      // Re-render
      const startDate = document.getElementById('filterStartDateInvoice').value;
      const endDate = document.getElementById('filterEndDateInvoice').value;
      
      console.log('  Re-rendering with filter:', startDate, 'to', endDate);
      
      if (startDate || endDate) {
        filterInvoices();
      } else {
        renderInvoices();
      }
      
      console.log('  Sort toggle completed');
    }

    // Update button appearance on page load
    function updateSortButtonsAppearance() {
      const btnSales = document.getElementById('sortBtnSales');
      const btnInvoice = document.getElementById('sortBtnInvoice');
      
      if (btnSales) {
        if (salesSortOrder === 'desc') {
          btnSales.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
          btnSales.style.color = 'white';
          btnSales.title = 'Urutkan: Terbaru di atas';
        } else {
          btnSales.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
          btnSales.style.color = 'white';
          btnSales.title = 'Urutkan: Lama di atas';
        }
      }
      
      if (btnInvoice) {
        if (window.invoiceSortOrder === 'desc') {
          btnInvoice.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
          btnInvoice.style.color = 'white';
          btnInvoice.title = 'Urutkan: Terbaru di atas';
        } else {
          btnInvoice.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
          btnInvoice.style.color = 'white';
          btnInvoice.title = 'Urutkan: Lama di atas';
        }
      }
    }

    // Call updateSortButtonsAppearance after a short delay to ensure elements exist
    setTimeout(updateSortButtonsAppearance, 100);


    async function addProduct() {
      const name = document.getElementById('productName').value.trim();
      const price = parseFloat(document.getElementById('productPrice').value);

      if (!name || !price || price <= 0) {
        showNotification('Lengkapi data barang dengan benar');
        return;
      }

      // Upload image to Firebase Storage if available
      let finalImage = productImageData;
      if (productImageData && isFirebaseReady) {
        try {
          finalImage = await uploadImageToStorage(productImageData);
        } catch (e) {
          console.warn('Image upload failed, using base64:', e);
        }
      }

      const product = { 
        id: Date.now(), 
        name, 
        price,
        image: finalImage || null
      };

      products.push(product);
      saveData();
      document.getElementById('productName').value = '';
      document.getElementById('productPrice').value = '';
      document.getElementById('productImageFile').value = '';
      document.getElementById('productImageContainer').style.display = 'none';
      productImageData = null;
      renderProducts();
      showNotification('‚úÖ Barang berhasil ditambahkan');
    }

    function previewProductImage() {
      const file = document.getElementById('productImageFile').files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        productImageData = e.target.result;
        document.getElementById('productImagePreview').src = productImageData;
        document.getElementById('productImageContainer').style.display = 'inline-block';
      };
      reader.readAsDataURL(file);
    }

    function removeProductImage(e) {
      e.stopPropagation();
      if (confirm('Hapus gambar ini?')) {
        productImageData = null;
        document.getElementById('productImageFile').value = '';
        document.getElementById('productImageContainer').style.display = 'none';
        document.getElementById('productImagePreview').src = '';
      }
    }

    // ============================================
    // ADD PRODUCT MODAL FUNCTIONS
    // ============================================
    function openAddProductModal() {
      // Reset form sebelum buka
      document.getElementById('productName').value = '';
      document.getElementById('productPrice').value = '';
      document.getElementById('productImageFile').value = '';
      document.getElementById('productImageContainer').style.display = 'none';
      productImageData = null;
      document.getElementById('addProductModal').classList.add('show');
      // Auto focus ke input nama
      setTimeout(() => document.getElementById('productName').focus(), 100);
    }

    function closeAddProductModal() {
      document.getElementById('addProductModal').classList.remove('show');
    }

    async function addProductFromModal() {
      await addProduct();
      // addProduct() akan menampilkan notifikasi & reset form jika berhasil
      // Cek apakah form sudah di-reset (artinya berhasil ditambahkan)
      if (!document.getElementById('productName').value) {
        closeAddProductModal();
      }
    }

    // ============================================
    // SEARCH PRODUCT IN BARANG TAB
    // ============================================
    function searchProducts() {
      const query = (document.getElementById('productSearch')?.value || '').toLowerCase().trim();
      const rows = document.querySelectorAll('#productList tr');
      let visibleCount = 0;

      rows.forEach(row => {
        const name = row.cells[1]?.textContent.toLowerCase() || '';
        const match = !query || name.includes(query);
        row.style.display = match ? '' : 'none';
        if (match) visibleCount++;
      });

      const emptyMsg = document.getElementById('emptyProducts');
      const table = document.getElementById('productTable');
      if (visibleCount === 0 && products.length > 0) {
        emptyMsg.textContent = `Tidak ada barang dengan nama "${query}"`;
        emptyMsg.style.display = 'block';
        table.style.display = 'none';
      } else {
        emptyMsg.style.display = 'none';
        table.style.display = visibleCount > 0 ? '' : 'none';
      }
    }

    function editProduct(id) {
      const product = products.find(p => p.id == id);
      if (!product) return;

      currentEditProduct = product;
      document.getElementById('editProductName').value = product.name;
      document.getElementById('editProductPrice').value = product.price;
      
      if (product.image) {
        document.getElementById('editProductImagePreview').src = product.image;
        document.getElementById('editProductImageContainer').style.display = 'inline-block';
      } else {
        document.getElementById('editProductImageContainer').style.display = 'none';
      }

      editProductImageData = product.image;
      document.getElementById('editProductModal').classList.add('show');
    }

    function previewEditProductImage() {
      const file = document.getElementById('editProductImageFile').files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        editProductImageData = e.target.result;
        document.getElementById('editProductImagePreview').src = editProductImageData;
        document.getElementById('editProductImageContainer').style.display = 'inline-block';
      };
      reader.readAsDataURL(file);
    }

    function removeEditProductImage(e) {
      e.stopPropagation();
      if (confirm('Hapus gambar ini?')) {
        editProductImageData = null;
        document.getElementById('editProductImageFile').value = '';
        document.getElementById('editProductImageContainer').style.display = 'none';
        document.getElementById('editProductImagePreview').src = '';
      }
    }

    function saveEditProduct() {
      const name = document.getElementById('editProductName').value.trim();
      const price = parseFloat(document.getElementById('editProductPrice').value);

      if (!name || !price || price <= 0) {
        showNotification('Lengkapi data barang dengan benar');
        return;
      }

      const index = products.findIndex(p => p.id == currentEditProduct.id);
      if (index !== -1) {
        // Update product data
        products[index].name = name;
        products[index].price = price;
        
        // Update image HANYA jika ada image baru
        if (editProductImageData) {
          products[index].image = editProductImageData;
        }
        // Jika tidak ada image baru, keep image lama (jangan hapus)
        
        // Save to localStorage
        localStorage.setItem('nuri_products', JSON.stringify(products));
        
        // UPDATE to Firebase (specific product)
        if (isFirebaseReady) {
          updateProductInFirebase(products[index])
            .then(() => {
              console.log('‚úÖ Product updated in Firebase');
            })
            .catch(e => console.warn('Firebase update failed:', e));
        }
        
        // Render and close
        renderProducts();
        closeEditProduct();
        showNotification('‚úÖ Barang berhasil diperbarui di lokal dan Firebase');
      }
    }

    function deleteProductFromModal() {
      if (!currentEditProduct) return;
      
      showConfirmDialog(
        'Hapus Barang?',
        `Hapus barang "${currentEditProduct.name}"? Data akan dihapus dari lokal dan Firebase.`,
        async () => {
          const productId = currentEditProduct.id;
          const productName = currentEditProduct.name;
          
          // Hapus dari local
          products = products.filter(p => p.id !== productId);
          localStorage.setItem('nuri_products', JSON.stringify(products));
          
          // Hapus dari Firebase
          await deleteProductFromFirebase(productId);
          
          // Render dan close
          renderProducts();
          closeEditProduct();
          showNotification(`‚úÖ Barang "${productName}" berhasil dihapus dari lokal dan Firebase`);
        }
      );
    }

    function closeEditProduct() {
      document.getElementById('editProductModal').classList.remove('show');
      currentEditProduct = null;
      editProductImageData = null;
      document.getElementById('editProductImageFile').value = '';
    }

    function renderProducts() {
      const list = document.getElementById('productList');
      const grid = document.getElementById('productGrid');
      const empty = document.getElementById('emptyProducts');
      const emptyModal = document.getElementById('emptyProductsModal');

      list.innerHTML = '';
      grid.innerHTML = '';

      if (products.length === 0) {
        empty.style.display = 'block';
        if (emptyModal) emptyModal.style.display = 'block';
        return;
      }

      empty.style.display = 'none';
      if (emptyModal) emptyModal.style.display = 'none';

      products.forEach(p => {
        // Render untuk tabel di tab Barang - safe DOM manipulation
        const tr = document.createElement('tr');
        tr.onclick = () => editProduct(p.id);
        
        const tdImg = document.createElement('td');
        if (p.image) {
          const img = document.createElement('img');
          img.src = p.image;
          img.style.height = '40px';
          img.style.borderRadius = '3px';
          img.onerror = function() { this.style.display = 'none'; };
          tdImg.appendChild(img);
        } else {
          tdImg.textContent = '‚Äî';
        }
        
        const tdName = document.createElement('td');
        tdName.textContent = p.name;
        
        const tdPrice = document.createElement('td');
        tdPrice.textContent = 'Rp ' + p.price.toLocaleString('id-ID');
        
        tr.appendChild(tdImg);
        tr.appendChild(tdName);
        tr.appendChild(tdPrice);
        list.appendChild(tr);

        // Render untuk grid di modal - safe DOM manipulation
        const card = document.createElement('div');
        card.className = 'product-card';
        card.onclick = () => selectProduct(p.id);
        card.setAttribute('data-product-id', p.id);
        
        if (p.image) {
          const img = document.createElement('img');
          img.src = p.image;
          img.className = 'product-card-img';
          img.alt = p.name;
          img.onerror = function() { 
            this.parentElement.innerHTML = '<div class="product-card-img" style="display: flex; align-items: center; justify-content: center; font-size: 2em;">üì¶</div>';
          };
          card.appendChild(img);
        } else {
          const placeholder = document.createElement('div');
          placeholder.className = 'product-card-img';
          placeholder.style.display = 'flex';
          placeholder.style.alignItems = 'center';
          placeholder.style.justifyContent = 'center';
          placeholder.style.fontSize = '2em';
          placeholder.textContent = 'üì¶';
          card.appendChild(placeholder);
        }
        
        const nameDiv = document.createElement('div');
        nameDiv.className = 'product-card-name';
        nameDiv.textContent = p.name;
        card.appendChild(nameDiv);
        
        const priceDiv = document.createElement('div');
        priceDiv.className = 'product-card-price';
        priceDiv.textContent = 'Rp ' + p.price.toLocaleString('id-ID');
        card.appendChild(priceDiv);
        
        grid.appendChild(card);
      });

      // Reapply search filter jika ada query aktif
      if (document.getElementById('productSearch')?.value) {
        searchProducts();
      }
    }

    function openProductModal() {
      if (products.length === 0) {
        showNotification('Belum ada barang. Tambah barang terlebih dahulu di tab Barang.');
        return;
      }
      renderProducts();
      selectedProductId = null;
      document.getElementById('selectedProductInfo').style.display = 'none';
      document.getElementById('addToCartBtn').style.display = 'none';
      document.getElementById('itemNote').value = '';
      document.getElementById('modalQty').value = '1';
      document.getElementById('selectProductModal').classList.add('show');
    }

    function closeProductModal() {
      document.getElementById('selectProductModal').classList.remove('show');
      // Don't reset selectedProductId here - it will be set by selectProduct or openProductModal
      document.querySelectorAll('.product-card').forEach(card => {
        card.classList.remove('selected');
      });
    }

    function changeModalQty(change) {
      const input = document.getElementById('modalQty');
      const currentQty = parseInt(input.value) || 1;
      const newQty = Math.max(1, currentQty + change);
      input.value = newQty;
    }

    function validateModalQty() {
      const input = document.getElementById('modalQty');
      const qty = parseInt(input.value);
      if (isNaN(qty) || qty < 1) {
        input.value = 1;
      }
    }

    function selectProduct(productId) {
      console.log('selectProduct called with ID:', productId, 'Type:', typeof productId);
      console.log('Total products:', products.length);
      
      // Tutup modal pilih barang dulu
      closeProductModal();
      
      // JANGAN convert type - biarkan sesuai aslinya
      // Gunakan loose comparison (==) di semua tempat untuk handle string vs number
      selectedProductId = productId;
      console.log('selectedProductId set to:', selectedProductId, 'Type:', typeof selectedProductId);
      
      // Gunakan == untuk loose comparison (handle string vs number)
      const product = products.find(p => {
        const match = p.id == productId;
        console.log('Checking product:', p.name, 'ID:', p.id, 'Type:', typeof p.id, 'Match:', match);
        return match;
      });
      
      if (!product) {
        console.error('‚ùå Product not found!');
        console.error('Looking for ID:', productId, 'Type:', typeof productId);
        console.error('Available products:', products.map(p => ({ id: p.id, type: typeof p.id, name: p.name })));
        showNotification('‚ùå Produk tidak ditemukan. ID: ' + productId);
        return;
      }
      
      console.log('‚úì Product found:', product.name, 'ID:', selectedProductId);
      
      // Set data ke modal detail
      const imgEl = document.getElementById('detailProdImg');
      if (!imgEl) {
        console.error('‚ùå detailProdImg element not found!');
        return;
      }
      
      if (product.image) {
        imgEl.src = product.image;
      } else {
        imgEl.src = 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\'%3E%3Crect fill=\'%23e5e7eb\' width=\'100\' height=\'100\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' font-size=\'40\' fill=\'%23999\'%3Eüì¶%3C/text%3E%3C/svg%3E';
      }
      
      const nameEl = document.getElementById('detailProdName');
      const priceEl = document.getElementById('detailProdPrice');
      const noteEl = document.getElementById('detailNote');
      const qtyEl = document.getElementById('detailQtyInput');
      
      if (!nameEl || !priceEl || !noteEl || !qtyEl) {
        console.error('‚ùå Modal detail elements not found!');
        console.error('nameEl:', !!nameEl, 'priceEl:', !!priceEl, 'noteEl:', !!noteEl, 'qtyEl:', !!qtyEl);
        return;
      }
      
      nameEl.textContent = product.name;
      priceEl.textContent = 'Rp ' + product.price.toLocaleString('id-ID');
      noteEl.value = '';
      qtyEl.value = '1';
      
      // Buka modal detail
      const modal = document.getElementById('productDetailModal');
      if (!modal) {
        console.error('‚ùå productDetailModal not found!');
        return;
      }
      
      console.log('‚úì Opening modal detail...');
      modal.classList.add('show');
      console.log('‚úì Modal classes:', modal.className);
    }

    function closeDetailModal() {
      document.getElementById('productDetailModal').classList.remove('show');
      // Buka kembali modal pilih barang
      document.getElementById('selectProductModal').classList.add('show');
    }

    function changeDetailQty(delta) {
      const input = document.getElementById('detailQtyInput');
      const current = parseInt(input.value) || 1;
      const newVal = Math.max(1, current + delta);
      input.value = newVal;
    }

    function confirmAddToCart() {
      try {
        console.log('confirmAddToCart called. selectedProductId:', selectedProductId, 'Type:', typeof selectedProductId);
        
        if (!selectedProductId) {
          console.error('selectedProductId is null or undefined!');
          showNotification('‚ùå Silakan pilih produk terlebih dahulu');
          return;
        }

        // Gunakan == untuk loose comparison (handle string vs number)
        const product = products.find(p => p.id == selectedProductId);
        
        if (!product) {
          console.error('Product not found in confirmAddToCart. Selected ID:', selectedProductId, 'Type:', typeof selectedProductId);
          console.error('Available products:', products.map(p => ({ id: p.id, type: typeof p.id, name: p.name })));
          showNotification('‚ùå Produk tidak ditemukan. Coba refresh halaman.');
          return;
        }
        
        console.log('Product found:', product.name);

        const note = document.getElementById('detailNote').value.trim();
        const qty = parseInt(document.getElementById('detailQtyInput').value) || 1;

        // Cek apakah sudah ada di cart dengan ID dan catatan yang SAMA
        const existing = cart.find(c => c.id == selectedProductId && c.note === note);

        if (existing) {
          existing.qty += qty;
          console.log('Updated existing cart item. New qty:', existing.qty);
        } else {
          cart.push({
            id: selectedProductId,
            name: product.name,
            price: product.price,
            qty: qty,
            note: note,
            image: product.image || ''
          });
          console.log('Added new item to cart. Cart length:', cart.length);
        }

        localStorage.setItem('nuri_cart', JSON.stringify(cart));
        console.log('Cart saved to localStorage');
        
        // Close modal FIRST before showing notification
        document.getElementById('productDetailModal').classList.remove('show');
        console.log('Modal closed');
        
        selectedProductId = null;
        
        // Render cart after modal is closed
        renderCart();
        console.log('Cart rendered');
        
        // Show notification LAST
        showNotification(`‚úÖ ${qty}x ${product.name} ditambahkan ke keranjang`);
        console.log('Notification shown. confirmAddToCart completed successfully.');
        
      } catch (error) {
        console.error('ERROR in confirmAddToCart:', error);
        console.error('Error stack:', error.stack);
        alert('ERROR: ' + error.message + '\n\nCek console (F12) untuk detail.');
      }
    }

    function addToCartFromModal() {
      if (!selectedProductId) { 
        showNotification('Pilih barang terlebih dahulu');
        return; 
      }

      const note = document.getElementById('itemNote').value.trim();
      const qty = parseInt(document.getElementById('modalQty').value) || 1;
      const product = products.find(p => p.id == selectedProductId);
      
      if (!product) return;

      const existing = cart.find(c => c.id == selectedProductId && c.note === note);

      if (existing) {
        existing.qty += qty;
      } else {
        cart.push({ 
          id: selectedProductId, 
          name: product.name, 
          price: product.price, 
          qty: qty,
          note: note,
          image: product.image
        });
      }

      // Simpan cart ke localStorage
      localStorage.setItem('nuri_cart', JSON.stringify(cart));

      renderCart();
      closeProductModal();
      showNotification(`‚úÖ ${qty}x ${product.name} berhasil ditambahkan ke keranjang`);
    }

    async function saveState(action) {
      // History disabled untuk menghemat storage
      // Uncomment jika ingin aktifkan kembali dengan risiko quota exceeded
      return;
    }

    function undo() {
      if (historyIndex <= 0) return;
      
      historyIndex--;
      transactions = JSON.parse(JSON.stringify(history[historyIndex].transactions));
      localStorage.setItem('nuri_transactions', JSON.stringify(transactions));
      renderTransactions();
      updateUndoRedoButtons();
      
      const action = history[historyIndex + 1].action;
      showNotification(`‚Ü∂ Undo: ${action}`);
    }

    function redo() {
      if (historyIndex >= history.length - 1) return;
      
      historyIndex++;
      transactions = JSON.parse(JSON.stringify(history[historyIndex].transactions));
      localStorage.setItem('nuri_transactions', JSON.stringify(transactions));
      renderTransactions();
      updateUndoRedoButtons();
      
      const action = history[historyIndex].action;
      showNotification(`‚Ü∑ Redo: ${action}`);
    }

    function updateUndoRedoButtons() {
      const undoBtn = document.getElementById('undoBtn');
      const redoBtn = document.getElementById('redoBtn');
      
      if (undoBtn) {
        undoBtn.disabled = historyIndex <= 0;
      }
      
      if (redoBtn) {
        redoBtn.disabled = historyIndex >= history.length - 1;
      }
    }

    // Fungsi untuk menyimpan state invoice untuk undo/redo
    async function saveInvoiceState(action) {
      // History disabled untuk menghemat storage
      // Uncomment jika ingin aktifkan kembali dengan risiko quota exceeded
      return;
    }

    function undoInvoice() {
      if (invoiceHistoryIndex <= 0) return;
      
      invoiceHistoryIndex--;
      invoices = JSON.parse(JSON.stringify(invoiceHistory[invoiceHistoryIndex].invoices));
      localStorage.setItem('nuri_invoices', JSON.stringify(invoices));
      renderInvoices();
      updateUndoRedoButtonsInvoice();
      
      const action = invoiceHistory[invoiceHistoryIndex].action;
      showNotification(`‚Ü∂ Undo: ${action}`);
    }

    function redoInvoice() {
      if (invoiceHistoryIndex >= invoiceHistory.length - 1) return;
      
      invoiceHistoryIndex++;
      invoices = JSON.parse(JSON.stringify(invoiceHistory[invoiceHistoryIndex].invoices));
      localStorage.setItem('nuri_invoices', JSON.stringify(invoices));
      renderInvoices();
      updateUndoRedoButtonsInvoice();
      
      const action = invoiceHistory[invoiceHistoryIndex].action;
      showNotification(`‚Ü∑ Redo: ${action}`);
    }

    function updateUndoRedoButtonsInvoice() {
      const undoBtn = document.getElementById('undoBtnInvoice');
      const redoBtn = document.getElementById('redoBtnInvoice');
      
      if (undoBtn) {
        undoBtn.disabled = invoiceHistoryIndex <= 0;
      }
      
      if (redoBtn) {
        redoBtn.disabled = invoiceHistoryIndex >= invoiceHistory.length - 1;
      }
    }

    function removeFromCart(index) {
      const item = cart[index];
      if (!item) return;
      
      const itemName = item.name + (item.note ? ' (' + item.note + ')' : '');
      
      // Gunakan custom confirmation dialog
      showConfirmDialog(
        'Hapus dari Keranjang?',
        `Apakah Anda yakin ingin menghapus "${itemName}"?`,
        () => {
          // Confirmed - hapus item
          cart.splice(index, 1);
          localStorage.setItem('nuri_cart', JSON.stringify(cart));
          renderCart();
          showNotification(`‚úÖ ${itemName} dihapus dari keranjang`);
        }
      );
    }

    function changeQty(index, change) {
      if (cart[index]) {
        cart[index].qty = Math.max(1, cart[index].qty + change);
        localStorage.setItem('nuri_cart', JSON.stringify(cart));
        renderCart();
      }
    }

    function renderCart() {
      const list = document.getElementById('cartList');
      if (cart.length === 0) {
        list.innerHTML = '<div class="empty-msg">Keranjang kosong</div>';
        const cartTotalEl = document.getElementById('cartTotal'); if (cartTotalEl) cartTotalEl.textContent = 'Rp 0';
        const itemTypeCountEl = document.getElementById('itemTypeCount'); if (itemTypeCountEl) itemTypeCountEl.textContent = '0';
        const totalQtyCountEl = document.getElementById('totalQtyCount'); if (totalQtyCountEl) totalQtyCountEl.textContent = '0';
        return;
      }

      // Build DOM nodes to avoid template injection issues
      list.innerHTML = '';
      let total = 0;
      let totalQty = 0;

      cart.forEach((item, index) => {
        const subtotal = item.price * item.qty;
        total += subtotal;
        totalQty += item.qty;

        const row = document.createElement('div');
        row.className = 'item-row';

        if (item.image) {
          const img = document.createElement('img');
          img.src = item.image;
          img.style.height = '50px';
          img.style.borderRadius = '3px';
          img.style.marginRight = '10px';
          row.appendChild(img);
        }

        const info = document.createElement('div');
        info.className = 'item-info';

        const nameDiv = document.createElement('div');
        nameDiv.className = 'item-name';
        nameDiv.textContent = item.name;
        info.appendChild(nameDiv);

        const priceDiv = document.createElement('div');
        priceDiv.className = 'item-price';
        priceDiv.textContent = 'Rp ' + item.price.toLocaleString('id-ID');
        info.appendChild(priceDiv);

        if (item.note) {
          const noteDiv = document.createElement('div');
          noteDiv.style.fontSize = '0.85em';
          noteDiv.style.color = '#666';
          noteDiv.style.marginTop = '5px';
          noteDiv.textContent = 'üìù ' + item.note;
          info.appendChild(noteDiv);
        }

        row.appendChild(info);

        const qtyControl = document.createElement('div');
        qtyControl.className = 'qty-control';

        const btnMinus = document.createElement('button');
        btnMinus.className = 'btn qty-btn';
        btnMinus.textContent = '‚àí';
        btnMinus.addEventListener('click', () => changeQty(index, -1));
        qtyControl.appendChild(btnMinus);

        const qtyDisplay = document.createElement('span');
        qtyDisplay.className = 'qty-display';
        qtyDisplay.textContent = item.qty;
        qtyControl.appendChild(qtyDisplay);

        const btnPlus = document.createElement('button');
        btnPlus.className = 'btn qty-btn';
        btnPlus.textContent = '+';
        btnPlus.addEventListener('click', () => changeQty(index, 1));
        qtyControl.appendChild(btnPlus);

        const btnRemove = document.createElement('button');
        btnRemove.className = 'btn btn-danger qty-btn';
        btnRemove.textContent = '‚úï';
        btnRemove.addEventListener('click', () => removeFromCart(index));
        qtyControl.appendChild(btnRemove);

        row.appendChild(qtyControl);

        const subtotalDiv = document.createElement('div');
        subtotalDiv.className = 'item-subtotal';
        subtotalDiv.style.marginLeft = '12px';
        subtotalDiv.style.fontWeight = 'bold';
        subtotalDiv.style.whiteSpace = 'nowrap';
        subtotalDiv.textContent = 'Rp ' + subtotal.toLocaleString('id-ID');
        row.appendChild(subtotalDiv);

        list.appendChild(row);
      });

      const itemTypeCountEl = document.getElementById('itemTypeCount'); if (itemTypeCountEl) itemTypeCountEl.textContent = cart.length;
      const totalQtyCountEl = document.getElementById('totalQtyCount'); if (totalQtyCountEl) totalQtyCountEl.textContent = totalQty;
      const cartTotalEl = document.getElementById('cartTotal'); if (cartTotalEl) cartTotalEl.textContent = 'Rp ' + total.toLocaleString('id-ID');
    }

    function toggleCashUI() {
      const method = document.getElementById('paymentMethod').value;
      document.getElementById('cashUI').style.display = method === 'cash' ? 'block' : 'none';
      // Simpan payment method
      localStorage.setItem('nuri_payment_method', method);
    }

    function updateSaveCartButtonVisibility() {
      const saveBtn = document.getElementById('saveCartBtn');
      if (!saveBtn) return;
      const payingIndex = localStorage.getItem('nuri_paying_invoice_index');
      // Jika sedang memproses pembayaran invoice, sembunyikan tombol Simpan Keranjang
      if (payingIndex !== null && payingIndex !== undefined) {
        saveBtn.style.display = 'none';
      } else {
        saveBtn.style.display = '';
      }
    }

    function updateCopySaleButtonVisibility(hide = false) {
      const copyBtn = document.getElementById('copySaleBtn');
      if (!copyBtn) return;
      // Sembunyikan tombol jika hide = true atau jika sedang pembayaran invoice
      const payingIndex = localStorage.getItem('nuri_paying_invoice_index');
      const isProcessing = hide || (payingIndex !== null && payingIndex !== undefined);
      copyBtn.style.display = isProcessing ? 'none' : '';
    }

    function calcChange() {
      const total = cart.reduce((sum, item) => sum + item.price * item.qty, 0);
      const paid = parseFloat(document.getElementById('amountPaid').value) || 0;
      const change = paid - total;

      if (paid > 0) {
        document.getElementById('changeUI').style.display = 'block';
        document.getElementById('changeAmt').textContent = 'Rp ' + Math.max(0, change).toLocaleString('id-ID');
      } else {
        document.getElementById('changeUI').style.display = 'none';
      }
      
      // Simpan amount paid
      localStorage.setItem('nuri_amount_paid', paid);
    }

    function checkout() {
      try {
        if (cart.length === 0) { alert('Keranjang kosong'); return; }

        // Auto cleanup: Hapus transaksi dan invoice lama jika terlalu banyak
        if (transactions.length > 100) {
          transactions = transactions.slice(-100); // Keep only last 100
          localStorage.setItem('nuri_transactions', JSON.stringify(transactions));
        }
        if (invoices.length > 100) {
          invoices = invoices.slice(-100); // Keep only last 100
          localStorage.setItem('nuri_invoices', JSON.stringify(invoices));
        }

        const total = cart.reduce((sum, item) => sum + item.price * item.qty, 0);
        const method = document.getElementById('paymentMethod').value;

        if (method === 'cash') {
          const paid = parseFloat(document.getElementById('amountPaid').value);
          if (!paid || paid < total) { alert('Uang kurang'); return; }
        }

        const paid = method === 'cash' ? parseFloat(document.getElementById('amountPaid').value) : total;
        const change = Math.max(0, paid - total);
        
        // Gunakan tanggal yang dipilih user atau default hari ini
        const saleDateInput = document.getElementById('saleDate');
        let transactionDate;
        if (saleDateInput && saleDateInput.value) {
          // Format dari input date: YYYY-MM-DD
          const dateObj = new Date(saleDateInput.value + 'T' + new Date().toTimeString().split(' ')[0]);
          transactionDate = dateObj.toLocaleString('id-ID');
        } else {
          // Default ke waktu sekarang
          transactionDate = new Date().toLocaleString('id-ID');
        }
        
        // Cek apakah ini pembayaran dari invoice PENDING
        const payingInvoiceIndex = localStorage.getItem('nuri_paying_invoice_index');
        const payingInvoiceNumber = localStorage.getItem('nuri_paying_invoice_number');
        
        let invoiceNumber;
        
        if (payingInvoiceIndex !== null && payingInvoiceNumber) {
          // Ini pembayaran dari invoice PENDING
          invoiceNumber = payingInvoiceNumber;
          const invIndex = parseInt(payingInvoiceIndex);
          
          // Update invoice menjadi LUNAS
            if (invoices[invIndex] && invoices[invIndex].invoiceNumber === invoiceNumber) {
            invoices[invIndex].status = 'paid';
            invoices[invIndex].paymentMethod = method;
            invoices[invIndex].paid = paid;
            invoices[invIndex].change = change;
            invoices[invIndex].paidDate = transactionDate;
            localStorage.setItem('nuri_invoices', JSON.stringify(invoices));
            saveInvoiceState('Bayar invoice');
          }
          
          // Hapus flag pembayaran invoice
          localStorage.removeItem('nuri_paying_invoice_index');
          localStorage.removeItem('nuri_paying_invoice_number');
          // Perbarui visibilitas tombol Simpan Keranjang setelah pembayaran selesai
          updateSaveCartButtonVisibility();
        } else {
          // Checkout biasa, generate nomor invoice baru
          invoiceNumber = generateInvoiceNumber();
          
          // Buat invoice baru dengan status LUNAS
          const invoice = {
            invoiceNumber: invoiceNumber,
            date: transactionDate,
            items: [...cart],
            total: total,
            status: 'paid',
            paymentMethod: method,
            paid: paid,
            change: change
          };

          invoices.push(invoice);
          localStorage.setItem('nuri_invoices', JSON.stringify(invoices));
          saveInvoiceState('Tambah invoice');
        }

        // Buat objek transaksi dengan nomor invoice (simpan `paymentMethod` konsisten)
        currentPrint = {
          invoiceNumber: invoiceNumber,
          date: transactionDate,
          items: [...cart],
          total,
          method, // legacy
          paymentMethod: method,
          paid,
          change
        };
        
        // Reset currentInvoice agar tidak tercampur
        currentInvoice = null;

        // Simpan transaksi
        transactions.push(currentPrint);
        localStorage.setItem('nuri_transactions', JSON.stringify(transactions));
        
        // Sync ke Firebase
        if (isFirebaseReady) {
          syncToFirebase().catch(e => console.warn('Firebase sync failed:', e));
        }
        
        // Simpan state untuk undo (hanya untuk transaksi)
        saveState('Tambah transaksi');
        
        // Sembunyikan tombol Salin sebagai Penjualan Baru saat checkout
        updateCopySaleButtonVisibility(true);

        // Kosongkan cart dan hapus dari localStorage
        cart = [];
        localStorage.removeItem('nuri_cart');
        localStorage.removeItem('nuri_payment_method');
        localStorage.removeItem('nuri_amount_paid');
        
        document.getElementById('amountPaid').value = '';
        document.getElementById('itemNote').value = '';
        document.getElementById('paymentMethod').value = 'cash';
        document.getElementById('changeUI').style.display = 'none'; // Hide kembalian
        toggleCashUI();
        
        renderCart();
        renderTransactions();
        renderInvoices();
        showPrint();
      } catch (error) {
        console.error('Error di checkout:', error);
        
        // Jika error quota, data tetap tersimpan di memory
        if (error.message.includes('quota')) {
          // Data transaksi dan invoice tetap ada di memory, hanya gagal save ke localStorage
          console.warn('LocalStorage quota exceeded, data only in memory');
          showNotification('‚úÖ Checkout berhasil! (Data di memory, lakukan backup berkala)');
        } else {
          alert('Terjadi error: ' + error.message);
        }
      }
    }

    function renderTransactions() {
      const list = document.getElementById('transactionList');
      const empty = document.getElementById('emptyTransactions');

      if (transactions.length === 0) {
        list.innerHTML = '';
        empty.style.display = 'block';
        return;
      }

      empty.style.display = 'none';

      // SORT by date berdasarkan salesSortOrder
      const sortedTransactions = [...transactions].sort((a, b) => {
        // Parse date: handle id-ID locale "DD/M/YYYY, HH.mm.ss" atau "DD/M/YYYY HH.mm.ss"
        const parseDate = (dateStr) => {
          const sep = dateStr.includes(',') ? ',' : ' ';
          const [datePart, timePart] = dateStr.split(sep).map(s => s.trim());
          const parts = datePart.split('/');
          const timeParts = timePart ? timePart.split(/[.:]/) : ['0', '0', '0'];
          return new Date(
            parseInt(parts[2]), // year
            parseInt(parts[1]) - 1, // month (0-indexed)
            parseInt(parts[0]), // day
            parseInt(timeParts[0]) || 0, // hour
            parseInt(timeParts[1]) || 0, // minute
            parseInt(timeParts[2]) || 0  // second
          );
        };
        
        const dateA = parseDate(a.date);
        const dateB = parseDate(b.date);
        
        // Sort berdasarkan salesSortOrder
        if (window.salesSortOrder === 'desc') {
          return dateB - dateA; // Descending: terbaru di atas
        } else {
          return dateA - dateB; // Ascending: lama di atas
        }
      });

      list.innerHTML = sortedTransactions.map((t) => {
        // Find original index untuk onclick
        const originalIndex = transactions.indexOf(t);
        let items = t.items.map(it => `${it.qty}x ${it.name}${it.note ? ' (üìù ' + it.note + ')' : ''}`).join('<br>');
        return `
          <div class="card transaction-card" onclick="openTransactionPrint(${originalIndex})" style="position: relative; cursor: pointer;">
            <button class="delete-transaction-btn hidden" onclick="event.stopPropagation(); deleteTransaction(${originalIndex})" title="Hapus transaksi">‚úï</button>
            <div style="margin-bottom: 10px; font-size: 0.9em; color: #666;">
              ${t.date} | ${t.paymentMethod || t.method}
            </div>
            ${t.invoiceNumber ? '<div style="margin-bottom: 5px;"><strong style="color: #2cb910; font-size: 0.95em;">' + t.invoiceNumber + '</strong></div>' : ''}
            <div style="margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 10px;">
              ${items}
            </div>
            <div>
              <strong>Total: Rp ${t.total.toLocaleString('id-ID')}</strong>
              ${t.change > 0 ? '<br>Kembalian: Rp ' + t.change.toLocaleString('id-ID') : ''}
            </div>
          </div>
        `;
      }).join('');
      
      // Terapkan state checkbox setelah render
      applyDeleteButtonVisibility();
    }

    function deleteTransaction(index) {
      if (index < 0 || index >= transactions.length) return;
      
      const transaction = transactions[index];
      const confirmMsg = `Hapus transaksi ini?\n\nTotal: Rp ${transaction.total.toLocaleString('id-ID')}\nTanggal: ${transaction.date}\n\nData akan dihapus dari lokal dan Firebase.`;
      
      showConfirmDialog(
        'Hapus Transaksi?',
        confirmMsg,
        async () => {
          const invoiceNumber = transaction.invoiceNumber;
          
          // Hapus dari local
          transactions.splice(index, 1);
          localStorage.setItem('nuri_transactions', JSON.stringify(transactions));
          
          // Hapus dari Firebase dengan fallback
          if (invoiceNumber) {
            try {
              await deleteTransactionFromFirebase(invoiceNumber, transaction);
            } catch (error) {
              console.error('Error deleting from Firebase:', error);
            }
          } else {
            console.warn('No invoiceNumber, trying to delete by date+total');
            try {
              await deleteTransactionFromFirebase(null, transaction);
            } catch (error) {
              console.error('Error deleting from Firebase:', error);
            }
          }
          
          // Simpan state untuk undo
          saveState('Hapus transaksi');
          
          // Render
          renderTransactions();
          showNotification('‚úÖ Transaksi berhasil dihapus dari lokal dan Firebase');
        }
      );
    }

    function filterTransactions() {
      const startDate = document.getElementById('filterStartDate').value;
      const endDate = document.getElementById('filterEndDate').value;
      const list = document.getElementById('transactionList');
      const empty = document.getElementById('emptyTransactions');

      console.log('=== filterTransactions() called ===');
      console.log('  startDate:', startDate || 'EMPTY');
      console.log('  endDate:', endDate || 'EMPTY');

      // Save filter state to localStorage (SAMA SEPERTI INVOICE)
      if (startDate) {
        localStorage.setItem('sales_filter_start', startDate);
        console.log('  ‚úì Saved start to localStorage');
      } else {
        localStorage.removeItem('sales_filter_start');
        console.log('  ‚úó Removed start from localStorage');
      }
      
      if (endDate) {
        localStorage.setItem('sales_filter_end', endDate);
        console.log('  ‚úì Saved end to localStorage');
      } else {
        localStorage.removeItem('sales_filter_end');
        console.log('  ‚úó Removed end from localStorage');
      }

      if (!startDate && !endDate) {
        console.log('  ‚Üí No filter (both empty), calling renderTransactions() - SHOW ALL');
        console.log('    startDate value:', document.getElementById('filterStartDate').value);
        console.log('    endDate value:', document.getElementById('filterEndDate').value);
        renderTransactions();
        return;
      }

      console.log('  ‚Üí Filtering transactions...');
      console.log('    Filter with: start=' + startDate + ', end=' + endDate);

      // Filter transaksi berdasarkan tanggal
      const filteredTransactions = transactions.filter(t => {
        // Parse tanggal dari format string transaksi (format: DD/MM/YYYY, HH:mm:ss)
        const dateParts = t.date.split(',')[0].trim().split('/');
        const day = parseInt(dateParts[0]);
        const month = parseInt(dateParts[1]) - 1; // Bulan di JavaScript dimulai dari 0
        const year = parseInt(dateParts[2]);
        const transactionDate = new Date(year, month, day);
        transactionDate.setHours(0, 0, 0, 0); // Set ke awal hari

        let matchStart = true;
        let matchEnd = true;

        if (startDate) {
          const start = new Date(startDate);
          start.setHours(0, 0, 0, 0);
          matchStart = transactionDate >= start;
        }

        if (endDate) {
          const end = new Date(endDate);
          end.setHours(23, 59, 59, 999); // Set ke akhir hari
          matchEnd = transactionDate <= end;
        }

        return matchStart && matchEnd;
      });

      // Render hasil filter
      if (filteredTransactions.length === 0) {
        list.innerHTML = '';
        empty.style.display = 'block';
        empty.textContent = 'Tidak ada transaksi pada periode yang dipilih';
        // Reset statistik ketika filter kosong (cek elemen ada)
        const elItemTypes = document.getElementById('statItemTypes');
        if (elItemTypes) elItemTypes.textContent = '0';
        const elTotalQty = document.getElementById('statTotalQty');
        if (elTotalQty) elTotalQty.textContent = '0';
        const elTotalAmount = document.getElementById('statTotalAmount');
        if (elTotalAmount) elTotalAmount.textContent = 'Rp 0';
        return;
      }

      empty.style.display = 'none';

      // SORT filtered transactions berdasarkan salesSortOrder
      const sortedFiltered = [...filteredTransactions].sort((a, b) => {
        // Parse date: handle id-ID locale "DD/M/YYYY, HH.mm.ss" atau "DD/M/YYYY HH.mm.ss"
        const parseDate = (dateStr) => {
          const sep = dateStr.includes(',') ? ',' : ' ';
          const [datePart, timePart] = dateStr.split(sep).map(s => s.trim());
          const parts = datePart.split('/');
          const timeParts = timePart ? timePart.split(/[.:]/) : ['0', '0', '0'];
          return new Date(
            parseInt(parts[2]),
            parseInt(parts[1]) - 1,
            parseInt(parts[0]),
            parseInt(timeParts[0]) || 0,
            parseInt(timeParts[1]) || 0,
            parseInt(timeParts[2]) || 0
          );
        };
        
        const dateA = parseDate(a.date);
        const dateB = parseDate(b.date);
        
        if (window.salesSortOrder === 'desc') {
          return dateB - dateA; // Descending: terbaru di atas
        } else {
          return dateA - dateB; // Ascending: lama di atas
        }
      });

      list.innerHTML = sortedFiltered.map((t) => {
        // Cari index asli dari transaksi ini
        const originalIndex = transactions.indexOf(t);
        let items = t.items.map(it => `${it.qty}x ${it.name}${it.note ? ' (üìù ' + it.note + ')' : ''}`).join('<br>');
        return `
          <div class="card transaction-card" onclick="openTransactionPrint(${originalIndex})" style="position: relative; cursor: pointer;">
            <button class="delete-transaction-btn hidden" onclick="event.stopPropagation(); deleteTransaction(${originalIndex})" title="Hapus transaksi">‚úï</button>
            <div style="margin-bottom: 10px; font-size: 0.9em; color: #666;">
              ${t.date} | ${t.method}
            </div>
            ${t.invoiceNumber ? '<div style="margin-bottom: 5px;"><strong style="color: #2cb910; font-size: 0.95em;">' + t.invoiceNumber + '</strong></div>' : ''}
            <div style="margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 10px;">
              ${items}
            </div>
            <div>
              <strong>Total: Rp ${t.total.toLocaleString('id-ID')}</strong>
              ${t.change > 0 ? '<br>Kembalian: Rp ' + t.change.toLocaleString('id-ID') : ''}
            </div>
          </div>
        `;
      }).join('');
      
      // Terapkan state checkbox setelah render
      applyDeleteButtonVisibility();
    }

    function clearFilter() {
      document.getElementById('filterStartDate').value = '';
      document.getElementById('filterEndDate').value = '';
      document.getElementById('emptyTransactions').textContent = 'Belum ada transaksi';
      // Hapus filter dari localStorage agar tidak kembali saat refresh
      localStorage.removeItem('sales_filter_start');
      localStorage.removeItem('sales_filter_end');
      renderTransactions();
    }

    function toggleDeleteButtons() {
      const checkbox = document.getElementById('showDeleteBtn');
      const deleteButtons = document.querySelectorAll('.delete-transaction-btn');
      
      deleteButtons.forEach(btn => {
        if (checkbox.checked) {
          btn.classList.remove('hidden');
        } else {
          btn.classList.add('hidden');
        }
      });
      
      // Simpan state checkbox ke localStorage
      localStorage.setItem('nuri_show_delete_btn', checkbox.checked);
    }

    function applyDeleteButtonVisibility() {
      const checkbox = document.getElementById('showDeleteBtn');
      const deleteButtons = document.querySelectorAll('.delete-transaction-btn');
      
      deleteButtons.forEach(btn => {
        if (checkbox && checkbox.checked) {
          btn.classList.remove('hidden');
        } else {
          btn.classList.add('hidden');
        }
      });

      // Sync tampilan ikon toggle
      syncDeleteToggleBtn('deleteBtnToggleSales', checkbox && checkbox.checked);
    }

    // ============================================
    // TRASH ICON TOGGLE FUNCTIONS (Riwayat)
    // ============================================
    function syncDeleteToggleBtn(btnId, isActive) {
      const btn = document.getElementById(btnId);
      if (!btn) return;
      if (isActive) {
        btn.style.background = '#fee2e2';
        btn.style.borderColor = '#ef4444';
        btn.style.color = '#ef4444';
      } else {
        btn.style.background = '#f9fafb';
        btn.style.borderColor = '#e5e7eb';
        btn.style.color = '#9ca3af';
      }
    }

    function toggleDeleteBtnSales() {
      const checkbox = document.getElementById('showDeleteBtn');
      checkbox.checked = !checkbox.checked;
      toggleDeleteButtons();
      syncDeleteToggleBtn('deleteBtnToggleSales', checkbox.checked);
    }

    function toggleDeleteBtnInvoice() {
      const checkbox = document.getElementById('showDeleteBtnInvoice');
      checkbox.checked = !checkbox.checked;
      toggleDeleteButtonsInvoice();
      syncDeleteToggleBtn('deleteBtnToggleInvoice', checkbox.checked);
    }

    function showPrint() {
      const t = currentPrint;
      const store = document.getElementById('storeName').value;
      const phone = document.getElementById('storePhone').value;
      const logoUrl = localStorage.getItem('nuri_logo');

      let html = '<div style="font-family: Arial, sans-serif; max-width: 360px; margin: 0 auto; transform: scale(0.9); transform-origin: top center;">';

      if (logoUrl) {
        html += `
          <div style="text-align: center; margin-bottom: 10px;">
            <img src="${logoUrl}" style="height: 54px; max-width: 100%;">
          </div>
        `;
      }

      html += `
        <div style="text-align: center; border-bottom: 2px dashed #000; padding-bottom: 10px; margin-bottom: 10px; font-size: 12.6px;">
          <strong style="font-size: 16.2px;">${store}</strong><br>
          <span style="font-size: 11.7px;">${phone}</span><br>
          ${t.invoiceNumber ? '<span style="font-size: 11px; font-weight: bold; color: #2cb910;">' + t.invoiceNumber + '</span><br>' : ''}
          <span style="font-size: 10.8px;">${t.date}</span>
        </div>
      `;

      t.items.forEach(it => {
        html += `
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 7px; font-size: 12.6px; line-height: 1.4;">
            <span style="flex: 1; padding-right: 9px;">${it.qty}x ${it.name}${it.note ? ' (üìù ' + it.note + ')' : ''}</span>
            <span style="text-align: right; white-space: nowrap; font-weight: 500;">Rp ${(it.price * it.qty).toLocaleString('id-ID')}</span>
          </div>
        `;
      });

      html += `
        <div style="border-top: 2px dashed #000; margin-top: 10px; padding-top: 10px; font-weight: bold; font-size: 13.5px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <span>Total</span>
            <span>Rp ${t.total.toLocaleString('id-ID')}</span>
          </div>
      `;

      if (t.method === 'cash') {
        html += `
          <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12.6px;">
            <span>Dibayar</span>
            <span>Rp ${t.paid.toLocaleString('id-ID')}</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12.6px; color: green;">
            <span>Kembalian</span>
            <span>Rp ${t.change.toLocaleString('id-ID')}</span>
          </div>
        `;
      }

      html += `
        </div>
        <div style="text-align: center; margin-top: 10px; border-top: 2px dashed #000; padding-top: 10px; font-size: 11.7px;">
          Terima Kasih!<br>
          <strong style="font-size: 13px; margin-top: 8px; display: block;">NURI SNACK</strong>
          <span style="font-size: 10.5px; display: block; margin-top: 3px;">Cemilan Seru Buat Semua</span>
          <div style="margin-top: 8px; font-size: 11px; letter-spacing: 1px;">---------------------------</div>
        </div>
      </div>`;

      document.getElementById('strukDisplay').innerHTML = html;
      
      // Pastikan modal invoice tertutup
      document.getElementById('invoiceModal').classList.remove('show');
      
      // Buka modal print transaksi
      document.getElementById('printModal').classList.add('show');
    }

    function openTransactionPrint(idx) {
      if (transactions[idx]) {
        currentPrint = transactions[idx];
        currentInvoice = null; // Reset currentInvoice agar tidak tercampur
        showPrint();
      }
    }

    function doPrint() {
      window.print();
    }

    function closePrint() {
      document.getElementById('printModal').classList.remove('show');
      // Tampilkan kembali tombol Salin sebagai Penjualan Baru saat modal ditutup
      updateCopySaleButtonVisibility(false);
    }

    function generateInvoiceNumber() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const datePrefix = `${year}${month}${day}`;
      
      // Hitung jumlah invoice hari ini (baik transaksi maupun invoice)
      // Tambahkan validasi untuk mencegah error "Cannot read properties of undefined"
      const todayInvoices = invoices.filter(inv => inv.invoiceNumber && inv.invoiceNumber.includes(datePrefix));
      const todayTransactions = transactions.filter(t => t.invoiceNumber && t.invoiceNumber.includes(datePrefix));
      const totalToday = todayInvoices.length + todayTransactions.length;
      
      const invoiceCounter = String(totalToday + 1).padStart(4, '0');
      return `INV-${datePrefix}-${invoiceCounter}`;
    }

    function saveCartAsInvoice() {
      try {
        if (cart.length === 0) {
          showNotification('‚ùå Keranjang kosong! Tambahkan barang terlebih dahulu.');
          return;
        }

        const total = cart.reduce((sum, item) => sum + item.price * item.qty, 0);
        
        // Gunakan tanggal yang dipilih user atau default hari ini
        const saleDateInput = document.getElementById('saleDate');
        let invoiceDate;
        if (saleDateInput && saleDateInput.value) {
          const dateObj = new Date(saleDateInput.value + 'T' + new Date().toTimeString().split(' ')[0]);
          invoiceDate = dateObj.toLocaleString('id-ID');
        } else {
          invoiceDate = new Date().toLocaleString('id-ID');
        }
        const invoiceNumber = generateInvoiceNumber();

        // Buat objek invoice dengan status pending
        const invoice = {
          invoiceNumber: invoiceNumber,
          date: invoiceDate,
          items: [...cart],
          total: total,
          status: 'pending'
        };

        // Simpan invoice
        invoices.push(invoice);
        localStorage.setItem('nuri_invoices', JSON.stringify(invoices));
        saveInvoiceState('Simpan invoice');

        // Kosongkan cart dan hapus dari localStorage
        cart = [];
        localStorage.removeItem('nuri_cart');
        localStorage.removeItem('nuri_payment_method');
        localStorage.removeItem('nuri_amount_paid');
        
        document.getElementById('amountPaid').value = '';
        document.getElementById('itemNote').value = '';
        document.getElementById('paymentMethod').value = 'cash';
        toggleCashUI();
        
        renderCart();
        renderInvoices();
        
        // Tampilkan invoice yang baru dibuat
        currentInvoice = invoice;
        currentPrint = null;
        displayInvoicePrint();
        
        // Sembunyikan tombol Salin sebagai Penjualan Baru saat simpan keranjang
        updateCopySaleButtonVisibility(true);
        
        showNotification('‚úÖ Keranjang berhasil disimpan sebagai invoice: ' + invoiceNumber);
      } catch (error) {
        console.error('Error di saveCartAsInvoice:', error);
        
        // Jika error quota, data tetap tersimpan di memory
        if (error.message.includes('quota')) {
          invoices.pop(); // Hapus invoice yang baru ditambahkan
          console.warn('LocalStorage quota exceeded');
          showNotification('‚ö†Ô∏è Penyimpanan penuh. Silakan lakukan Backup & Reset data dari menu Pengaturan.');
        } else {
          alert('Terjadi error: ' + error.message);
        }
      }
    }

    function copyToNewSale() {
      if (!currentPrint) {
        showNotification('‚ùå Tidak ada transaksi untuk disalin');
        return;
      }

      // Salin items dari transaksi ke keranjang
      cart = currentPrint.items.map(item => ({
        name: item.name,
        price: item.price,
        qty: item.qty,
        image: item.image || '',
        note: item.note || ''
      }));

      // Simpan ke localStorage
      localStorage.setItem('nuri_cart', JSON.stringify(cart));

      // Tutup modal print
      closePrint();

      // Pindah ke tab penjualan
      showTab('penjualan');
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-btn')[0].classList.add('active');

      // Render keranjang
      renderCart();

      // Tampilkan notifikasi
      showNotification('‚úÖ Transaksi berhasil disalin ke keranjang!');
    }



    function closeInvoice() {
      document.getElementById('invoiceModal').classList.remove('show');
      currentInvoice = null;
    }

    function printInvoice() {
      window.print();
    }

    function showHistoryTab(tab) {
      console.log('=== showHistoryTab:', tab);
      
      if (tab === 'sales') {
        document.getElementById('salesHistory').style.display = 'block';
        document.getElementById('invoicesHistory').style.display = 'none';
        document.getElementById('salesTabBtn').classList.add('active');
        document.getElementById('invoicesTabBtn').classList.remove('active');
        
        // Debug: cek nilai filter
        const startEl = document.getElementById('filterStartDate');
        const endEl = document.getElementById('filterEndDate');
        console.log('Sales filter values:');
        console.log('  Start:', startEl?.value || 'EMPTY');
        console.log('  End:', endEl?.value || 'EMPTY');
        console.log('  localStorage start:', localStorage.getItem('sales_filter_start') || 'EMPTY');
        console.log('  localStorage end:', localStorage.getItem('sales_filter_end') || 'EMPTY');
        
        // Apply filter untuk sales (gunakan filter yang sudah ada)
        filterTransactions();
        
      } else if (tab === 'invoices') {
        document.getElementById('salesHistory').style.display = 'none';
        document.getElementById('invoicesHistory').style.display = 'block';
        document.getElementById('salesTabBtn').classList.remove('active');
        document.getElementById('invoicesTabBtn').classList.add('active');

        // Debug: cek nilai filter
        const startEl = document.getElementById('filterStartDateInvoice');
        const endEl = document.getElementById('filterEndDateInvoice');
        console.log('Invoice filter values:');
        console.log('  Start:', startEl?.value || 'EMPTY');
        console.log('  End:', endEl?.value || 'EMPTY');
        console.log('  localStorage start:', localStorage.getItem('invoice_filter_start') || 'EMPTY');
        console.log('  localStorage end:', localStorage.getItem('invoice_filter_end') || 'EMPTY');

        // Apply filter untuk invoices (gunakan filter yang sudah ada)
        filterInvoices();
      }
      
      // Simpan state sub-tab history aktif ke localStorage
      localStorage.setItem('nuri_active_history_tab', tab);
    }

    function renderInvoices() {
      const list = document.getElementById('invoiceList');
      const empty = document.getElementById('emptyInvoices');

      if (invoices.length === 0) {
        list.innerHTML = '';
        empty.style.display = 'block';
        return;
      }

      empty.style.display = 'none';

      // SORT by date: terbaru di atas
      const sortedInvoices = [...invoices].sort((a, b) => {
        // Parse date: handle id-ID locale "DD/M/YYYY, HH.mm.ss" atau "DD/M/YYYY HH.mm.ss"
        const parseDate = (dateStr) => {
          const sep = dateStr.includes(',') ? ',' : ' ';
          const [datePart, timePart] = dateStr.split(sep).map(s => s.trim());
          const parts = datePart.split('/');
          const timeParts = timePart ? timePart.split(/[.:]/) : ['0', '0', '0'];
          return new Date(
            parseInt(parts[2]),
            parseInt(parts[1]) - 1,
            parseInt(parts[0]),
            parseInt(timeParts[0]) || 0,
            parseInt(timeParts[1]) || 0,
            parseInt(timeParts[2]) || 0
          );
        };
        
        const dateA = parseDate(a.date);
        const dateB = parseDate(b.date);
        
        if (window.invoiceSortOrder === 'desc') {
          return dateB - dateA; // Descending: terbaru di atas
        } else {
          return dateA - dateB; // Ascending: lama di atas
        }
      });

      list.innerHTML = sortedInvoices.map((inv) => {
        // Find original index
        const originalIndex = invoices.indexOf(inv);
        let items = inv.items.map(it => `${it.qty}x ${it.name}${it.note ? ' (üìù ' + it.note + ')' : ''}`).join('<br>');
        let statusBadge = '';
        let paymentButton = '';
        
        // Default status ke 'pending' jika tidak ada
        const status = inv.status || 'pending';
        
        if (status === 'pending') {
          statusBadge = '<span style="background: #fbbf24; color: white; padding: 3px 8px; border-radius: 3px; font-size: 0.75em; font-weight: bold;">PENDING</span>';
          paymentButton = `
            <button class="btn btn-success" onclick="event.stopPropagation(); payInvoice(${originalIndex})" style="width: 100%; padding: 8px; margin-top: 10px; font-size: 0.9em;">
              üí∞ Lakukan Pembayaran
            </button>
          `;
        } else if (status === 'paid') {
          statusBadge = '<span style="background: #10b981; color: white; padding: 3px 8px; border-radius: 3px; font-size: 0.75em; font-weight: bold;">LUNAS</span>';
        } else if (status === 'cancelled') {
          statusBadge = '<span style="background: #ef4444; color: white; padding: 3px 8px; border-radius: 3px; font-size: 0.75em; font-weight: bold;">BATAL</span>';
        }
        
        return `
          <div class="card transaction-card" onclick="openInvoicePrint(${originalIndex})" style="position: relative; cursor: pointer;">
            <button class="delete-transaction-btn hidden" onclick="event.stopPropagation(); deleteInvoice(${originalIndex})" title="Hapus invoice">‚úï</button>
            <div style="margin-bottom: 10px; font-size: 0.9em; color: #666;">
              <span>${inv.date}</span>
            </div>
            <div style="margin-bottom: 5px;">
              <strong style="color: #2cb910; font-size: 0.95em;">${inv.invoiceNumber}</strong>
            </div>
            <div style="margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 10px;">
              ${items}
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px;">
              <strong>Total: Rp ${inv.total.toLocaleString('id-ID')}</strong>
              ${statusBadge}
            </div>
            ${paymentButton}
          </div>
        `;
      }).join('');
      
      applyDeleteButtonVisibilityInvoice();
    }

    function openInvoicePrint(idx) {
      if (invoices[idx]) {
        currentInvoice = invoices[idx];
        currentPrint = null; // Reset currentPrint agar tidak tercampur
        displayInvoicePrint();
      }
    }

    function displayInvoicePrint() {
      const inv = currentInvoice;
      const store = document.getElementById('storeName').value;
      const phone = document.getElementById('storePhone').value;
      const logoUrl = localStorage.getItem('nuri_logo');

      let html = '<div style="font-family: Arial, sans-serif; max-width: 360px; margin: 0 auto; transform: scale(0.9); transform-origin: top center;">';

      if (logoUrl) {
        html += `
          <div style="text-align: center; margin-bottom: 10px;">
            <img src="${logoUrl}" style="height: 54px; max-width: 100%;">
          </div>
        `;
      }

      html += `
        <div style="text-align: center; border-bottom: 2px dashed #000; padding-bottom: 10px; margin-bottom: 10px; font-size: 12.6px;">
          <strong style="font-size: 16.2px;">${store}</strong><br>
          <span style="font-size: 11.7px;">${phone}</span><br>
          <div style="margin-top: 10px; padding: 8px; background: #f0f4f8; border-radius: 5px;">
            <strong style="font-size: 14.4px; color: #046043;">INVOICE / TAGIHAN</strong><br>
            <span style="font-size: 12px; font-weight: bold; color: #2cb910;">${inv.invoiceNumber}</span><br>
            <span style="font-size: 10.8px;">${inv.date}</span>
          </div>
        </div>
      `;

      inv.items.forEach(item => {
        html += `
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 7px; font-size: 12.6px; line-height: 1.4;">
            <span style="flex: 1; padding-right: 9px;">${item.qty}x ${item.name}${item.note ? ' (üìù ' + item.note + ')' : ''}</span>
            <span style="text-align: right; white-space: nowrap; font-weight: 500;">Rp ${(item.price * item.qty).toLocaleString('id-ID')}</span>
          </div>
        `;
      });

      html += `
        <div style="border-top: 2px dashed #000; margin-top: 10px; padding-top: 10px; font-weight: bold; font-size: 13.5px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <span>Total Tagihan</span>
            <span>Rp ${inv.total.toLocaleString('id-ID')}</span>
          </div>
        </div>
      `;

      if (inv.status === 'pending') {
        html += `
          <div style="border-top: 1px solid #ddd; margin-top: 15px; padding-top: 10px; text-align: center; font-size: 11px; color: #666;">
            <p style="margin: 5px 0;">Invoice ini belum merupakan bukti pembayaran.</p>
            <p style="margin: 5px 0;">Mohon lakukan pembayaran untuk menyelesaikan transaksi.</p>
            <p style="margin: 10px 0 5px 0;"><strong>Terima kasih!</strong></p>
          </div>
        `;
      } else if (inv.status === 'paid') {
        html += `
          <div style="border-top: 1px solid #ddd; margin-top: 15px; padding-top: 10px; text-align: center; font-size: 11px; color: #10b981;">
            <p style="margin: 10px 0 5px 0;"><strong>‚úì LUNAS</strong></p>
            <p style="margin: 5px 0; color: #666;">Terima kasih atas pembayarannya!</p>
          </div>
        `;
      } else if (inv.status === 'cancelled') {
        html += `
          <div style="border-top: 1px solid #ddd; margin-top: 15px; padding-top: 10px; text-align: center; font-size: 11px; color: #ef4444;">
            <p style="margin: 10px 0 5px 0;"><strong>‚úó DIBATALKAN</strong></p>
          </div>
        `;
      }

      html += '</div>';

      document.getElementById('invoiceDisplay').innerHTML = html;
      
      // Pastikan modal print transaksi tertutup
      document.getElementById('printModal').classList.remove('show');
      
      // Buka modal invoice
      document.getElementById('invoiceModal').classList.add('show');
    }

    function deleteInvoice(index) {
      if (index < 0 || index >= invoices.length) return;
      
      const invoice = invoices[index];
      const confirmMsg = `Hapus invoice ini?\n\nNomor: ${invoice.invoiceNumber}\nTotal: Rp ${invoice.total.toLocaleString('id-ID')}\nTanggal: ${invoice.date}\n\nData akan dihapus dari lokal dan Firebase.`;
      
      showConfirmDialog(
        'Hapus Invoice?',
        confirmMsg,
        async () => {
          const invoiceNumber = invoice.invoiceNumber;
          
          // Hapus dari local
          invoices.splice(index, 1);
          localStorage.setItem('nuri_invoices', JSON.stringify(invoices));
          
          // Hapus dari Firebase dengan fallback
          if (invoiceNumber) {
            try {
              await deleteInvoiceFromFirebase(invoiceNumber, invoice);
            } catch (error) {
              console.error('Error deleting from Firebase:', error);
            }
          } else {
            console.warn('No invoiceNumber, trying to delete by date+total');
            try {
              await deleteInvoiceFromFirebase(null, invoice);
            } catch (error) {
              console.error('Error deleting from Firebase:', error);
            }
          }
          
          // Save state
          saveInvoiceState('Hapus invoice');
          
          // Render
          renderInvoices();
          showNotification('‚úÖ Invoice berhasil dihapus dari lokal dan Firebase');
        }
      );
    }

    function payInvoice(index) {
      if (index < 0 || index >= invoices.length) return;
      
      const invoice = invoices[index];
      
      // Cek apakah invoice masih pending
      if (invoice.status !== 'pending') {
        showNotification('‚ùå Invoice ini sudah tidak bisa dibayar!');
        return;
      }

      // Konfirmasi
      if (!confirm(`Lakukan pembayaran untuk invoice ini?\n\nNomor: ${invoice.invoiceNumber}\nTotal: Rp ${invoice.total.toLocaleString('id-ID')}\n\nKeranjang saat ini akan diganti dengan item dari invoice.`)) {
        return;
      }

      // Load items dari invoice ke keranjang
      cart = invoice.items.map(item => ({
        name: item.name,
        price: item.price,
        qty: item.qty,
        image: item.image || '',
        note: item.note || ''
      }));

      // Simpan ke localStorage dengan menandai bahwa ini dari invoice
      localStorage.setItem('nuri_cart', JSON.stringify(cart));
      localStorage.setItem('nuri_paying_invoice_index', index.toString());
      localStorage.setItem('nuri_paying_invoice_number', invoice.invoiceNumber);

      // Pindah ke tab penjualan
      showTab('penjualan');
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-btn')[0].classList.add('active');

      // Render keranjang
      renderCart();

      // Sembunyikan tombol Simpan Keranjang karena ini pembayaran dari invoice
      updateSaveCartButtonVisibility();

      // Tampilkan notifikasi
      showNotification(`üìã Invoice ${invoice.invoiceNumber} dimuat ke keranjang. Silakan lakukan pembayaran.`);
    }

    function filterInvoices() {
      const startDate = document.getElementById('filterStartDateInvoice').value;
      const endDate = document.getElementById('filterEndDateInvoice').value;
      const list = document.getElementById('invoiceList');
      const empty = document.getElementById('emptyInvoices');

      console.log('=== filterInvoices() called ===');
      console.log('  startDate:', startDate || 'EMPTY');
      console.log('  endDate:', endDate || 'EMPTY');

      // Save filter state to localStorage
      if (startDate) {
        localStorage.setItem('invoice_filter_start', startDate);
        console.log('  ‚úì Saved start to localStorage');
      } else {
        localStorage.removeItem('invoice_filter_start');
        console.log('  ‚úó Removed start from localStorage');
      }
      
      if (endDate) {
        localStorage.setItem('invoice_filter_end', endDate);
        console.log('  ‚úì Saved end to localStorage');
      } else {
        localStorage.removeItem('invoice_filter_end');
        console.log('  ‚úó Removed end from localStorage');
      }

      if (!startDate && !endDate) {
        console.log('  ‚Üí No filter, calling renderInvoices() - SHOW ALL');
        renderInvoices();
        return;
      }

      console.log('  ‚Üí Filtering invoices...');

      const filteredInvoices = invoices.filter(inv => {
        const dateParts = inv.date.split(',')[0].trim().split('/');
        const day = parseInt(dateParts[0]);
        const month = parseInt(dateParts[1]) - 1;
        const year = parseInt(dateParts[2]);
        const invoiceDate = new Date(year, month, day);
        invoiceDate.setHours(0, 0, 0, 0);

        let matchStart = true;
        let matchEnd = true;

        if (startDate) {
          const start = new Date(startDate);
          start.setHours(0, 0, 0, 0);
          matchStart = invoiceDate >= start;
        }

        if (endDate) {
          const end = new Date(endDate);
          end.setHours(23, 59, 59, 999);
          matchEnd = invoiceDate <= end;
        }

        return matchStart && matchEnd;
      });

      if (filteredInvoices.length === 0) {
        list.innerHTML = '';
        empty.style.display = 'block';
        empty.textContent = 'Tidak ada invoice pada periode yang dipilih';
        // Reset statistik ketika filter kosong (cek elemen ada)
        const elInvLunasTypes = document.getElementById('statInvLunasTypes');
        if (elInvLunasTypes) elInvLunasTypes.textContent = '0';
        const elInvLunasQty = document.getElementById('statInvLunasQty');
        if (elInvLunasQty) elInvLunasQty.textContent = '0';
        const elInvLunasAmount = document.getElementById('statInvLunasAmount');
        if (elInvLunasAmount) elInvLunasAmount.textContent = 'Rp 0';
        const elInvPendingTypes = document.getElementById('statInvPendingTypes');
        if (elInvPendingTypes) elInvPendingTypes.textContent = '0';
        const elInvPendingQty = document.getElementById('statInvPendingQty');
        if (elInvPendingQty) elInvPendingQty.textContent = '0';
        const elInvPendingAmount = document.getElementById('statInvPendingAmount');
        if (elInvPendingAmount) elInvPendingAmount.textContent = 'Rp 0';
        return;
      }

      empty.style.display = 'none';

      // SORT filtered invoices berdasarkan invoiceSortOrder
      const sortedFiltered = [...filteredInvoices].sort((a, b) => {
        // Parse date: handle id-ID locale "DD/M/YYYY, HH.mm.ss" atau "DD/M/YYYY HH.mm.ss"
        const parseDate = (dateStr) => {
          const sep = dateStr.includes(',') ? ',' : ' ';
          const [datePart, timePart] = dateStr.split(sep).map(s => s.trim());
          const parts = datePart.split('/');
          const timeParts = timePart ? timePart.split(/[.:]/) : ['0', '0', '0'];
          return new Date(
            parseInt(parts[2]),
            parseInt(parts[1]) - 1,
            parseInt(parts[0]),
            parseInt(timeParts[0]) || 0,
            parseInt(timeParts[1]) || 0,
            parseInt(timeParts[2]) || 0
          );
        };
        
        const dateA = parseDate(a.date);
        const dateB = parseDate(b.date);
        
        if (window.invoiceSortOrder === 'desc') {
          return dateB - dateA; // Descending: terbaru di atas
        } else {
          return dateA - dateB; // Ascending: lama di atas
        }
      });

      list.innerHTML = sortedFiltered.map((inv) => {
        const originalIndex = invoices.indexOf(inv);
        let items = inv.items.map(it => `${it.qty}x ${it.name}${it.note ? ' (üìù ' + it.note + ')' : ''}`).join('<br>');
        let statusBadge = '';
        let paymentButton = '';
        
        // Default status ke 'pending' jika tidak ada
        const status = inv.status || 'pending';
        
        if (status === 'pending') {
          statusBadge = '<span style="background: #fbbf24; color: white; padding: 3px 8px; border-radius: 3px; font-size: 0.75em; font-weight: bold;">PENDING</span>';
          paymentButton = `
            <button class="btn btn-success" onclick="event.stopPropagation(); payInvoice(${originalIndex})" style="width: 100%; padding: 8px; margin-top: 10px; font-size: 0.9em;">
              üí∞ Lakukan Pembayaran
            </button>
          `;
        } else if (status === 'paid') {
          statusBadge = '<span style="background: #10b981; color: white; padding: 3px 8px; border-radius: 3px; font-size: 0.75em; font-weight: bold;">LUNAS</span>';
        } else if (status === 'cancelled') {
          statusBadge = '<span style="background: #ef4444; color: white; padding: 3px 8px; border-radius: 3px; font-size: 0.75em; font-weight: bold;">BATAL</span>';
        }
        
        return `
          <div class="card" onclick="${status !== 'pending' ? 'openInvoicePrint(' + originalIndex + ')' : ''}" style="position: relative; ${status !== 'pending' ? 'cursor: pointer;' : ''}">
            <button class="delete-transaction-btn hidden" onclick="event.stopPropagation(); deleteInvoice(${originalIndex})" title="Hapus invoice">‚úï</button>
            <div style="margin-bottom: 10px; font-size: 0.9em; color: #666;">
              <span>${inv.date}</span>
            </div>
            <div style="margin-bottom: 5px;">
              <strong style="color: #2cb910; font-size: 0.95em;">${inv.invoiceNumber}</strong>
            </div>
            <div style="margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 10px;">
              ${items}
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px;">
              <strong>Total: Rp ${inv.total.toLocaleString('id-ID')}</strong>
              ${statusBadge}
            </div>
            ${paymentButton}
          </div>
        `;
      }).join('');
      
      applyDeleteButtonVisibilityInvoice();
    }

    function clearFilterInvoice() {
      document.getElementById('filterStartDateInvoice').value = '';
      document.getElementById('filterEndDateInvoice').value = '';
      document.getElementById('emptyInvoices').textContent = 'Belum ada invoice';
      // Hapus filter dari localStorage agar tidak kembali saat refresh
      localStorage.removeItem('invoice_filter_start');
      localStorage.removeItem('invoice_filter_end');
      renderInvoices();
    }

    function toggleDeleteButtonsInvoice() {
      const checkbox = document.getElementById('showDeleteBtnInvoice');
      const deleteButtons = document.querySelectorAll('#invoiceList .delete-transaction-btn');
      
      deleteButtons.forEach(btn => {
        if (checkbox.checked) {
          btn.classList.remove('hidden');
        } else {
          btn.classList.add('hidden');
        }
      });
      
      localStorage.setItem('nuri_show_delete_btn_invoice', checkbox.checked);
    }

    function applyDeleteButtonVisibilityInvoice() {
      const checkbox = document.getElementById('showDeleteBtnInvoice');
      const deleteButtons = document.querySelectorAll('#invoiceList .delete-transaction-btn');
      
      deleteButtons.forEach(btn => {
        if (checkbox && checkbox.checked) {
          btn.classList.remove('hidden');
        } else {
          btn.classList.add('hidden');
        }
      });

      // Sync tampilan ikon toggle
      syncDeleteToggleBtn('deleteBtnToggleInvoice', checkbox && checkbox.checked);
    }

    function openSettings() {
      loadSettings();
      document.getElementById('statTrans').textContent = transactions.length;
      const revenue = transactions.reduce((sum, t) => sum + t.total, 0);
      document.getElementById('statRevenue').textContent = 'Rp ' + revenue.toLocaleString('id-ID');
      
      // Statistik invoice
      document.getElementById('statInvoices').textContent = invoices.length;
      const pendingInvoices = invoices.filter(inv => inv.status === 'pending').length;
      document.getElementById('statInvoicesPending').textContent = pendingInvoices;
      
      document.getElementById('settingsModal').classList.add('show');
    }

    // ============================================
    // ACCORDION TOGGLE
    // ============================================
    function toggleAccordion(header) {
      const item = header.parentElement;
      const wasActive = item.classList.contains('active');
      
      // Close all accordions
      document.querySelectorAll('.accordion-item').forEach(acc => {
        acc.classList.remove('active');
      });
      
      // Open clicked accordion if it wasn't active
      if (!wasActive) {
        item.classList.add('active');
      }
    }

    function closeSettings() {
      document.getElementById('settingsModal').classList.remove('show');
    }

    // ============================================
    // FORCE FIX INVOICE STATUS (MANUAL)
    // ============================================
    function forceFixInvoiceStatus() {
      showConfirmDialog(
        '‚öôÔ∏è Perbaiki Status Invoice?',
        'Akan memperbaiki semua invoice yang statusnya salah. Proses ini aman dan tidak menghapus data. Lanjutkan?',
        () => {
          console.log('=== FORCE FIX INVOICE STATUS ===');
          console.log('Total invoices:', invoices.length);
          console.log('Total transactions:', transactions.length);
          
          let fixed = 0;
          let alreadyCorrect = 0;
          let deleted = 0;
          
          // Filter AND fix invoices
          invoices = invoices.filter((inv, index) => {
            const oldStatus = inv.status;
            
            console.log('');
            console.log(`Checking Invoice #${index + 1}:`, inv.invoiceNumber || 'NO NUMBER');
            
            // DELETE jika tidak punya invoiceNumber
            if (!inv.invoiceNumber) {
              console.warn('  ‚ö†Ô∏è DELETING: No invoiceNumber');
              deleted++;
              return false; // DELETE!
            }
            
            // Cek data pembayaran
            const hasPaid = inv.paid !== undefined && inv.paid !== null;
            const hasPaymentMethod = inv.paymentMethod !== undefined && inv.paymentMethod !== null && inv.paymentMethod !== '';
            const hasChange = inv.change !== undefined && inv.change !== null;
            
            // Cek di transactions
            const inTransactions = transactions.some(tx => 
              tx.invoiceNumber && tx.invoiceNumber === inv.invoiceNumber
            );
            
            console.log('  Current status:', oldStatus || 'undefined');
            console.log('  Has payment data:', hasPaid || hasPaymentMethod || hasChange);
            console.log('  In transactions:', inTransactions);
            
            // Determine correct status
            let correctStatus;
            
            if (hasPaid && hasPaymentMethod) {
              correctStatus = 'paid';
              console.log('  ‚Üí Should be: PAID (complete payment data)');
            } else if (inTransactions) {
              correctStatus = 'paid';
              console.log('  ‚Üí Should be: PAID (in transactions)');
            } else if (hasPaid || hasPaymentMethod || hasChange) {
              correctStatus = 'paid';
              console.log('  ‚Üí Should be: PAID (partial payment data)');
            } else {
              correctStatus = 'pending';
              console.log('  ‚Üí Should be: PENDING (no payment, not in transactions)');
            }
            
            // Fix jika salah
            if (inv.status !== correctStatus) {
              inv.status = correctStatus;
              fixed++;
              console.log(`  ‚úÖ FIXED: ${oldStatus || 'undefined'} ‚Üí ${correctStatus}`);
            } else {
              alreadyCorrect++;
              console.log('  ‚úì Already correct');
            }
            
            return true; // Keep valid invoice
          });
          
          // Save
          localStorage.setItem('nuri_invoices', JSON.stringify(invoices));
          
          // Refresh display
          renderInvoices();
          
          console.log('');
          console.log('=== FIX SUMMARY ===');
          console.log('‚úì Fixed:', fixed, 'invoices');
          console.log('‚úì Already correct:', alreadyCorrect, 'invoices');
          console.log('üóëÔ∏è Deleted (invalid):', deleted, 'invoices');
          console.log('=== FIX COMPLETED ===');
          
          if (fixed > 0 || deleted > 0) {
            let msg = '';
            if (fixed > 0) msg += `‚úÖ Diperbaiki: ${fixed} invoice\n`;
            if (alreadyCorrect > 0) msg += `‚úì Sudah benar: ${alreadyCorrect} invoice\n`;
            if (deleted > 0) msg += `üóëÔ∏è Dihapus: ${deleted} invoice invalid\n`;
            msg += '\nSilakan cek tab Riwayat ‚Üí Invoice';
            showNotification(msg);
          } else {
            showNotification(`‚úì Semua invoice sudah benar!\n\n${alreadyCorrect} invoice status OK.`);
          }
        }
      );
    }

    function backup() {
      const data = {
        store: document.getElementById('storeName').value,
        phone: document.getElementById('storePhone').value,
        products,
        transactions,
        invoices
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      
      const now = new Date();
      const day = String(now.getDate()).padStart(2, '0');
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const year = now.getFullYear();
      a.download = `nuri-backup-${day}-${month}-${year}.json`;
      
      a.click();
      showNotification('‚úÖ Backup berhasil diunduh!');
    }

    function restore() {
      const file = document.getElementById('fileRestore').files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          if (confirm(`Restore backup dari ${data.store}?\n\nData lama akan diganti dengan data dari backup.`)) {
            products = data.products || [];
            transactions = data.transactions || [];
            invoices = data.invoices || [];
            localStorage.setItem('nuri_products', JSON.stringify(products));
            localStorage.setItem('nuri_transactions', JSON.stringify(transactions));
            localStorage.setItem('nuri_invoices', JSON.stringify(invoices));
            localStorage.setItem('nuri_store_name', data.store);
            localStorage.setItem('nuri_store_phone', data.phone);
            location.reload();
          }
        } catch {
          showNotification('‚ùå File tidak valid');
        }
      };
      reader.readAsText(file);
    }
    
    // ============================================
    // EXPORT/IMPORT PRODUCTS (Barang)
    // ============================================
    function exportProducts() {
      if (products.length === 0) {
        showNotification('‚ùå Belum ada barang untuk diexport');
        return;
      }
      
      const exportData = {
        exportDate: new Date().toLocaleString('id-ID'),
        exportTime: Date.now(),
        totalProducts: products.length,
        storeName: document.getElementById('storeName').value || 'NURI SNACK',
        products: products.map(p => ({
          name: p.name,
          price: p.price,
          image: p.image || ''
        }))
      };
      
      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      
      const now = new Date();
      const day = String(now.getDate()).padStart(2, '0');
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const year = now.getFullYear();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      
      a.download = `nuri-products-${day}${month}${year}-${hours}${minutes}.json`;
      
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showNotification(`‚úÖ ${products.length} barang berhasil diexport!`);
    }
    
    function importProducts(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          
          // Validasi format
          if (!data.products || !Array.isArray(data.products)) {
            showNotification('‚ùå Format file tidak valid. File harus berisi array "products".');
            event.target.value = '';
            return;
          }
          
          if (data.products.length === 0) {
            showNotification('‚ùå File tidak berisi produk apapun.');
            event.target.value = '';
            return;
          }
          
          const importCount = data.products.length;
          const currentCount = products.length;
          
          // Tanya mode: TIMPA atau TAMBAH
          const mode = confirm(
            `üì¶ File berisi ${importCount} barang\n` +
            `üìä Saat ini ada ${currentCount} barang di aplikasi\n\n` +
            `Pilih mode import:\n\n` +
            `‚úÖ Klik OK = TIMPA SEMUA (ganti ${currentCount} ‚Üí ${importCount})\n` +
            `‚ùå Klik CANCEL = TAMBAHKAN (merge, skip duplikat)`
          );
          
          if (mode) {
            // MODE TIMPA - Ganti semua
            products = data.products.map(p => ({
              id: Date.now() + Math.random(),
              name: p.name,
              price: Number(p.price),
              image: p.image || ''
            }));
            
            saveData();
            renderProducts();
            showNotification(`‚úÖ ${importCount} barang berhasil diimport (mode TIMPA)\n\nSemua barang lama diganti.`);
            
          } else {
            // MODE TAMBAH - Merge dengan skip duplikat
            let addedCount = 0;
            let skipCount = 0;
            
            data.products.forEach(p => {
              // Cek duplikat berdasarkan nama (case-insensitive)
              const exists = products.find(existing => 
                existing.name.toLowerCase().trim() === p.name.toLowerCase().trim()
              );
              
              if (!exists) {
                products.push({
                  id: Date.now() + Math.random() + addedCount,
                  name: p.name,
                  price: Number(p.price),
                  image: p.image || ''
                });
                addedCount++;
              } else {
                skipCount++;
              }
            });
            
            saveData();
            renderProducts();
            
            showNotification(
              `‚úÖ Import berhasil!\n\n` +
              `‚ûï ${addedCount} barang baru ditambahkan\n` +
              `‚è≠Ô∏è ${skipCount} duplikat diabaikan\n` +
              `üì¶ Total sekarang: ${products.length} barang`
            );
          }
          
          // Reset file input
          event.target.value = '';
          
        } catch (error) {
          console.error('Import error:', error);
          showNotification('‚ùå File tidak valid atau rusak\n\nPastikan file adalah JSON export yang benar.');
          event.target.value = '';
        }
      };
      
      reader.onerror = () => {
        showNotification('‚ùå Gagal membaca file');
        event.target.value = '';
      };
      
      reader.readAsText(file);
    }

    function clearAll() {
      showConfirmDialog(
        '‚ö†Ô∏è Hapus Data?',
        'Akan menghapus SEMUA data transaksi, invoice, dan produk dari browser ini.\n\nLogo Toko dan Pengaturan Database (Firebase) akan tetap tersimpan.\n\nData di Firebase tidak akan terpengaruh.\n\nLanjutkan?',
        () => {
          console.log('=== Clearing Local Data ===');
          
          // DAFTAR keys yang INGIN DIPERTAHANKAN
          const preserveKeys = [
            'nuri_logo',              // Logo toko
            'firebase_config',        // Firebase config (SATU object, bukan individual keys!)
            'nuri_store_name',        // Nama toko
            'nuri_store_phone'        // Nomor telepon
          ];
          
          // BACKUP nilai dari keys yang ingin dipertahankan
          const preservedData = {};
          preserveKeys.forEach(key => {
            const value = localStorage.getItem(key);
            if (value !== null) {
              preservedData[key] = value;
              console.log('Backed up:', key, '=', value.substring(0, 50) + '...');
            }
          });
          
          console.log('Total backed up:', Object.keys(preservedData).length, 'items');
          console.log('preservedData object:', preservedData);
          
          // CLEAR semua array data
          products = [];
          transactions = [];
          invoices = [];
          cart = [];
          history = [];
          invoiceHistory = [];
          historyIndex = -1;
          invoiceHistoryIndex = -1;
          
          // SAVE empty arrays to localStorage
          localStorage.setItem('nuri_products', JSON.stringify(products));
          localStorage.setItem('nuri_transactions', JSON.stringify(transactions));
          localStorage.setItem('nuri_invoices', JSON.stringify(invoices));
          localStorage.setItem('nuri_cart', JSON.stringify(cart));
          console.log('Saved empty arrays to localStorage');
          
          // HAPUS keys lain yang tidak di-preserve
          const allKeys = Object.keys(localStorage);
          let removedCount = 0;
          
          allKeys.forEach(key => {
            // Skip preserved keys DAN array data yang sudah dikosongkan
            if (!preserveKeys.includes(key) && 
                key !== 'nuri_products' && 
                key !== 'nuri_transactions' && 
                key !== 'nuri_invoices' && 
                key !== 'nuri_cart') {
              localStorage.removeItem(key);
              console.log('Removed:', key);
              removedCount++;
            }
          });
          
          console.log('Total removed:', removedCount, 'items');
          
          // VERIFY preserved items masih ada
          console.log('=== Verifying Preserved Items ===');
          preserveKeys.forEach(key => {
            const stillExists = localStorage.getItem(key);
            console.log(key, ':', stillExists ? '‚úì STILL EXISTS' : '‚úó MISSING!');
          });
          
          console.log('=== Clear Completed ===');
          console.log('Logo & Firebase config preserved');
          
          // DELETE dari Firebase juga jika ready
          if (isFirebaseReady) {
            console.log('Deleting data from Firebase...');
            
            // Delete all products from Firebase
            firebaseDB.collection('products').get().then(snapshot => {
              const batch = firebaseDB.batch();
              snapshot.docs.forEach(doc => batch.delete(doc.ref));
              return batch.commit();
            }).then(() => {
              console.log('‚úì Deleted all products from Firebase');
            }).catch(e => console.warn('Firebase product delete failed:', e));
            
            // Delete all transactions from Firebase
            firebaseDB.collection('transactions').get().then(snapshot => {
              const batch = firebaseDB.batch();
              snapshot.docs.forEach(doc => batch.delete(doc.ref));
              return batch.commit();
            }).then(() => {
              console.log('‚úì Deleted all transactions from Firebase');
            }).catch(e => console.warn('Firebase transaction delete failed:', e));
            
            // Delete all invoices from Firebase
            firebaseDB.collection('invoices').get().then(snapshot => {
              const batch = firebaseDB.batch();
              snapshot.docs.forEach(doc => batch.delete(doc.ref));
              return batch.commit();
            }).then(() => {
              console.log('‚úì Deleted all invoices from Firebase');
            }).catch(e => console.warn('Firebase invoice delete failed:', e));
          }
          
          // Reload page dengan delay lebih panjang
          showNotification('‚úÖ Data berhasil dihapus!\n\nLogo dan Firebase config tetap tersimpan.\n\nReloading...');
          
          setTimeout(() => {
            location.reload();
          }, 3000); // 3 detik untuk Firebase delete selesai
        }
      );
    }

    // Event listener untuk menyimpan amountPaid saat input berubah
    document.addEventListener('DOMContentLoaded', function() {
      const amountPaidInput = document.getElementById('amountPaid');
      if (amountPaidInput) {
        amountPaidInput.addEventListener('input', function() {
          const value = this.value;
          if (value) {
            localStorage.setItem('nuri_amount_paid', value);
          }
        });
      }
    });

    function uploadLogo() {
      const file = document.getElementById('logoFile').files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        const logoData = e.target.result;
        localStorage.setItem('nuri_logo', logoData);
        document.getElementById('logoImg').src = logoData;
        document.getElementById('logoImg').style.display = 'block';
        document.getElementById('logoUrl').value = 'Logo sudah diupload';
        showNotification('‚úÖ Logo berhasil diupload');
      };
      reader.readAsDataURL(file);
    }

    function removeLogo() {
      if (confirm('Apakah Anda yakin ingin menghapus logo toko?')) {
        localStorage.removeItem('nuri_logo');
        document.getElementById('logoImg').src = '';
        document.getElementById('logoImg').style.display = 'none';
        document.getElementById('logoUrl').value = '';
        showNotification('‚úÖ Logo berhasil dihapus');
      }
    }

    document.getElementById('logoUrl').addEventListener('change', function() {
      if (this.value && this.value.startsWith('http')) {
        localStorage.setItem('nuri_logo', this.value);
        document.getElementById('logoImg').src = this.value;
        document.getElementById('logoImg').style.display = 'block';
        showNotification('‚úÖ Logo dari URL berhasil dimuat');
      }
    });

    window.addEventListener('click', function(e) {
      const notificationModal = document.getElementById('notificationModal');
      if (notificationModal && e.target === notificationModal) {
        closeNotification();
      }
    });

    window.addEventListener('keydown', function(e) {
      const notificationModal = document.getElementById('notificationModal');

      if (notificationModal && notificationModal.classList.contains('show') && e.key === 'Enter') {
        e.preventDefault();
        closeNotification();
      }
      
      // Keyboard shortcuts untuk undo/redo
      if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
        e.preventDefault();
        undo();
      }
      
      if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
        e.preventDefault();
        redo();
      }
    });

    // ============================================
    // DASHBOARD ANALYTICS
    // ============================================
    let salesChart = null;
    let currentPeriod = 'week';

    function changePeriod(period) {
      currentPeriod = period;
      
      // Update button active state
      document.querySelectorAll('#dashboard .btn').forEach(btn => {
        btn.style.opacity = '0.7';
        btn.style.background = 'linear-gradient(135deg, #046043eb, #2cb9109c)';
      });
      
      const activeBtn = document.getElementById('btn' + period.charAt(0).toUpperCase() + period.slice(1));
      if (activeBtn) {
        activeBtn.style.opacity = '1';
        activeBtn.style.background = 'linear-gradient(135deg, #2cb910, #046043)';
      }
      
      refreshDashboard();
    }

    function parseDateString(dateStr) {
      // Format bisa: "DD/MM/YYYY HH:MM:SS" atau "D/M/YYYY, HH.MM.SS"
      if (!dateStr) return new Date();
      
      try {
        // Ambil bagian tanggal saja (sebelum spasi atau koma)
        const datePart = dateStr.split(/[\s,]/)[0];
        const parts = datePart.split('/');
        
        if (parts.length === 3) {
          // parts[0] = DD, parts[1] = MM, parts[2] = YYYY
          const day = parseInt(parts[0]);
          const month = parseInt(parts[1]) - 1; // Month is 0-indexed
          const year = parseInt(parts[2]);
          
          return new Date(year, month, day);
        }
      } catch (e) {
        console.error('Error parsing date:', dateStr, e);
      }
      
      return new Date();
    }

    function getFilteredTransactions() {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      
      const filtered = transactions.filter(tx => {
        const txDate = parseDateString(tx.date);
        
        switch(currentPeriod) {
          case 'today':
            // Same day
            return txDate.getFullYear() === today.getFullYear() &&
                   txDate.getMonth() === today.getMonth() &&
                   txDate.getDate() === today.getDate();
          case 'week':
            const weekAgo = new Date(today);
            weekAgo.setDate(weekAgo.getDate() - 6); // Last 7 days including today
            return txDate >= weekAgo && txDate <= now;
          case 'month':
            const monthAgo = new Date(today);
            monthAgo.setDate(monthAgo.getDate() - 29); // Last 30 days including today
            return txDate >= monthAgo && txDate <= now;
          case 'all':
          default:
            return true;
        }
      });
      
      console.log('Period:', currentPeriod, 'Filtered transactions:', filtered.length);
      return filtered;
    }

    function refreshDashboard() {
      console.log('=== refreshDashboard called ===');
      console.log('Current period:', currentPeriod);
      console.log('Total transactions:', transactions.length);
      
      const filtered = getFilteredTransactions();
      console.log('Filtered transactions:', filtered.length);
      
      // Calculate summary
      const totalSales = filtered.reduce((sum, tx) => sum + tx.total, 0);
      const totalTx = filtered.length;
      const avgTx = totalTx > 0 ? totalSales / totalTx : 0;
      const pendingInv = invoices.filter(inv => inv.status === 'pending').length;
      
      console.log('Total sales:', totalSales);
      console.log('Avg transaction:', avgTx);
      
      // Update summary cards
      document.getElementById('totalSales').textContent = 'Rp ' + totalSales.toLocaleString('id-ID');
      document.getElementById('totalTransactions').textContent = totalTx;
      document.getElementById('avgTransaction').textContent = 'Rp ' + Math.round(avgTx).toLocaleString('id-ID');
      document.getElementById('pendingInvoices').textContent = pendingInv;
      
      // Update chart
      updateSalesChart(filtered);
      
      // Update top products
      updateTopProducts(filtered);
      
      console.log('=== Dashboard updated ===');
    }

    function updateSalesChart(filtered) {
      const canvas = document.getElementById('salesChart');
      const ctx = canvas.getContext('2d');
      
      // Destroy existing chart
      if (salesChart) {
        salesChart.destroy();
      }
      
      // Prepare data based on period
      let labels = [];
      let data = [];
      
      if (currentPeriod === 'today') {
        // Hourly data for today
        for (let i = 0; i < 24; i++) {
          labels.push(i + ':00');
          data.push(0);
        }
        
        console.log('Processing today data, filtered count:', filtered.length);
        
        filtered.forEach(tx => {
          try {
            // Parse hour from date string
            // Format bisa: "DD/MM/YYYY HH:MM:SS" atau "DD/MM/YYYY, HH.MM.SS" atau "D/M/YYYY, HH.MM.SS"
            console.log('Transaction date:', tx.date);
            
            // Split by space or comma to get time part
            const parts = tx.date.split(/[\s,]+/);
            let timePart = null;
            
            // Find the time part (contains : or .)
            for (const part of parts) {
              if (part.includes(':') || part.includes('.')) {
                timePart = part;
                break;
              }
            }
            
            if (timePart) {
              const hourStr = timePart.split(/[:.]/)[0]; // Get hour
              const hour = parseInt(hourStr);
              console.log('Parsed hour:', hour, 'from', timePart);
              
              if (hour >= 0 && hour < 24) {
                data[hour] += tx.total;
                console.log('Added', tx.total, 'to hour', hour);
              }
            } else {
              console.warn('No time part found in:', tx.date);
            }
          } catch (e) {
            console.error('Error parsing time:', tx.date, e);
          }
        });
        
        console.log('Final hourly data:', data);
      } else {
        // Daily data
        const days = currentPeriod === 'week' ? 7 : currentPeriod === 'month' ? 30 : 
                     currentPeriod === 'all' ? Math.min(365, filtered.length > 0 ? 
                     Math.ceil((new Date() - parseDateString(filtered[filtered.length - 1].date)) / (1000 * 60 * 60 * 24)) + 1 : 30) : 30;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // Create date map
        const dateMap = {};
        for (let i = days - 1; i >= 0; i--) {
          const date = new Date(today);
          date.setDate(date.getDate() - i);
          const key = date.getDate() + '/' + (date.getMonth() + 1);
          labels.push(key);
          dateMap[key] = 0;
        }
        
        // Fill data
        filtered.forEach(tx => {
          const txDate = parseDateString(tx.date);
          const key = txDate.getDate() + '/' + (txDate.getMonth() + 1);
          if (dateMap.hasOwnProperty(key)) {
            dateMap[key] += tx.total;
          }
        });
        
        // Convert map to array
        data = labels.map(label => dateMap[label] || 0);
      }
      
      console.log('Chart data:', { labels, data, period: currentPeriod });
      
      salesChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Penjualan (Rp)',
            data: data,
            borderColor: '#2cb910',
            backgroundColor: 'rgba(44, 185, 16, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return 'Rp ' + context.parsed.y.toLocaleString('id-ID');
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return 'Rp ' + value.toLocaleString('id-ID');
                }
              }
            }
          }
        }
      });
    }

    function updateTopProducts(filtered) {
      const productStats = {};
      
      filtered.forEach(tx => {
        tx.items.forEach(item => {
          if (!productStats[item.name]) {
            productStats[item.name] = {
              name: item.name,
              qty: 0,
              revenue: 0
            };
          }
          productStats[item.name].qty += item.qty;
          productStats[item.name].revenue += item.price * item.qty;
        });
      });
      
      // Sort by revenue
      const sorted = Object.values(productStats).sort((a, b) => b.revenue - a.revenue).slice(0, 5);
      
      const container = document.getElementById('topProducts');
      
      if (sorted.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Belum ada data penjualan</div>';
        return;
      }
      
      container.innerHTML = sorted.map((prod, i) => `
        <div style="display: flex; align-items: center; padding: 12px; background: ${i % 2 === 0 ? '#f0f4f8' : 'white'}; border-radius: 5px; margin-bottom: 8px;">
          <div style="width: 30px; height: 30px; background: linear-gradient(135deg, #2cb910, #046043); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 12px;">
            ${i + 1}
          </div>
          <div style="flex: 1;">
            <div style="font-weight: bold; color: #333;">${prod.name}</div>
            <div style="font-size: 0.85em; color: #666;">${prod.qty} item terjual</div>
          </div>
          <div style="font-weight: bold; color: #2cb910;">
            Rp ${prod.revenue.toLocaleString('id-ID')}
          </div>
        </div>
      `).join('');
    }

    window.addEventListener('load', init);

    // ============================================
    // FIREBASE CONFIGURATION FUNCTIONS
    // ============================================
    
    function saveFirebaseConfig() {
      const config = {
        apiKey: document.getElementById('firebaseApiKey').value.trim(),
        authDomain: document.getElementById('firebaseAuthDomain').value.trim(),
        projectId: document.getElementById('firebaseProjectId').value.trim(),
        storageBucket: document.getElementById('firebaseStorageBucket').value.trim(),
        messagingSenderId: document.getElementById('firebaseMessagingSenderId').value.trim(),
        appId: document.getElementById('firebaseAppId').value.trim()
      };
      
      if (!config.apiKey || !config.projectId || !config.appId) {
        showFirebaseStatus('‚ùå API Key, Project ID, dan App ID harus diisi', 'error');
        return;
      }
      
      localStorage.setItem('firebase_config', JSON.stringify(config));
      
      if (initFirebase()) {
        showFirebaseStatus('‚úì Konfigurasi berhasil disimpan!', 'success');
        loadFromFirebase();
      } else {
        showFirebaseStatus('‚ö† Config tersimpan tapi gagal connect', 'warning');
      }
    }
    
    async function testFirebase() {
      if (!isFirebaseReady) {
        showFirebaseStatus('‚ùå Firebase belum dikonfigurasi', 'error');
        return;
      }
      
      try {
        showFirebaseStatus('‚è≥ Testing koneksi...', 'loading');
        
        await firebaseDB.collection('_test').doc('ping').set({
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        const doc = await firebaseDB.collection('_test').doc('ping').get();
        
        if (doc.exists) {
          showFirebaseStatus('‚úì Koneksi berhasil!', 'success');
        } else {
          showFirebaseStatus('‚ö† Write OK tapi Read gagal', 'warning');
        }
      } catch (error) {
        showFirebaseStatus('‚ùå Error: ' + error.message, 'error');
      }
    }
    
    async function manualSync() {
      if (!isFirebaseReady) {
        alert('Firebase belum dikonfigurasi. Silakan isi konfigurasi terlebih dahulu.');
        return;
      }
      showFirebaseStatus('‚è≥ Syncing...', 'loading');
      try {
        await loadFromFirebase();
        renderProducts();
        renderTransactions();
        renderInvoices();
        showFirebaseStatus('‚úÖ Sync berhasil! Produk: ' + products.length, 'success');
        setTimeout(() => closeSettings(), 2000);
      } catch (e) {
        showFirebaseStatus('‚ùå Error: ' + e.message, 'error');
      }
    }
    
    async function restoreAllFromFirebase() {
      if (!isFirebaseReady) {
        showFirebaseStatus('‚ùå Firebase belum dikonfigurasi', 'error');
        return;
      }
      
      if (!confirm('‚ö†Ô∏è Restore SEMUA data dari Firebase?\n\nIni akan mengganti data lokal Anda dengan data dari Firebase.\n\nLanjutkan?')) {
        return;
      }
      
      try {
        showFirebaseStatus('‚è≥ Memuat semua data dari Firebase...', 'loading');
        
        // Load ALL products (tanpa limit)
        const productsSnapshot = await firebaseDB.collection('products')
          .orderBy('timestamp', 'desc')
          .get();
        
        const fbProducts = [];
        productsSnapshot.forEach(doc => {
          const data = doc.data();
          fbProducts.push({
            id: data.id || doc.id,  // Use data.id (actual product ID), fallback to doc.id
            name: data.name,
            price: data.price,
            image: data.image || ''
          });
        });
        
        if (fbProducts.length > 0) {
          products = fbProducts;
          localStorage.setItem('nuri_products', JSON.stringify(products));
        }
        
        // Load ALL transactions (tanpa limit)
        const txSnapshot = await firebaseDB.collection('transactions')
          .orderBy('timestamp', 'desc')
          .get();
        
        const fbTransactions = [];
        txSnapshot.forEach(doc => {
          const data = doc.data();
          fbTransactions.push({
            id: doc.id,
            items: data.items,
            total: data.total,
            payment: data.payment,
            date: data.date
          });
        });
        
        if (fbTransactions.length > 0) {
          transactions = fbTransactions;
          localStorage.setItem('nuri_transactions', JSON.stringify(transactions));
        }
        
        // Load ALL invoices (tanpa limit)
        const invSnapshot = await firebaseDB.collection('invoices')
          .orderBy('timestamp', 'desc')
          .get();
        
        const fbInvoices = [];
        invSnapshot.forEach(doc => {
          const data = doc.data();
          fbInvoices.push({
            id: doc.id,
            items: data.items,
            total: data.total,
            payment: data.payment,
            date: data.date
          });
        });
        
        if (fbInvoices.length > 0) {
          invoices = fbInvoices;
          localStorage.setItem('nuri_invoices', JSON.stringify(invoices));
        }
        
        // Refresh UI
        renderProducts();
        renderTransactions();
        renderInvoices();
        refreshDashboard();
        
        showFirebaseStatus(`‚úì Berhasil restore ${fbProducts.length} produk, ${fbTransactions.length} transaksi, ${fbInvoices.length} invoice`, 'success');
        
        showNotification(`‚úÖ Restore berhasil!\n\nüì¶ ${fbProducts.length} Produk\nüí∞ ${fbTransactions.length} Transaksi\nüìÑ ${fbInvoices.length} Invoice`);
        
        console.log(`Restored: ${fbProducts.length} products, ${fbTransactions.length} transactions, ${fbInvoices.length} invoices`);
      } catch (error) {
        showFirebaseStatus('‚ùå Error restore: ' + error.message, 'error');
        console.error('Restore error:', error);
      }
    }
    
    function showFirebaseStatus(message, type) {
      const el = document.getElementById('firebaseStatus');
      el.style.display = 'block';
      el.textContent = message;
      
      const colors = {
        success: { bg: '#d1fae5', text: '#065f46', border: '#10b981' },
        error: { bg: '#fee2e2', text: '#991b1b', border: '#ef4444' },
        warning: { bg: '#fef3c7', text: '#92400e', border: '#f59e0b' },
        loading: { bg: '#dbeafe', text: '#1e40af', border: '#3b82f6' }
      };
      
      const c = colors[type] || colors.loading;
      el.style.background = c.bg;
      el.style.color = c.text;
      el.style.border = '1px solid ' + c.border;
      
      setTimeout(() => { el.style.display = 'none'; }, 5000);
    }
    
    function loadFirebaseConfig() {
      const configStr = localStorage.getItem('firebase_config');
      if (configStr) {
        try {
          const config = JSON.parse(configStr);
          document.getElementById('firebaseApiKey').value = config.apiKey || '';
          document.getElementById('firebaseAuthDomain').value = config.authDomain || '';
          document.getElementById('firebaseProjectId').value = config.projectId || '';
          document.getElementById('firebaseStorageBucket').value = config.storageBucket || '';
          document.getElementById('firebaseMessagingSenderId').value = config.messagingSenderId || '';
          document.getElementById('firebaseAppId').value = config.appId || '';
        } catch (e) {}
      }
    }

    // ============================================
    // PRICE LIST
    // ============================================

    let priceListStatus = JSON.parse(localStorage.getItem('nuri_pricelist_status') || '{}');
    let currentPlDesign = parseInt(localStorage.getItem('nuri_pricelist_design') || '1');
    // Urutan kustom produk: array of product IDs
    let plCustomOrder = JSON.parse(localStorage.getItem('nuri_pricelist_order') || '[]');

    function savePlOrder() {
      localStorage.setItem('nuri_pricelist_order', JSON.stringify(plCustomOrder));
    }

    function resetPlOrder() {
      plCustomOrder = [];
      savePlOrder();
      renderPriceList();
    }

    // Kembalikan produk visible diurutkan sesuai plCustomOrder
    function getOrderedVisible() {
      const visible = products.filter(p => getStatusInfo(p.id).status !== 'hidden');
      if (plCustomOrder.length === 0) return visible;
      const idxMap = {};
      plCustomOrder.forEach((id, i) => idxMap[id] = i);
      return [...visible].sort((a, b) => {
        const ia = idxMap[a.id] ?? 99999;
        const ib = idxMap[b.id] ?? 99999;
        return ia - ib;
      });
    }

    function savePriceListStatus() {
      localStorage.setItem('nuri_pricelist_status', JSON.stringify(priceListStatus));
    }

    function openPriceList() {
      const logoUrl = localStorage.getItem('nuri_logo');
      const plLogo = document.getElementById('plLogoImg');
      if (logoUrl && plLogo) { plLogo.src = logoUrl; plLogo.style.display = 'block'; }
      else if (plLogo) { plLogo.style.display = 'none'; }
      renderPriceList();
      document.getElementById('priceListModal').classList.add('show');
    }

    function closePriceList() {
      closeAllStatusPickers();
      document.getElementById('priceListModal').classList.remove('show');
    }

    function getStatusInfo(productId) {
      return priceListStatus[productId] || { status: 'ready', qty: 1 };
    }

    function statusLabel(info) {
      if (info.status === 'sisa')   return `Sisa ${info.qty}`;
      if (info.status === 'hidden') return 'Tersembunyi';
      return { ready:'Ready', preorder:'Preorder', habis:'Habis' }[info.status] || 'Ready';
    }

    function statusClass(info) {
      return `pl-status-${['ready','preorder','habis','sisa','hidden'].includes(info.status) ? info.status : 'ready'}`;
    }

    // ‚îÄ‚îÄ Drag-and-drop state ‚îÄ‚îÄ
    let _plDragSrcId = null;

    function buildPlCard(p, isHidden) {
      const info = getStatusInfo(p.id);
      const card = document.createElement('div');
      card.className = 'pl-card' + (isHidden ? ' pl-card-hidden' : '');
      card.id = `pl-card-${p.id}`;
      card.dataset.productId = p.id;

      if (!isHidden) {
        card.draggable = true;
        card.addEventListener('dragstart', _plOnDragStart);
        card.addEventListener('dragover',  _plOnDragOver);
        card.addEventListener('drop',      _plOnDrop);
        card.addEventListener('dragend',   _plOnDragEnd);
        card.addEventListener('dragleave', _plOnDragLeave);
      }

      const imgWrap = document.createElement('div');
      imgWrap.className = 'pl-img-wrap';

      // Drag handle ‚†ø ‚Äî hanya untuk visible
      if (!isHidden) {
        const handle = document.createElement('div');
        handle.className = 'pl-drag-handle';
        handle.textContent = '‚†ø';
        handle.title = 'Seret untuk mengatur urutan';
        imgWrap.appendChild(handle);
      }

      if (p.image) {
        const img = document.createElement('img');
        img.src = p.image; img.alt = p.name;
        img.onerror = function() { this.parentElement.innerHTML = '<div class="pl-img-placeholder">üì¶</div>'; };
        imgWrap.appendChild(img);
      } else {
        const ph = document.createElement('div');
        ph.className = 'pl-img-placeholder'; ph.textContent = 'üì¶';
        imgWrap.appendChild(ph);
      }

      const badge = document.createElement('span');
      badge.className = `pl-status-badge ${statusClass(info)}`;
      badge.textContent = statusLabel(info);
      badge.id = `pl-badge-${p.id}`;
      badge.onclick = (e) => { e.stopPropagation(); toggleStatusPicker(p.id); };
      imgWrap.appendChild(badge);
      card.appendChild(imgWrap);

      const infoDiv = document.createElement('div');
      infoDiv.className = 'pl-info';
      infoDiv.innerHTML = `<div class="pl-name">${p.name}</div><div class="pl-price">Rp ${p.price.toLocaleString('id-ID')}</div>`;
      card.appendChild(infoDiv);
      return card;
    }

    function _plOnDragStart(e) {
      _plDragSrcId = this.dataset.productId;
      this.classList.add('pl-dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', _plDragSrcId);
    }

    function _plOnDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      const target = e.currentTarget;
      if (target.dataset.productId !== _plDragSrcId) {
        document.querySelectorAll('.pl-drag-over').forEach(el => el.classList.remove('pl-drag-over'));
        target.classList.add('pl-drag-over');
      }
    }

    function _plOnDragLeave(e) {
      this.classList.remove('pl-drag-over');
    }

    function _plOnDrop(e) {
      e.preventDefault();
      const destId = this.dataset.productId;
      if (!_plDragSrcId || _plDragSrcId === destId) return;

      // Buat ordered list terbaru
      const ordered = getOrderedVisible();
      const srcIdx  = ordered.findIndex(p => String(p.id) === String(_plDragSrcId));
      const dstIdx  = ordered.findIndex(p => String(p.id) === String(destId));
      if (srcIdx < 0 || dstIdx < 0) return;

      // Pindahkan elemen
      const [moved] = ordered.splice(srcIdx, 1);
      ordered.splice(dstIdx, 0, moved);

      // Simpan urutan baru
      plCustomOrder = ordered.map(p => p.id);
      savePlOrder();

      // Re-render tanpa full reload
      renderPriceList();
    }

    function _plOnDragEnd(e) {
      document.querySelectorAll('.pl-dragging, .pl-drag-over').forEach(el => {
        el.classList.remove('pl-dragging', 'pl-drag-over');
      });
      _plDragSrcId = null;
    }

    function renderPriceList() {
      const grid       = document.getElementById('priceListGrid');
      const hiddenGrid = document.getElementById('plHiddenGrid');
      const accordion  = document.getElementById('plHiddenAccordion');
      const countEl    = document.getElementById('plHiddenCount');
      const emptyEl    = document.getElementById('priceListEmpty');

      grid.innerHTML = ''; hiddenGrid.innerHTML = '';

      if (products.length === 0) {
        emptyEl.style.display = 'block'; accordion.style.display = 'none'; return;
      }
      emptyEl.style.display = 'none';

      const visible = getOrderedVisible();
      const hidden  = products.filter(p => getStatusInfo(p.id).status === 'hidden');

      visible.forEach(p => grid.appendChild(buildPlCard(p, false)));
      hidden.forEach(p  => hiddenGrid.appendChild(buildPlCard(p, true)));

      accordion.style.display = hidden.length > 0 ? 'block' : 'none';
      if (countEl) countEl.textContent = hidden.length;
    }

        function togglePlHiddenAccordion() {
      const body    = document.getElementById('plHiddenBody');
      const chevron = document.getElementById('plHiddenChevron');
      const open = body.classList.toggle('open');
      chevron.textContent = open ? '‚ñ≤' : '‚ñº';
    }

    function closeAllStatusPickers() {
      document.querySelectorAll('.pl-status-picker').forEach(el => el.remove());
    }

    function toggleStatusPicker(productId) {
      const existing = document.getElementById(`pl-picker-${productId}`);
      if (existing) { existing.remove(); return; }
      closeAllStatusPickers();

      const badge = document.getElementById(`pl-badge-${productId}`);
      if (!badge) return;
      const info = getStatusInfo(productId);

      const picker = document.createElement('div');
      picker.className = 'pl-status-picker';
      picker.id = `pl-picker-${productId}`;

      const opts = [
        { key:'ready',    label:'Ready',       icon:'‚úÖ' },
        { key:'preorder', label:'Preorder',     icon:'üïê' },
        { key:'habis',    label:'Habis',        icon:'‚ùå' },
        { key:'hidden',   label:'Sembunyikan',  icon:'üôà' },
      ];
      opts.forEach(opt => {
        const row = document.createElement('div');
        row.className = 'pl-status-opt';
        row.innerHTML = `<span>${opt.icon}</span><span>${opt.label}</span>`;
        if (info.status === opt.key) row.style.fontWeight = 'bold';
        row.onclick = (e) => { e.stopPropagation(); setProductStatus(productId, opt.key, 1); };
        picker.appendChild(row);
      });

      const sisaRow = document.createElement('div');
      sisaRow.className = 'pl-sisa-input-row';
      const currentSisaQty = (info.status === 'sisa') ? info.qty : 1;
      sisaRow.innerHTML = `
        <span style="font-size:0.82em;">üì¶ Sisa</span>
        <input type="number" id="pl-sisa-qty-${productId}" min="1" max="999" value="${currentSisaQty}"
          onclick="event.stopPropagation()"
          style="${info.status==='sisa'?'border-color:#3b82f6;font-weight:bold;':''}">
        <button onclick="event.stopPropagation();applySisaStatus(${productId})">OK</button>
      `;
      picker.appendChild(sisaRow);
      badge.parentElement.appendChild(picker);

      setTimeout(() => {
        document.addEventListener('click', function handler(e) {
          if (!picker.contains(e.target) && e.target !== badge) {
            picker.remove();
            document.removeEventListener('click', handler);
          }
        });
      }, 10);
    }

    function applySisaStatus(productId) {
      const input = document.getElementById(`pl-sisa-qty-${productId}`);
      const qty = Math.max(1, parseInt(input?.value) || 1);
      setProductStatus(productId, 'sisa', qty);
    }

    function setProductStatus(productId, status, qty) {
      const oldStatus = getStatusInfo(productId).status;
      priceListStatus[productId] = { status, qty: qty || 1 };
      savePriceListStatus();
      closeAllStatusPickers();
      if (status === 'hidden' || oldStatus === 'hidden') {
        renderPriceList();
      } else {
        const info = priceListStatus[productId];
        const badge = document.getElementById(`pl-badge-${productId}`);
        if (badge) { badge.textContent = statusLabel(info); badge.className = `pl-status-badge ${statusClass(info)}`; }
        const card = document.getElementById(`pl-card-${productId}`);
        if (card) card.className = 'pl-card';
      }
    }

    // ============================================
    // PRICE LIST ‚Äî EXPORT HELPERS
    // ============================================

    function _plGetMeta() {
      return {
        logoUrl:    localStorage.getItem('nuri_logo'),
        storeName:  localStorage.getItem('nuri_store_name') || 'NURI SNACK',
        storePhone: localStorage.getItem('nuri_store_phone') || '',
        today:      new Date().toLocaleDateString('id-ID', {day:'2-digit',month:'long',year:'numeric'}),
        visible:    getOrderedVisible(),
      };
    }

    const _statusColors = { ready:'#16a34a', preorder:'#f59e0b', habis:'#ef4444', sisa:'#3b82f6' };

    function _makeImg(src, styles) {
      const img = document.createElement('img');
      img.src = src; img.crossOrigin = 'anonymous';
      Object.assign(img.style, styles);
      return img;
    }

    function _makeDiv(styles, html) {
      const d = document.createElement('div');
      if (styles) Object.assign(d.style, styles);
      if (html)   d.innerHTML = html;
      return d;
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // SHARED POSTER BUILDER (semua 3 desain)
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    // Pastikan Google Font Dancing Script dimuat di dokumen utama
    (function() {
      if (!document.getElementById('pl-gfont')) {
        const l = document.createElement('link');
        l.id = 'pl-gfont';
        l.rel = 'stylesheet';
        l.href = 'https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap';
        document.head.appendChild(l);
      }
    })();

    // SVG daun untuk sudut ‚Äî dikustomisasi per tema
    function _leafSVG_topRight(color, opacity=0.55) {
      return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200" style="position:absolute;top:0;right:0;width:190px;height:190px;pointer-events:none;">
        <g fill="${color}" opacity="${opacity}">
          <ellipse cx="160" cy="30" rx="38" ry="14" transform="rotate(-35 160 30)"/>
          <ellipse cx="140" cy="15" rx="30" ry="10" transform="rotate(-55 140 15)"/>
          <ellipse cx="175" cy="55" rx="42" ry="13" transform="rotate(-15 175 55)"/>
          <ellipse cx="125" cy="35" rx="36" ry="11" transform="rotate(-65 125 35)"/>
          <ellipse cx="155" cy="75" rx="38" ry="11" transform="rotate(5 155 75)"/>
          <ellipse cx="108" cy="55" rx="30" ry="9"  transform="rotate(-80 108 55)"/>
          <line x1="185" y1="10" x2="120" y2="90" stroke="${color}" stroke-width="1.5" opacity="0.6"/>
          <line x1="160" y1="5"  x2="105" y2="70" stroke="${color}" stroke-width="1"   opacity="0.4"/>
        </g>
      </svg>`;
    }

    function _leafSVG_bottomLeft(color, opacity=0.5) {
      return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200" style="position:absolute;bottom:0;left:0;width:180px;height:180px;pointer-events:none;">
        <g fill="${color}" opacity="${opacity}">
          <ellipse cx="40"  cy="170" rx="38" ry="13" transform="rotate(35 40 170)"/>
          <ellipse cx="60"  cy="185" rx="30" ry="10" transform="rotate(55 60 185)"/>
          <ellipse cx="20"  cy="145" rx="40" ry="12" transform="rotate(15 20 145)"/>
          <ellipse cx="75"  cy="165" rx="34" ry="11" transform="rotate(65 75 165)"/>
          <ellipse cx="22"  cy="120" rx="36" ry="10" transform="rotate(-5 22 120)"/>
          <ellipse cx="90"  cy="145" rx="28" ry="9"  transform="rotate(80 90 145)"/>
          <line x1="10"  y1="190" x2="85"  y2="110" stroke="${color}" stroke-width="1.5" opacity="0.6"/>
          <line x1="35"  y1="195" x2="95"  y2="120" stroke="${color}" stroke-width="1"   opacity="0.4"/>
        </g>
      </svg>`;
    }

    function _leafSVG_topLeft(color, opacity=0.45) {
      return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 160 160" style="position:absolute;top:0;left:0;width:140px;height:140px;pointer-events:none;">
        <g fill="${color}" opacity="${opacity}">
          <ellipse cx="40"  cy="30"  rx="34" ry="12" transform="rotate(35 40 30)"/>
          <ellipse cx="20"  cy="55"  rx="38" ry="11" transform="rotate(15 20 55)"/>
          <ellipse cx="60"  cy="18"  rx="28" ry="9"  transform="rotate(55 60 18)"/>
          <line x1="5" y1="5" x2="80" y2="85" stroke="${color}" stroke-width="1.5" opacity="0.5"/>
        </g>
      </svg>`;
    }

    function _leafSVG_bottomRight(color, opacity=0.45) {
      return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 160 160" style="position:absolute;bottom:0;right:0;width:140px;height:140px;pointer-events:none;">
        <g fill="${color}" opacity="${opacity}">
          <ellipse cx="120" cy="130" rx="34" ry="12" transform="rotate(-35 120 130)"/>
          <ellipse cx="140" cy="105" rx="38" ry="11" transform="rotate(-15 140 105)"/>
          <ellipse cx="100" cy="142" rx="28" ry="9"  transform="rotate(-55 100 142)"/>
          <line x1="155" y1="155" x2="80" y2="75" stroke="${color}" stroke-width="1.5" opacity="0.5"/>
        </g>
      </svg>`;
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // DESIGN CONFIGS (shared between poster & print)
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const _DESIGN_CFGS = {
      1: {
        bg:'#f7efe2',
        titleColor:'#5c3d1e', nameColor:'#3d2b15', priceColor:'#6b4a22', subtitleColor:'#8b6b43',
        dividerColor:'#dcc9b0', borderStripe:null,
        leaf1:'#c4a882', leaf2:'#b89a72', leafOpacity:0.55,
        badgeReady:'#3a6b2e', badgeHabis:'#8b2222', badgePreorder:'#7a6030', badgeSisa:'#4a5c3a',
        logoCircleBg:'rgba(255,255,255,0.6)', logoCircleBorder:'#c4a882',
        footerBg:null, footerColor:null,
      },
      2: {
        bg:'#e8f0d0', bgGradient:'linear-gradient(170deg,#edf5d5 0%,#d8ecb5 100%)',
        titleColor:'#c9a227', nameColor:'#2d4a12', priceColor:'#3a5c1a', subtitleColor:'#4a6a28',
        dividerColor:'#b8d48a', borderStripe:'linear-gradient(90deg,#c9a227,#e8d060,#c9a227)',
        leaf1:'#5a8c30', leaf2:'#4a7a28', leafOpacity:0.55,
        badgeReady:'#2d6a1e', badgeHabis:'#8b2222', badgePreorder:'#c9a227', badgeSisa:'#3a7a3a',
        logoCircleBg:'rgba(255,255,255,0.5)', logoCircleBorder:'#8ab84a',
        footerBg:null, footerColor:null,
      },
      3: {
        bg:'#f5e8e0', bgGradient:'linear-gradient(170deg,#f8ece5 0%,#edd8cc 100%)',
        titleColor:'#9b2c4e', nameColor:'#5c2035', priceColor:'#8b2848', subtitleColor:'#a0506a',
        dividerColor:'#e0c4b8', borderStripe:null,
        leaf1:'#d4857a', leaf2:'#c87060', leafOpacity:0.5,
        badgeReady:'#3a6b2e', badgeHabis:'#8b2222', badgePreorder:'#9b2c4e', badgeSisa:'#5c4a2a',
        logoCircleBg:'rgba(255,255,255,0.6)', logoCircleBorder:'#d4957a',
        footerBg:'#e8c8bc', footerColor:'#8b4a5a',
      },
    };

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // BUILDER HELPERS
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    // Build header element ‚Äî fully centered layout, reused by poster & print pages
    function _buildHeader(cfg, W) {
      const { logoUrl, storeName, storePhone } = _plGetMeta();
      const {
        bg, bgGradient, titleColor, subtitleColor,
        leaf1, leafOpacity, logoCircleBg, logoCircleBorder, borderStripe,
      } = cfg;

      const LOGO_SIZE = 64; // 75 * 0.85 ‚âà 64

      const hdr = document.createElement('div');
      hdr.style.cssText = `
        position:relative; width:${W}px; box-sizing:border-box;
        padding:18px 20px 14px; overflow:hidden;
        display:flex; flex-direction:column; align-items:center; gap:6px;
        background:${bgGradient || bg};
      `;

      // Leaf corners (absolute)
      const lTR = document.createElement('div');
      lTR.style.cssText = 'position:absolute;top:0;right:0;pointer-events:none;';
      lTR.innerHTML = _leafSVG_topRight(leaf1, leafOpacity);
      hdr.appendChild(lTR);

      const lTL = document.createElement('div');
      lTL.style.cssText = 'position:absolute;top:0;left:0;pointer-events:none;';
      lTL.innerHTML = _leafSVG_topLeft(leaf1, leafOpacity * 0.6);
      hdr.appendChild(lTL);

      // Top stripe (if any) ‚Äî as inner top line
      if (borderStripe) {
        const topLine = document.createElement('div');
        topLine.style.cssText = `position:absolute;top:0;left:0;width:100%;height:5px;background:${borderStripe};`;
        hdr.appendChild(topLine);
      }

      // Logo circle ‚Äî CENTERED
      const logoCircle = document.createElement('div');
      logoCircle.style.cssText = `
        width:${LOGO_SIZE}px; height:${LOGO_SIZE}px; border-radius:50%; flex-shrink:0;
        border:2px solid ${logoCircleBorder}; background:${logoCircleBg};
        display:flex; flex-direction:column; align-items:center; justify-content:center;
        overflow:hidden; position:relative; z-index:2; margin-top:${borderStripe?'5px':'0'};
      `;
      if (logoUrl) {
        const lImg = document.createElement('img');
        lImg.src = logoUrl; lImg.crossOrigin = 'anonymous';
        lImg.style.cssText = 'width:100%;height:100%;object-fit:cover;border-radius:50%;';
        logoCircle.appendChild(lImg);
      } else {
        logoCircle.innerHTML = `
          <svg viewBox="0 0 50 50" width="28" height="28" fill="${titleColor}" opacity="0.7">
            <path d="M25 5 C18 5 13 12 13 20 C13 28 18 35 25 45 C32 35 37 28 37 20 C37 12 32 5 25 5Z"/>
            <path d="M20 18 Q25 10 30 18 Q35 26 25 38 Q15 26 20 18Z" fill="${bg||'#fff'}" opacity="0.5"/>
          </svg>
          <div style="font-size:8px;font-weight:700;color:${titleColor};margin-top:2px;text-align:center;line-height:1.2;">${storeName}</div>
        `;
      }
      hdr.appendChild(logoCircle);

      // Store name (small, centered, below logo)
      const nameEl = document.createElement('div');
      nameEl.style.cssText = `font-size:11px;font-weight:700;color:${subtitleColor};letter-spacing:2px;text-align:center;position:relative;z-index:2;`;
      nameEl.textContent = storeName.toUpperCase();
      hdr.appendChild(nameEl);

      // "Price List" script title ‚Äî CENTERED
      const scriptTitle = document.createElement('div');
      scriptTitle.style.cssText = `
        font-family:'Dancing Script','Brush Script MT',cursive;
        font-size:56px; font-weight:700; color:${titleColor};
        line-height:1; letter-spacing:1px; text-align:center;
        position:relative; z-index:2;
      `;
      scriptTitle.textContent = 'Price List';
      hdr.appendChild(scriptTitle);

      // Subtitle "DAFTAR HARGA PRODUK" ‚Äî CENTERED with lines
      const subDiv = document.createElement('div');
      subDiv.style.cssText = `display:flex;align-items:center;justify-content:center;gap:8px;width:80%;position:relative;z-index:2;`;
      subDiv.innerHTML = `
        <span style="flex:1;height:1px;background:${subtitleColor};opacity:0.5;"></span>
        <span style="font-size:9px;letter-spacing:3px;color:${subtitleColor};font-weight:600;font-family:'Segoe UI',Tahoma,sans-serif;white-space:nowrap;">DAFTAR HARGA PRODUK</span>
        <span style="flex:1;height:1px;background:${subtitleColor};opacity:0.5;"></span>
      `;
      hdr.appendChild(subDiv);

      // Phone (if any)
      if (storePhone) {
        const phoneEl = document.createElement('div');
        phoneEl.style.cssText = `font-size:10px;color:${subtitleColor};opacity:0.75;text-align:center;position:relative;z-index:2;margin-bottom:4px;`;
        phoneEl.textContent = storePhone;
        hdr.appendChild(phoneEl);
      }

      return hdr;
    }

    // Build one row-group of products for the grid
    function _buildGridRows(cfg, W, productsSlice) {
      const { bg, nameColor, priceColor, dividerColor, borderStripe,
              badgeReady, badgeHabis, badgePreorder, badgeSisa } = cfg;
      const COLS = 4;
      const badgeColorMap = { ready:badgeReady, preorder:badgePreorder, habis:badgeHabis, sisa:badgeSisa };

      const gridWrap = document.createElement('div');
      gridWrap.style.cssText = `padding:0 18px; box-sizing:border-box; width:${W}px; background:${cfg.bgGradient||cfg.bg};`;

      const rows = [];
      for (let i = 0; i < productsSlice.length; i += COLS) rows.push(productsSlice.slice(i, i + COLS));

      rows.forEach(row => {
        const divider = document.createElement('div');
        divider.style.cssText = `height:1px;background:${dividerColor};margin:0 0 14px;`;
        gridWrap.appendChild(divider);

        const rowEl = document.createElement('div');
        rowEl.style.cssText = `display:grid;grid-template-columns:repeat(${COLS},1fr);gap:10px;margin-bottom:14px;`;

        row.forEach(p => {
          const info = getStatusInfo(p.id);
          const bColor = badgeColorMap[info.status] || badgeReady;
          const cell = document.createElement('div');
          cell.style.cssText = 'text-align:center;';

          const imgBox = document.createElement('div');
          imgBox.style.cssText = `width:100%;aspect-ratio:1/1;position:relative;overflow:visible;margin-bottom:7px;`;

          const imgInner = document.createElement('div');
          imgInner.style.cssText = `width:100%;height:100%;overflow:hidden;border-radius:4px;position:relative;`;
          if (p.image) {
            const img = document.createElement('img');
            img.src = p.image; img.crossOrigin = 'anonymous';
            img.style.cssText = 'width:100%;height:100%;object-fit:cover;display:block;';
            imgInner.appendChild(img);
          } else {
            imgInner.style.background = '#e8ddd0';
            imgInner.innerHTML = `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:2em;color:#c0b0a0;">üì¶</div>`;
          }
          imgBox.appendChild(imgInner);

          const bdg = document.createElement('div');
          bdg.style.cssText = `position:absolute;top:-4px;right:-4px;z-index:3;
            background:${bColor};color:white;font-size:9px;font-weight:700;
            padding:3px 8px;border-radius:3px;box-shadow:0 2px 5px rgba(0,0,0,0.2);white-space:nowrap;`;
          bdg.textContent = statusLabel(info);
          imgBox.appendChild(bdg);
          cell.appendChild(imgBox);

          cell.appendChild(Object.assign(document.createElement('div'), { innerHTML:`
            <div style="font-size:12px;font-weight:700;color:${nameColor};margin-bottom:3px;line-height:1.3;">${p.name}</div>
            <div style="font-size:12px;font-weight:600;color:${priceColor};">Rp ${p.price.toLocaleString('id-ID')}</div>
          `}));
          rowEl.appendChild(cell);
        });
        gridWrap.appendChild(rowEl);
      });

      // Final bottom divider
      const lastDiv = document.createElement('div');
      lastDiv.style.cssText = `height:1px;background:${dividerColor};margin:0 0 16px;`;
      gridWrap.appendChild(lastDiv);

      return gridWrap;
    }

    // Build bottom deco strip (leaves + optional footer)
    // ‚îÄ‚îÄ‚îÄ Koleksi kata mutiara makanan & rezeki ‚îÄ‚îÄ‚îÄ
    const _QUOTES = [
      { q: "Makanan yang baik adalah bahasa cinta yang paling jujur.",        a: "‚Äî Pepatah Bijak" },
      { q: "Rezeki tak selalu berupa harta; kadang ia hadir lewat sepiring hidangan hangat.",  a: "‚Äî Renungan Dapur" },
      { q: "Di setiap suapan tersimpan doa, di setiap sajian tersimpan kasih sayang.",         a: "‚Äî Filosofi Makan" },
      { q: "Jangan pernah meremehkan makanan sederhana; di situlah ketulusan paling nyata.",   a: "‚Äî Pepatah Nusantara" },
      { q: "Rezeki itu seperti aroma masakan ‚Äî ia menjangkau mereka yang berhati lapang.",     a: "‚Äî Kata Orang Bijak" },
      { q: "Meja makan yang penuh bukan tentang kelimpahan, melainkan tentang rasa syukur.",   a: "‚Äî Renungan Pagi" },
      { q: "Setiap bahan makanan menyimpan perjalanan panjang sebelum tiba di piringmu.",      a: "‚Äî Hikayat Dapur" },
      { q: "Makanan terlezat adalah yang disantap bersama orang-orang terkasih.",              a: "‚Äî Pepatah Bijak" },
      { q: "Rezeki yang baik bukan hanya yang banyak, tapi yang membawa berkah bagi sesama.", a: "‚Äî Nasihat Leluhur" },
      { q: "Dari dapur yang sederhana, lahir cita rasa yang menghangatkan jiwa.",              a: "‚Äî Filosofi Memasak" },
      { q: "Setiap gigitan adalah pertemuan antara alam dan tangan yang penuh cinta.",         a: "‚Äî Renungan Rasa" },
      { q: "Syukuri setiap rezeki, sekecil apa pun ‚Äî sebab di sanalah berkah bersembunyi.",   a: "‚Äî Nasihat Bijak" },
      { q: "Makanan yang dibuat dengan hati akan selalu terasa berbeda di lidah dan di jiwa.", a: "‚Äî Pepatah Dapur" },
      { q: "Rezeki itu mengalir seperti air ‚Äî ia mencari celah bagi mereka yang tekun.",       a: "‚Äî Filosofi Hidup" },
      { q: "Berbagi makanan adalah cara paling sederhana untuk mengatakan: kau berharga bagiku.", a: "‚Äî Kata Mutiara" },
      { q: "Di balik setiap sajian yang nikmat, ada tangan yang bekerja dengan penuh keikhlasan.", a: "‚Äî Renungan Dapur" },
    ];

    // Ambil quote acak ‚Äî konsisten dalam satu sesi render (seed dari tanggal)
    function _getRandomQuote() {
      const seed = new Date().getDate() + new Date().getHours();
      return _QUOTES[seed % _QUOTES.length];
    }

    function _buildBottomDeco(cfg, W) {
      const { storeName, today } = _plGetMeta();
      const { leaf2, leafOpacity, footerBg, footerColor, dividerColor, bgGradient, bg, titleColor, subtitleColor } = cfg;

      // Warna footer: gunakan footerBg kalau ada, fallback ke warna tema
      const fBg    = footerBg    || (bgGradient ? bg : bg);
      const fColor = footerColor || subtitleColor;
      const quote  = _getRandomQuote();

      const frag = document.createElement('div');
      frag.style.cssText = `width:${W}px; background:${bgGradient||bg};`;

      // Daun dekoratif bawah
      const decoStrip = document.createElement('div');
      decoStrip.style.cssText = `position:relative;height:60px;overflow:hidden;background:${bgGradient||bg};`;
      decoStrip.innerHTML = _leafSVG_bottomLeft(leaf2, leafOpacity * 0.9) + _leafSVG_bottomRight(leaf2, leafOpacity * 0.7);
      frag.appendChild(decoStrip);

      // Garis pemisah tipis
      const hr = document.createElement('div');
      hr.style.cssText = `height:1px;background:${dividerColor};margin:0 22px 0;opacity:0.7;`;
      frag.appendChild(hr);

      // Footer dengan quote
      const footer = document.createElement('div');
      footer.style.cssText = `
        background:${fBg}; padding:14px 28px 16px;
        text-align:center; box-sizing:border-box;
      `;

      // Ornamen pembuka
      const ornament = document.createElement('div');
      ornament.style.cssText = `font-size:14px; color:${fColor}; opacity:0.4; margin-bottom:6px; letter-spacing:8px;`;
      ornament.textContent = '‚ú¶ ‚ú¶ ‚ú¶';
      footer.appendChild(ornament);

      // Teks quote
      const quoteEl = document.createElement('div');
      quoteEl.style.cssText = `
        font-family:'Dancing Script','Brush Script MT',cursive;
        font-size:15px; color:${titleColor}; line-height:1.6;
        font-style:italic; margin-bottom:4px;
      `;
      quoteEl.textContent = `"${quote.q}"`;
      footer.appendChild(quoteEl);

      // Atribusi
      const attrEl = document.createElement('div');
      attrEl.style.cssText = `font-size:9px; color:${fColor}; letter-spacing:2px; opacity:0.75; margin-bottom:10px;`;
      attrEl.textContent = quote.a;
      footer.appendChild(attrEl);

      // Garis pemisah kecil
      const sep = document.createElement('div');
      sep.style.cssText = `width:40px; height:1px; background:${fColor}; opacity:0.3; margin:0 auto 8px;`;
      footer.appendChild(sep);

      // Info toko & tanggal
      const infoEl = document.createElement('div');
      infoEl.style.cssText = `font-size:8.5px; color:${fColor}; letter-spacing:2px; opacity:0.65;`;
      infoEl.textContent = `${storeName.toUpperCase()} ¬∑ ${today} ¬∑ Harga dapat berubah sewaktu-waktu`;
      footer.appendChild(infoEl);

      frag.appendChild(footer);
      return frag;
    }

    // Build bottom border stripe
    function _buildBottomStripe(cfg, W) {
      if (!cfg.borderStripe) return null;
      const el = document.createElement('div');
      el.style.cssText = `height:5px;background:${cfg.borderStripe};width:${W}px;`;
      return el;
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // POSTER (for download/preview) ‚Äî single block
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function _buildPoster(cfg) {
      const { visible } = _plGetMeta();
      const W = 620;

      const wrap = document.createElement('div');
      wrap.style.cssText = `width:${W}px;position:relative;overflow:hidden;box-sizing:border-box;
        background:${cfg.bgGradient||cfg.bg};font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;`;

      if (cfg.borderStripe) {
        const s = document.createElement('div');
        s.style.cssText = `height:5px;background:${cfg.borderStripe};width:100%;`;
        wrap.appendChild(s);
      }

      wrap.appendChild(_buildHeader(cfg, W));
      wrap.appendChild(_buildGridRows(cfg, W, visible));
      wrap.appendChild(_buildBottomDeco(cfg, W));
      if (cfg.borderStripe) {
        const s2 = document.createElement('div');
        s2.style.cssText = `height:5px;background:${cfg.borderStripe};width:100%;`;
        wrap.appendChild(s2);
      }
      return wrap;
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // PRINT DOCUMENT ‚Äî multi-page A4 with repeated header
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function _buildPrintDocument(designNum) {
      const cfg = _DESIGN_CFGS[designNum] || _DESIGN_CFGS[1];
      const { visible } = _plGetMeta();

      const COLS = 4;
      const ROWS_PER_PAGE = 3;   // 3 baris √ó 4 kolom = 12 produk/halaman
      const PRODS_PER_PAGE = COLS * ROWS_PER_PAGE;

      // Split products into page chunks
      const chunks = [];
      for (let i = 0; i < visible.length; i += PRODS_PER_PAGE) {
        chunks.push(visible.slice(i, i + PRODS_PER_PAGE));
      }
      if (chunks.length === 0) chunks.push([]); // empty state

      const pagesHtml = chunks.map((chunk, idx) => {
        const isLast = idx === chunks.length - 1;
        const W = 620;

        const page = document.createElement('div');
        page.style.cssText = `
          width:${W}px; box-sizing:border-box; overflow:hidden;
          background:${cfg.bgGradient||cfg.bg};
          font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
          page-break-after:${isLast?'avoid':'always'};
          break-after:${isLast?'avoid':'page'};
        `;

        if (cfg.borderStripe) {
          const s = document.createElement('div');
          s.style.cssText = `height:5px;background:${cfg.borderStripe};width:100%;`;
          page.appendChild(s);
        }

        page.appendChild(_buildHeader(cfg, W));
        page.appendChild(_buildGridRows(cfg, W, chunk));

        // Footer di setiap halaman
        page.appendChild(_buildBottomDeco(cfg, W));
        if (cfg.borderStripe) {
          const s2 = document.createElement('div');
          s2.style.cssText = `height:5px;background:${cfg.borderStripe};width:100%;`;
          page.appendChild(s2);
        }

        return page.outerHTML;
      }).join('\n');

      return pagesHtml;
    }

    function _buildDesign1() { return _buildPoster(_DESIGN_CFGS[1]); }
    function _buildDesign2() { return _buildPoster(_DESIGN_CFGS[2]); }
    function _buildDesign3() { return _buildPoster(_DESIGN_CFGS[3]); }

    function printPriceList() {
      const pagesHtml = _buildPrintDocument(currentPlDesign);
      const w = window.open('','_blank','width=860,height=700');
      w.document.write(`<!DOCTYPE html><html><head><title>Price List</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
        <style>
          *{margin:0;padding:0;box-sizing:border-box;}
          body{background:#fff; display:flex; flex-direction:column; align-items:center;}
          @page{size:A4 portrait; margin:8mm;}
          @media print{
            body{-webkit-print-color-adjust:exact; print-color-adjust:exact;}
          }
        </style>
        </head><body>${pagesHtml}</body></html>`);
      w.document.close();
      setTimeout(() => { w.focus(); w.print(); }, 2000);
    }

    function buildExportContainer() {
      if (currentPlDesign === 2) return _buildDesign2();
      if (currentPlDesign === 3) return _buildDesign3();
      return _buildDesign1();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CANVAS RENDERER ‚Äî tanpa html2canvas, 100% aman di file://
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // Load gambar dari src (data URL / blob URL / path)
    function _loadImg(src) {
      return new Promise(resolve => {
        if (!src) { resolve(null); return; }
        const img = new Image();
        img.onload  = () => resolve(img);
        img.onerror = () => resolve(null);
        img.src = src;
      });
    }

    // Rounded rect path
    function _rrect(ctx, x, y, w, h, r) {
      ctx.beginPath();
      ctx.moveTo(x + r, y);
      ctx.arcTo(x + w, y,     x + w, y + h, r);
      ctx.arcTo(x + w, y + h, x,     y + h, r);
      ctx.arcTo(x,     y + h, x,     y,     r);
      ctx.arcTo(x,     y,     x + w, y,     r);
      ctx.closePath();
    }

    // Ellipse-based leaf cluster per sudut
    function _drawLeafCorner(ctx, corner, W, H, color, opacity) {
      ctx.save(); ctx.globalAlpha = opacity; ctx.fillStyle = color;
      const defs = {
        tr: [
          [W-40,20, 38,14, -35],[W-60,8,  30,10, -55],[W-25,45,42,13,-15],
          [W-90,25, 36,11, -65],[W-45,65, 38,11,   5],
        ],
        tl: [
          [40,30, 34,12, 35],[20,55, 38,11, 15],[60,18, 28,9, 55],
        ],
        bl: [
          [40,H-30, 38,13, 35],[60,H-15,30,10,55],[20,H-55,40,12,15],
          [75,H-35, 34,11, 65],[22,H-80,36,10, -5],
        ],
        br: [
          [W-40,H-30,34,12,-35],[W-20,H-55,38,11,-15],[W-60,H-18,28,9,-55],
        ],
      };
      (defs[corner]||[]).forEach(([cx,cy,rx,ry,deg])=>{
        ctx.save();
        ctx.translate(cx,cy);
        ctx.rotate(deg*Math.PI/180);
        ctx.beginPath();
        ctx.ellipse(0,0,rx,ry,0,0,Math.PI*2);
        ctx.fill();
        ctx.restore();
      });
      ctx.restore();
    }

    // Bungkus teks, kembalikan jumlah baris
    function _wrapText(ctx, text, cx, y, maxW, lineH) {
      const words = text.split(' ');
      let line = '', lines = [];
      for (const w of words) {
        const t = line ? line+' '+w : w;
        if (ctx.measureText(t).width > maxW && line) { lines.push(line); line = w; }
        else line = t;
      }
      if (line) lines.push(line);
      lines.forEach((l,i) => ctx.fillText(l, cx, y + i*lineH));
      return lines.length;
    }

    // Render poster ke canvas (single page, bukan multi-page)
    async function _renderToCanvas(designNum) {
      const cfg = _DESIGN_CFGS[designNum] || _DESIGN_CFGS[1];
      const { logoUrl, storeName, storePhone, today, visible } = _plGetMeta();
      const quote = _getRandomQuote();

      // Pastikan font kursif siap
      try { await document.fonts.load('bold 56px "Dancing Script"'); } catch(e) {}

      const SC   = 2;           // scale 2√ó untuk ketajaman
      const W    = 620;
      const PAD  = 18;
      const COLS = 4;
      const CGAP = 10;
      const CW   = Math.floor((W - PAD*2 - CGAP*(COLS-1)) / COLS); // lebar tiap kolom ~136px
      const IH   = CW;          // gambar persegi
      const CH   = IH + 54;     // tinggi cell (gambar + teks)

      const STRIPE  = cfg.borderStripe ? 5 : 0;
      const HDR_H   = 215;
      const rows    = Math.ceil(visible.length / COLS) || 1;
      const GRID_H  = rows*(CH + 16) + 16;    // setiap baris: divider(1)+margin(15)+cell + baris terakhir+16
      const FTR_H   = 165;
      const TOTAL_H = STRIPE*2 + HDR_H + GRID_H + FTR_H;

      const cvs = document.createElement('canvas');
      cvs.width  = W  * SC;
      cvs.height = TOTAL_H * SC;
      const ctx = cvs.getContext('2d');
      ctx.scale(SC, SC);

      // Preload semua gambar
      const logoImg = await _loadImg(logoUrl);
      const pImgs   = await Promise.all(visible.map(p => _loadImg(p.image)));

      let y = 0;

      // ‚îÄ‚îÄ Background
      const bgParsed = (cfg.bgGradient||'').match(/#[0-9a-fA-F]{3,6}/g) || [];
      if (bgParsed.length >= 2) {
        const g = ctx.createLinearGradient(0,0, W*0.3,TOTAL_H);
        g.addColorStop(0, bgParsed[0]);
        g.addColorStop(1, bgParsed[bgParsed.length-1]);
        ctx.fillStyle = g;
      } else {
        ctx.fillStyle = cfg.bg || '#f7efe2';
      }
      ctx.fillRect(0, 0, W, TOTAL_H);

      // ‚îÄ‚îÄ Top stripe
      if (cfg.borderStripe) {
        const sc = (cfg.borderStripe.match(/#[0-9a-fA-F]{3,6}/g)||['#c9a227']);
        const sg = ctx.createLinearGradient(0,0,W,0);
        sg.addColorStop(0, sc[0]); sg.addColorStop(0.5, sc[Math.floor(sc.length/2)]||sc[0]); sg.addColorStop(1, sc[sc.length-1]);
        ctx.fillStyle = sg; ctx.fillRect(0, y, W, STRIPE); y += STRIPE;
      }

      // ‚îÄ‚îÄ Leaf top corners
      _drawLeafCorner(ctx, 'tr', W, HDR_H, cfg.leaf1, cfg.leafOpacity);
      _drawLeafCorner(ctx, 'tl', W, HDR_H, cfg.leaf1, cfg.leafOpacity * 0.55);

      // ‚îÄ‚îÄ Logo lingkaran di tengah
      const LR  = 32;   // radius logo (64px diameter = -15% dari 75px)
      const LCX = W / 2;
      const LCY = y + 20 + LR;

      ctx.beginPath(); ctx.arc(LCX, LCY, LR, 0, Math.PI*2);
      ctx.fillStyle   = cfg.logoCircleBg || 'rgba(255,255,255,0.6)'; ctx.fill();
      ctx.strokeStyle = cfg.logoCircleBorder || '#c4a882'; ctx.lineWidth = 2; ctx.stroke();

      if (logoImg) {
        ctx.save(); ctx.beginPath(); ctx.arc(LCX, LCY, LR-1, 0, Math.PI*2); ctx.clip();
        ctx.drawImage(logoImg, LCX-LR+1, LCY-LR+1, (LR-1)*2, (LR-1)*2);
        ctx.restore();
      } else {
        ctx.font = 'bold 13px Segoe UI'; ctx.fillStyle = cfg.titleColor||'#5c3d1e';
        ctx.globalAlpha = 0.7; ctx.textAlign = 'center';
        ctx.fillText(storeName.substring(0,2).toUpperCase(), LCX, LCY+5); ctx.globalAlpha = 1;
      }

      y = LCY + LR + 10;

      // ‚îÄ‚îÄ Nama toko (kecil, kapital)
      ctx.font = 'bold 10px Segoe UI, Tahoma, sans-serif';
      ctx.fillStyle = cfg.subtitleColor; ctx.textAlign = 'center';
      ctx.fillText(storeName.toUpperCase(), W/2, y+10); y += 18;

      // ‚îÄ‚îÄ "Price List" kursif
      ctx.font = 'bold 56px "Dancing Script", "Brush Script MT", cursive';
      ctx.fillStyle = cfg.titleColor; ctx.textAlign = 'center';
      ctx.fillText('Price List', W/2, y+52); y += 62;

      // ‚îÄ‚îÄ "DAFTAR HARGA PRODUK" + garis
      ctx.font = '600 9px Segoe UI, Tahoma, sans-serif';
      ctx.fillStyle = cfg.subtitleColor; ctx.textAlign = 'center';
      const subW = ctx.measureText('DAFTAR HARGA PRODUK').width;
      const lineX1 = PAD + 4;
      const lineX2 = W/2 + subW/2 + 10;
      const lineLen = W/2 - subW/2 - 10 - lineX1;
      ctx.globalAlpha = 0.45;
      ctx.fillRect(lineX1, y+4, lineLen, 1);
      ctx.fillRect(lineX2, y+4, lineLen, 1);
      ctx.globalAlpha = 1;
      ctx.fillText('DAFTAR HARGA PRODUK', W/2, y+9); y += 18;

      // ‚îÄ‚îÄ No HP
      if (storePhone) {
        ctx.font = '9px Segoe UI'; ctx.fillStyle = cfg.subtitleColor;
        ctx.globalAlpha = 0.7; ctx.textAlign = 'center';
        ctx.fillText(storePhone, W/2, y+9); ctx.globalAlpha = 1; y += 14;
      }

      // Paksa ke batas header
      y = STRIPE + HDR_H;

      // ‚îÄ‚îÄ Grid produk
      const badgeMap = {
        ready:    cfg.badgeReady,
        habis:    cfg.badgeHabis,
        preorder: cfg.badgePreorder,
        sisa:     cfg.badgeSisa,
      };

      for (let row = 0; row < rows; row++) {
        // Divider baris
        ctx.globalAlpha = 0.65; ctx.fillStyle = cfg.dividerColor;
        ctx.fillRect(PAD, y, W-PAD*2, 1); ctx.globalAlpha = 1; y += 15;

        for (let col = 0; col < COLS; col++) {
          const idx = row*COLS + col;
          if (idx >= visible.length) break;
          const p    = visible[idx];
          const info = getStatusInfo(p.id);
          const px   = PAD + col*(CW+CGAP);

          // Gambar produk
          if (pImgs[idx]) {
            ctx.save();
            _rrect(ctx, px, y, CW, IH, 4); ctx.clip();
            ctx.drawImage(pImgs[idx], px, y, CW, IH);
            ctx.restore();
          } else {
            ctx.fillStyle = '#e8ddd0'; _rrect(ctx, px, y, CW, IH, 4); ctx.fill();
            ctx.font='24px serif'; ctx.textAlign='center';
            ctx.fillText('üì¶', px+CW/2, y+IH/2+8);
          }

          // Badge status
          const bLabel = statusLabel(info);
          const bColor = badgeMap[info.status] || badgeMap.ready;
          ctx.font = 'bold 8.5px Segoe UI, sans-serif';
          const bW = ctx.measureText(bLabel).width + 12;
          const bH = 15;
          const bX = px + CW - bW - 2;
          const bY = y - 3;
          _rrect(ctx, bX, bY, bW, bH, 3);
          ctx.fillStyle = bColor; ctx.fill();
          ctx.fillStyle = 'white'; ctx.textAlign = 'center';
          ctx.fillText(bLabel, bX+bW/2, bY+10.5);

          // Nama produk
          ctx.font = 'bold 10.5px Segoe UI, Tahoma, sans-serif';
          ctx.fillStyle = cfg.nameColor; ctx.textAlign = 'center';
          const nLines = _wrapText(ctx, p.name, px+CW/2, y+IH+12, CW-4, 13);

          // Harga
          ctx.font = '600 10.5px Segoe UI, Tahoma, sans-serif';
          ctx.fillStyle = cfg.priceColor; ctx.textAlign = 'center';
          ctx.fillText('Rp '+p.price.toLocaleString('id-ID'), px+CW/2, y+IH+12+nLines*13+2);
        }
        y += CH;
      }

      // Divider bawah grid
      ctx.globalAlpha = 0.65; ctx.fillStyle = cfg.dividerColor;
      ctx.fillRect(PAD, y, W-PAD*2, 1); ctx.globalAlpha = 1; y += 16;

      // ‚îÄ‚îÄ Daun bawah
      const blY = y + 60;
      _drawLeafCorner(ctx, 'bl', W, blY, cfg.leaf2, cfg.leafOpacity * 0.9);
      _drawLeafCorner(ctx, 'br', W, blY, cfg.leaf2, cfg.leafOpacity * 0.7);
      y += 62;

      // HR footer
      ctx.globalAlpha = 0.5; ctx.fillStyle = cfg.dividerColor;
      ctx.fillRect(PAD, y, W-PAD*2, 1); ctx.globalAlpha = 1; y += 14;

      // Ornamen
      ctx.font = '11px serif'; ctx.fillStyle = cfg.subtitleColor;
      ctx.globalAlpha = 0.4; ctx.textAlign = 'center';
      ctx.fillText('‚ú¶  ‚ú¶  ‚ú¶', W/2, y+11); ctx.globalAlpha = 1; y += 22;

      // Quote
      ctx.font = 'italic bold 14px "Dancing Script", cursive';
      ctx.fillStyle = cfg.titleColor; ctx.textAlign = 'center';
      const qLines = _wrapText(ctx, `"${quote.q}"`, W/2, y+14, W-PAD*4, 18);
      y += qLines*18 + 6;

      // Atribusi
      ctx.font = '8.5px Segoe UI, sans-serif'; ctx.fillStyle = cfg.subtitleColor;
      ctx.globalAlpha = 0.72; ctx.textAlign = 'center';
      ctx.fillText(quote.a, W/2, y+9); ctx.globalAlpha = 1; y += 18;

      // Garis kecil
      ctx.fillStyle = cfg.subtitleColor; ctx.globalAlpha = 0.28;
      ctx.fillRect(W/2-20, y, 40, 1); ctx.globalAlpha = 1; y += 11;

      // Info toko
      ctx.font = '8px Segoe UI, sans-serif'; ctx.fillStyle = cfg.subtitleColor;
      ctx.globalAlpha = 0.62; ctx.textAlign = 'center';
      ctx.fillText(`${storeName.toUpperCase()} ¬∑ ${today} ¬∑ Harga dapat berubah sewaktu-waktu`, W/2, y+9);
      ctx.globalAlpha = 1;

      // ‚îÄ‚îÄ Bottom stripe
      if (cfg.borderStripe) {
        const sc2 = (cfg.borderStripe.match(/#[0-9a-fA-F]{3,6}/g)||['#c9a227']);
        const sg2  = ctx.createLinearGradient(0,0,W,0);
        sg2.addColorStop(0, sc2[0]); sg2.addColorStop(1, sc2[sc2.length-1]);
        ctx.fillStyle = sg2; ctx.fillRect(0, TOTAL_H-STRIPE, W, STRIPE);
      }

      return cvs;
    }

    // Download via Blob (aman di semua OS/browser)
    function _blobDownload(blob, filename) {
      if (!blob || blob.size === 0) { alert('File kosong, coba lagi.'); return; }
      const url = URL.createObjectURL(blob);
      const a   = Object.assign(document.createElement('a'), { href:url, download:filename });
      document.body.appendChild(a); a.click();
      setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 3000);
    }

    async function downloadPriceList(format) {
      const btn = event.target;
      const origText = btn.textContent;
      btn.textContent = '‚è≥ ...'; btn.disabled = true;
      try {
        const cvs = await _renderToCanvas(currentPlDesign);
        const storeName = localStorage.getItem('nuri_store_name') || 'NURI SNACK';
        const sn  = storeName.replace(/\s+/g,'_');
        const fn  = `${sn}_PriceList_${new Date().toISOString().slice(0,10)}`;

        if (format === 'png') {
          // Render semua 3 desain sekaligus, kirim ke tab baru
          btn.textContent = '‚è≥ Rendering...';
          const [cvs1, cvs2, cvs3] = await Promise.all([
            _renderToCanvas(1), _renderToCanvas(2), _renderToCanvas(3)
          ]);
          const urls = [
            cvs1.toDataURL('image/png', 1),
            cvs2.toDataURL('image/png', 1),
            cvs3.toDataURL('image/png', 1),
          ];
          const themes = [
            { key:'1', label:'üåæ', name:'Bohemian Beige' },
            { key:'2', label:'üåø', name:'Natural Green'  },
            { key:'3', label:'üå∏', name:'Rose Blush'     },
          ];
          const initIdx = currentPlDesign - 1;

          // Kumpulkan data produk untuk carousel
          const { visible } = _plGetMeta();
          const carouselProds = visible.map(p => {
            const info = getStatusInfo(p.id);
            const cfg  = _DESIGN_CFGS[currentPlDesign] || _DESIGN_CFGS[1];
            const colorMap = { ready:cfg.badgeReady, preorder:cfg.badgePreorder, habis:cfg.badgeHabis, sisa:cfg.badgeSisa };
            return {
              name:        p.name,
              price:       'Rp ' + p.price.toLocaleString('id-ID'),
              statusLabel: statusLabel(info),
              statusColor: colorMap[info.status] || cfg.badgeReady,
              image:       p.image || null,
            };
          });

          // Config warna tiap tema (bg, title, subtitle, divider, leaf)
          const themeCfgs = [
            { bg:'#f7efe2', bgEnd:'#ede0ce', title:'#5c3d1e', sub:'#8b6b43', leaf:'#c4a882', div:'#dcc9b0' },
            { bg:'#edf5d5', bgEnd:'#d8ecb5', title:'#c9a227', sub:'#4a6a28', leaf:'#5a8c30', div:'#b8d48a' },
            { bg:'#f8ece5', bgEnd:'#edd8cc', title:'#9b2c4e', sub:'#a0506a', leaf:'#d4857a', div:'#e0c4b8' },
          ];

          const w = window.open('', '_blank');
          if (!w) { alert('Izinkan pop-up lalu coba lagi.'); return; }

          const urlsJson      = JSON.stringify(urls);
          const themesJson    = JSON.stringify(themes);
          const prodsJson     = JSON.stringify(carouselProds);
          const themeCfgsJson = JSON.stringify(themeCfgs);

          w.document.write(`<!DOCTYPE html><html>
            <head>
              <title>${fn}.png</title>
              <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
              <style>
                *{margin:0;padding:0;box-sizing:border-box;}
                body{
                  background:#111; min-height:100vh;
                  display:flex; flex-direction:column;
                  align-items:center; padding:18px 16px 32px;
                  gap:14px; font-family:Segoe UI,Tahoma,sans-serif;
                  transition: background .3s;
                }
                /* ‚îÄ‚îÄ Selector bars ‚îÄ‚îÄ */
                #theme-bar, #style-bar{ display:flex; gap:6px; align-items:center; flex-wrap:wrap; justify-content:center; }
                .t-btn{
                  display:flex; align-items:center; gap:6px;
                  padding:7px 16px; border-radius:20px; border:2px solid #444;
                  background:#222; color:#bbb; font-size:13px; font-weight:600;
                  cursor:pointer; transition:all .18s;
                }
                .t-btn:hover{ border-color:#888; color:#fff; background:#2a2a2a; }
                .t-btn.active{
                  border-color:#22c55e; color:#fff;
                  background:linear-gradient(135deg,#166534,#22c55e);
                  box-shadow:0 2px 12px rgba(34,197,94,0.35);
                }
                .s-btn{
                  padding:5px 12px; border-radius:20px; border:1px solid #333;
                  background:#1a1a1a; color:#777; font-size:11px; font-weight:600;
                  cursor:pointer; transition:all .18s; letter-spacing:.3px;
                }
                .s-btn:hover{ border-color:#666; color:#ccc; }
                .s-btn.active{
                  border-color:#a78bfa; color:#fff;
                  background:linear-gradient(135deg,#4c1d95,#7c3aed);
                  box-shadow:0 2px 10px rgba(124,58,237,0.35);
                }
                /* ‚îÄ‚îÄ Wrap gambar ‚îÄ‚îÄ */
                .wrap{ position:relative; display:inline-block; max-width:680px; width:100%; }
                img#preview{ width:100%; display:block; border-radius:8px;
                  box-shadow:0 8px 48px rgba(0,0,0,0.8); transition:opacity .2s; }
                img#preview.fade{ opacity:0; }
                /* ‚îÄ‚îÄ Tombol mengambang ‚îÄ‚îÄ */
                .fab{
                  position:absolute;
                  width:42px; height:42px; border-radius:50%;
                  background:rgba(30,30,30,0.75); border:none; cursor:pointer;
                  display:flex; align-items:center; justify-content:center;
                  font-size:19px; box-shadow:0 2px 12px rgba(0,0,0,0.5);
                  transition:transform .15s, background .15s;
                  backdrop-filter:blur(6px); color:white;
                }
                .fab:hover{ transform:scale(1.13); background:rgba(60,60,60,0.95); }
                .fab:active{ transform:scale(0.95); }
                .fab.done{ background:rgba(60,60,60,0.95); }
                .fab[disabled]{ cursor:wait; opacity:.7; }
                #back-btn{ top:10px; left:10px; }
                #dl-btn{   top:10px; right:10px; }
                #cr-btn{   top:62px; right:10px; font-size:16px; }

                /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                   CAROUSEL OVERLAY
                ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
                #carousel{
                  display:none;
                  position:fixed; inset:0; z-index:9999;
                  background:#000;
                  align-items:center; justify-content:center;
                }
                #carousel.active{ display:flex; }

                /* Kontainer 9:16 ‚Äî max tinggi layar */
                #cr-stage{
                  position:relative;
                  width:min(100vw, calc(100vh * 9/16));
                  height:min(100vh, calc(100vw * 16/9));
                  overflow:hidden;
                  perspective:1200px;
                  transform-style:preserve-3d;
                }

                /* Slide */
                .cr-slide{
                  position:absolute; inset:0;
                  display:flex; flex-direction:column;
                  align-items:center; justify-content:center;
                  opacity:0; pointer-events:none;
                  /* transform & transition dikontrol JS sepenuhnya */
                }
                .cr-slide.active{
                  opacity:1; pointer-events:auto;
                }

                /* Background slide ‚Äî gradient sesuai tema */
                .cr-bg{
                  position:absolute; inset:0;
                }

                /* Daun dekorasi sudut */
                .cr-leaf{ position:absolute; pointer-events:none; }

                /* Gambar produk */
                .cr-img-wrap{
                  position:relative; z-index:2;
                  width:72%; aspect-ratio:1/1;
                  border-radius:20px; overflow:hidden;
                  box-shadow:0 16px 48px rgba(0,0,0,0.35);
                  margin-bottom:0;
                }
                .cr-img-wrap img{
                  width:100%; height:100%; object-fit:cover; display:block;
                  border-radius:0;
                }
                .cr-img-placeholder{
                  width:100%; height:100%;
                  display:flex; align-items:center; justify-content:center;
                  font-size:4em; background:#e8ddd0;
                }

                /* Panel info bawah */
                .cr-info{
                  position:relative; z-index:2;
                  width:80%; text-align:center;
                  padding: 18px 10px 0;
                }
                .cr-store{
                  font-size:clamp(9px,2vw,12px);
                  letter-spacing:3px; opacity:0.65;
                  margin-bottom:6px; text-transform:uppercase;
                }
                .cr-name{
                  font-size:clamp(20px,5.5vw,32px);
                  font-weight:800; line-height:1.2;
                  margin-bottom:8px;
                }
                .cr-price{
                  font-family:'Dancing Script',cursive;
                  font-size:clamp(22px,6vw,38px);
                  font-weight:700; margin-bottom:10px;
                }
                .cr-badge{
                  display:inline-block;
                  font-size:clamp(10px,2.5vw,13px); font-weight:700;
                  padding:4px 16px; border-radius:20px; color:white;
                  letter-spacing:1px; opacity:0;
                }

                /* Keyframes ‚Äî dikontrol via inline style JS */
                @keyframes b-enter  { from{opacity:0;transform:translateY(14px) scale(0.75)} to{opacity:1;transform:translateY(0) scale(1)} }
                @keyframes b-pulse  { 0%,100%{transform:scale(1);box-shadow:0 0 0 0 rgba(255,255,255,0)} 50%{transform:scale(1.1);box-shadow:0 0 10px 4px rgba(255,255,255,0.45)} }
                @keyframes b-fade   { 0%,100%{opacity:1} 50%{opacity:0.28} }
                @keyframes b-bounce { 0%,100%{transform:translateY(0)} 35%{transform:translateY(-7px)} 65%{transform:translateY(-2px)} }
                @keyframes b-shake  { 0%,80%,100%{transform:translateX(0)} 83%{transform:translateX(-5px)} 87%{transform:translateX(5px)} 91%{transform:translateX(-4px)} 95%{transform:translateX(3px)} }

                /* Progress dots */
                #cr-dots{
                  position:absolute; top:14px; left:50%; transform:translateX(-50%);
                  display:flex; gap:5px; z-index:10;
                }
                .cr-dot{
                  width:6px; height:6px; border-radius:50%;
                  background:rgba(255,255,255,0.35);
                  transition:all .3s;
                }
                .cr-dot.active{
                  width:22px; border-radius:3px;
                  background:rgba(255,255,255,0.9);
                }

                /* Tap zones */
                #cr-tap-left, #cr-tap-right{
                  position:absolute; top:0; bottom:0; width:45%;
                  z-index:5; cursor:pointer;
                }
                #cr-tap-left { left:0; }
                #cr-tap-right{ right:0; }

                /* Exit button */
                #cr-exit{
                  position:absolute; top:12px; right:12px; z-index:20;
                  width:36px; height:36px; border-radius:50%;
                  background:rgba(0,0,0,0.45); border:none; cursor:pointer;
                  color:white; font-size:18px; display:flex;
                  align-items:center; justify-content:center;
                  backdrop-filter:blur(6px);
                  opacity:0;
                  transition:opacity .25s ease, background .15s;
                }
                #cr-exit:hover{ opacity:1; background:rgba(0,0,0,0.7); }

                /* Progress bar waktu (auto-advance) */
                #cr-progress{
                  position:absolute; bottom:0; left:0; height:3px;
                  background:rgba(255,255,255,0.6); z-index:10;
                  width:0%; transition:none;
                }
              </style>
            </head>
            <body>
              <div id="theme-bar"></div>
              <div id="style-bar"></div>
              <div class="wrap">
                <img id="preview" alt="Price List">
                <button id="back-btn" class="fab" onclick="window.close()" title="Kembali">‚Üê</button>
                <button id="dl-btn"   class="fab" onclick="doDownload()"    title="Unduh gambar">‚Üì</button>
                <button id="cr-btn"   class="fab" onclick="startCarousel()" title="Carousel WA Story">‚ñ∂</button>
              </div>

              <!-- CAROUSEL OVERLAY -->
              <div id="carousel">
                <div id="cr-stage">
                  <div id="cr-dots"></div>
                  <div id="cr-slides"></div>
                  <div id="cr-tap-left"  onclick="crPrev()"></div>
                  <div id="cr-tap-right" onclick="crNext()"></div>
                  <button id="cr-exit" onclick="stopCarousel()">‚úï</button>
                  <div id="cr-progress"></div>
                </div>
              </div>

              <script>
                var URLS      = ${urlsJson};
                var THEMES    = ${themesJson};
                var PRODS     = ${prodsJson};
                var TCFGS     = ${themeCfgsJson};
                var FN        = '${fn}';
                var active    = ${initIdx};
                var crIdx     = 0;
                var crTimer   = null;
                var crProgTm  = null;
                var CR_DELAY  = 4500; // ms per slide
                var STORE = '${storeName}';

                /* ‚îÄ‚îÄ‚îÄ PREVIEW / THEME ‚îÄ‚îÄ‚îÄ */
                function switchTheme(idx) {
                  if (idx === active) return;
                  active = idx;
                  var img = document.getElementById('preview');
                  img.classList.add('fade');
                  setTimeout(function(){
                    img.src = URLS[active];
                    img.classList.remove('fade');
                  }, 180);
                  document.querySelectorAll('.t-btn').forEach(function(b,i){
                    b.className = 't-btn' + (i===active?' active':'');
                  });
                }

                function buildBar() {
                  var bar = document.getElementById('theme-bar');
                  THEMES.forEach(function(t,i){
                    var b = document.createElement('button');
                    b.className = 't-btn'+(i===active?' active':'');
                    b.innerHTML = t.label+' '+t.name;
                    b.onclick   = function(){ switchTheme(i); };
                    bar.appendChild(b);
                  });
                }

                /* ‚îÄ‚îÄ‚îÄ DOWNLOAD ‚îÄ‚îÄ‚îÄ */
                function doDownload() {
                  var btn = document.getElementById('dl-btn');
                  btn.textContent='‚Ä¶'; btn.disabled=true;
                  var img=document.getElementById('preview');
                  var cvs=document.createElement('canvas');
                  cvs.width=img.naturalWidth; cvs.height=img.naturalHeight;
                  cvs.getContext('2d').drawImage(img,0,0);
                  cvs.toBlob(function(blob){
                    var url=URL.createObjectURL(blob);
                    var a=document.createElement('a');
                    a.href=url; a.download=FN+'_tema'+(active+1)+'.png';
                    document.body.appendChild(a); a.click();
                    setTimeout(function(){URL.revokeObjectURL(url);a.remove();},3000);
                    btn.textContent='‚úì'; btn.className='fab done'; btn.disabled=false;
                    setTimeout(function(){btn.textContent='‚Üì'; btn.className='fab';},3000);
                  },'image/png',1);
                }

                /* ‚îÄ‚îÄ‚îÄ CAROUSEL ‚îÄ‚îÄ‚îÄ */
                function leafSVG(corner, color, opacity) {
                  var size = 160;
                  var pos  = corner==='tr'?'top:0;right:0':corner==='tl'?'top:0;left:0':
                             corner==='bl'?'bottom:0;left:0':'bottom:0;right:0';
                  var ellipses = '';
                  var rot = { tr:[-35,-55,-15,-65,5], tl:[35,15,55], bl:[35,55,15,65,-5], br:[-35,-15,-55] };
                  var pts = {
                    tr:[[90,20,38,14],[70,8,30,10],[105,45,42,13],[55,25,36,11],[95,65,38,11]],
                    tl:[[40,30,34,12],[20,55,38,11],[60,18,28,9]],
                    bl:[[40,130,38,13],[60,145,30,10],[20,105,40,12],[75,125,34,11],[22,80,36,10]],
                    br:[[120,130,34,12],[140,105,38,11],[100,142,28,9]],
                  };
                  (pts[corner]||[]).forEach(function(p,i){
                    ellipses += '<ellipse cx="'+p[0]+'" cy="'+p[1]+'" rx="'+p[2]+'" ry="'+p[3]+'" '+
                      'transform="rotate('+(rot[corner]||[])[i]+' '+p[0]+' '+p[1]+')" fill="'+color+'"/>';
                  });
                  return '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 160 160" '+
                    'style="position:absolute;'+pos+';width:'+size+'px;height:'+size+'px;pointer-events:none;opacity:'+opacity+'">'+
                    '<g>'+ellipses+'</g></svg>';
                }

                function buildSlides() {
                  var container = document.getElementById('cr-slides');
                  var dots      = document.getElementById('cr-dots');
                  container.innerHTML = ''; dots.innerHTML = '';

                  var cfg = TCFGS[active] || TCFGS[0];

                  PRODS.forEach(function(p, i) {
                    // Slide
                    var slide = document.createElement('div');
                    slide.className = 'cr-slide' + (i===0?' active':'');
                    slide.dataset.idx = i;

                    // Background
                    var bg = document.createElement('div');
                    bg.className = 'cr-bg';
                    bg.style.background = 'linear-gradient(170deg,'+cfg.bg+' 0%,'+cfg.bgEnd+' 100%)';
                    slide.appendChild(bg);

                    // Daun sudut
                    slide.insertAdjacentHTML('beforeend', leafSVG('tr', cfg.leaf, 0.5));
                    slide.insertAdjacentHTML('beforeend', leafSVG('bl', cfg.leaf, 0.42));

                    // Gambar
                    var imgWrap = document.createElement('div');
                    imgWrap.className = 'cr-img-wrap';
                    if (p.image) {
                      var im = document.createElement('img');
                      im.src = p.image; im.alt = p.name;
                      imgWrap.appendChild(im);
                    } else {
                      imgWrap.innerHTML = '<div class="cr-img-placeholder">üì¶</div>';
                    }
                    slide.appendChild(imgWrap);

                    // Info
                    var info = document.createElement('div');
                    info.className = 'cr-info';
                    // Loop animation per status
                    var loopAnim = {
                      'Ready':    'b-pulse  2s   ease-in-out infinite',
                      'Habis':    'b-fade   2.2s ease-in-out infinite',
                      'Preorder': 'b-bounce 1.8s ease-in-out infinite',
                    }[p.statusLabel] || 'b-shake 2.8s ease-in-out infinite';

                    info.innerHTML =
                      '<div class="cr-store" style="color:'+cfg.sub+'">'+STORE+'</div>'+
                      '<div class="cr-name"  style="color:'+cfg.title+'">'+p.name+'</div>'+
                      '<div class="cr-price" style="color:'+cfg.title+'">'+p.price+'</div>'+
                      '<span class="cr-badge" data-loop="'+loopAnim+'" style="background:'+p.statusColor+'">'+p.statusLabel+'</span>';
                    slide.appendChild(info);

                    // Garis dekorasi bawah
                    var deco = document.createElement('div');
                    deco.style.cssText = 'position:absolute;bottom:22px;left:50%;transform:translateX(-50%);'+
                      'width:40px;height:2px;background:'+cfg.div+';border-radius:2px;opacity:0.6;';
                    slide.appendChild(deco);

                    container.appendChild(slide);

                    // Dot
                    var dot = document.createElement('div');
                    dot.className = 'cr-dot'+(i===0?' active':'');
                    dots.appendChild(dot);
                  });
                }

                function animateBadge(badge) {
                  if (!badge) return;
                  var loop = badge.dataset.loop || 'b-pulse 2s ease-in-out infinite';
                  // 1) Paksa reset ‚Äî clone trick agar browser benar-benar restart
                  badge.style.animation = 'none';
                  badge.style.opacity   = '0';
                  void badge.offsetWidth; // force reflow
                  // 2) Animasi masuk
                  badge.style.animation = 'b-enter 0.5s cubic-bezier(.34,1.56,.64,1) forwards';
                  // 3) Setelah masuk, ganti ke loop
                  clearTimeout(badge._at);
                  badge._at = setTimeout(function(){
                    if (!badge.isConnected) return;
                    badge.style.animation = loop;
                    badge.style.opacity   = '1';
                  }, 550);
                }

                var ANIM_DUR   = 420;
                var crStyle    = 'slide'; // slide | flip | zoom | push | blur

                function setSlideStyle(s){
                  crStyle = s;
                  document.querySelectorAll('.s-btn').forEach(function(b){
                    b.className = 's-btn'+(b.dataset.s===s?' active':'');
                  });
                }

                function buildStyleBar(){
                  var bar = document.getElementById('style-bar');
                  var styles = [
                    {s:'slide', label:'‚Üî Slide'},
                    {s:'flip',  label:'üÉè Flip'},
                    {s:'zoom',  label:'üåä Zoom'},
                    {s:'push',  label:'üìö Push'},
                    {s:'blur',  label:'‚ú® Blur'},
                  ];
                  styles.forEach(function(item){
                    var b = document.createElement('button');
                    b.className    = 's-btn'+(item.s==='slide'?' active':'');
                    b.dataset.s    = item.s;
                    b.textContent  = item.label;
                    b.onclick      = function(){ setSlideStyle(item.s); };
                    bar.appendChild(b);
                  });
                }

                function crGoTo(idx, direction) {
                  var slides = document.querySelectorAll('.cr-slide');
                  var dots   = document.querySelectorAll('.cr-dot');
                  if (!slides.length) return;
                  idx = (idx + slides.length) % slides.length;
                  if (idx === crIdx) return;

                  var fromIdx   = crIdx;
                  crIdx         = idx;
                  var fromSlide = slides[fromIdx];
                  var toSlide   = slides[crIdx];
                  var ease      = 'cubic-bezier(.4,0,.2,1)';
                  var D         = ANIM_DUR;

                  dots[fromIdx].classList.remove('active');
                  dots[crIdx].classList.add('active');

                  function cleanup(extra){
                    setTimeout(function(){
                      fromSlide.classList.remove('active');
                      fromSlide.style.cssText = '';
                      toSlide.style.cssText   = '';
                      if (extra) extra();
                    }, D + 40);
                  }

                  function reflow(el){ el.getBoundingClientRect(); }

                  if (crStyle === 'slide') {
                    // ‚îÄ‚îÄ Geser kiri / kanan
                    var tx    = direction==='next' ? '100%' : '-100%';
                    var txOut = direction==='next' ? '-35%' : '35%';
                    var tr    = 'transform '+D+'ms '+ease+', opacity '+D+'ms '+ease;
                    toSlide.style.cssText   = 'transition:none;transform:translateX('+tx+');opacity:1;pointer-events:auto;';
                    toSlide.classList.add('active');
                    reflow(toSlide);
                    toSlide.style.transition  = tr;
                    toSlide.style.transform   = 'translateX(0)';
                    fromSlide.style.transition= tr;
                    fromSlide.style.transform = 'translateX('+txOut+')';
                    fromSlide.style.opacity   = '0';
                    cleanup();

                  } else if (crStyle === 'flip') {
                    // ‚îÄ‚îÄ Balik kartu 3D ‚Äî dua fase sequential
                    var halfD  = Math.round(D * 0.55);
                    var rotOut = direction==='next' ? '-90deg' : '90deg';
                    var rotIn  = direction==='next' ? '90deg'  : '-90deg';
                    var tr3d   = 'transform '+halfD+'ms ease-in, opacity '+halfD+'ms ease-in';

                    // Fase 1: slide lama balik ke 90¬∞ (hilang)
                    fromSlide.style.transformOrigin = '50% 50%';
                    fromSlide.style.transition      = tr3d;
                    fromSlide.style.transform       = 'rotateY('+rotOut+') scale(0.92)';
                    fromSlide.style.opacity         = '0';

                    // Fase 2: setelah setengah jalan, masukkan slide baru
                    setTimeout(function(){
                      var tr3dIn = 'transform '+halfD+'ms ease-out, opacity '+halfD+'ms ease-out';
                      toSlide.style.cssText = 'transition:none;transform:rotateY('+rotIn+') scale(0.92);opacity:0;pointer-events:auto;';
                      toSlide.classList.add('active');
                      reflow(toSlide);
                      toSlide.style.transition = tr3dIn;
                      toSlide.style.transform  = 'rotateY(0deg) scale(1)';
                      toSlide.style.opacity    = '1';
                      cleanup();
                    }, halfD + 10);

                  } else if (crStyle === 'zoom') {
                    // ‚îÄ‚îÄ Slide lama mengecil ke tengah, slide baru zoom in
                    var tr = 'transform '+D+'ms '+ease+', opacity '+D+'ms '+ease+', filter '+D+'ms '+ease;
                    toSlide.style.cssText   = 'transition:none;transform:scale(1.18);opacity:0;filter:blur(6px);pointer-events:auto;';
                    toSlide.classList.add('active');
                    reflow(toSlide);
                    toSlide.style.transition  = tr;
                    toSlide.style.transform   = 'scale(1)';
                    toSlide.style.opacity     = '1';
                    toSlide.style.filter      = 'blur(0px)';
                    fromSlide.style.transition= tr;
                    fromSlide.style.transform = 'scale(0.82)';
                    fromSlide.style.opacity   = '0';
                    fromSlide.style.filter    = 'blur(4px)';
                    cleanup();

                  } else if (crStyle === 'push') {
                    // ‚îÄ‚îÄ Slide baru naik dari bawah mendorong slide lama ke atas
                    var ty    = direction==='next' ? '100%' : '-100%';
                    var tyOut = direction==='next' ? '-100%': '100%';
                    var tr    = 'transform '+D+'ms '+ease;
                    toSlide.style.cssText   = 'transition:none;transform:translateY('+ty+');opacity:1;pointer-events:auto;';
                    toSlide.classList.add('active');
                    reflow(toSlide);
                    toSlide.style.transition  = tr;
                    toSlide.style.transform   = 'translateY(0)';
                    fromSlide.style.transition= tr;
                    fromSlide.style.transform = 'translateY('+tyOut+')';
                    cleanup();

                  } else if (crStyle === 'blur') {
                    // ‚îÄ‚îÄ Crossfade + blur sinematik, overlap penuh
                    var tr = 'opacity '+D+'ms '+ease+', filter '+D+'ms '+ease+', transform '+D+'ms '+ease;
                    toSlide.style.cssText   = 'transition:none;opacity:0;filter:blur(14px);transform:scale(1.06);pointer-events:auto;';
                    toSlide.classList.add('active');
                    reflow(toSlide);
                    toSlide.style.transition  = tr;
                    toSlide.style.opacity     = '1';
                    toSlide.style.filter      = 'blur(0px)';
                    toSlide.style.transform   = 'scale(1)';
                    fromSlide.style.transition= tr;
                    fromSlide.style.opacity   = '0';
                    fromSlide.style.filter    = 'blur(14px)';
                    fromSlide.style.transform = 'scale(0.94)';
                    cleanup();
                  }

                  animateBadge(toSlide.querySelector('.cr-badge'));
                  resetProgress();
                }

                function crNext() { crGoTo(crIdx+1,'next'); }
                function crPrev() { crGoTo(crIdx-1,'prev'); }

                function resetProgress() {
                  clearTimeout(crTimer);
                  var bar = document.getElementById('cr-progress');
                  bar.style.transition = 'none';
                  bar.style.width = '0%';
                  // force reflow
                  bar.getBoundingClientRect();
                  bar.style.transition = 'width '+CR_DELAY+'ms linear';
                  bar.style.width = '100%';
                  crTimer = setTimeout(crNext, CR_DELAY);
                }

                function startCarousel() {
                  buildSlides();
                  crIdx = 0;
                  // Jalankan animasi badge slide pertama
                  setTimeout(function(){
                    animateBadge(document.querySelector('.cr-slide.active .cr-badge'));
                  }, 100);
                  document.getElementById('carousel').classList.add('active');
                  document.getElementById('theme-bar').style.visibility = 'hidden';
                  document.getElementById('style-bar').style.visibility  = 'hidden';
                  document.getElementById('back-btn').style.visibility  = 'hidden';
                  document.getElementById('dl-btn').style.visibility    = 'hidden';
                  document.getElementById('cr-btn').style.visibility    = 'hidden';
                  resetProgress();
                }

                function stopCarousel() {
                  clearTimeout(crTimer);
                  var bar = document.getElementById('cr-progress');
                  bar.style.transition='none'; bar.style.width='0%';
                  document.getElementById('carousel').classList.remove('active');
                  document.getElementById('theme-bar').style.visibility = '';
                  document.getElementById('style-bar').style.visibility  = '';
                  document.getElementById('back-btn').style.visibility  = '';
                  document.getElementById('dl-btn').style.visibility    = '';
                  document.getElementById('cr-btn').style.visibility    = '';
                }

                // Keyboard navigation
                document.addEventListener('keydown', function(e){
                  if (!document.getElementById('carousel').classList.contains('active')) return;
                  if (e.key==='ArrowRight'||e.key==='ArrowDown') crNext();
                  if (e.key==='ArrowLeft'||e.key==='ArrowUp')   crPrev();
                  if (e.key==='Escape') stopCarousel();
                });

                buildBar();
                buildStyleBar();
                document.getElementById('preview').src = URLS[active];
              <\/script>
            </body></html>`);
          w.document.close();

        } else if (format === 'pdf') {
          cvs.toBlob(blob => {
            const fr = new FileReader();
            fr.onload = () => {
              const { jsPDF } = window.jspdf;
              const ratio = cvs.height / cvs.width;
              const pdf   = new jsPDF({ orientation: ratio>1?'p':'l', unit:'mm', format:'a4' });
              const pW = pdf.internal.pageSize.getWidth();
              const pH = pdf.internal.pageSize.getHeight();
              let dW = pW, dH = pW * ratio;
              if (dH > pH) { dH = pH; dW = pH / ratio; }
              pdf.addImage(fr.result, 'JPEG', (pW-dW)/2, 0, dW, dH);
              _blobDownload(pdf.output('blob'), fn + '.pdf');
            };
            fr.readAsDataURL(blob);
          }, 'image/jpeg', 0.95);
        }

      } catch(err) {
        console.error(err); alert('Gagal: ' + err.message);
      } finally {
        btn.textContent = origText; btn.disabled = false;
      }
    }

    document.getElementById('priceListModal')?.addEventListener('click', function(e) {
      if (e.target === this) closePriceList();
    });
  </script>

  <!-- ‚ïê‚ïê‚ïê‚ïê PWA: Manifest + Service Worker ‚ïê‚ïê‚ïê‚ïê -->
  <script>
  (function() {
    // ‚îÄ‚îÄ Manifest via Blob URL
    var manifestData = `{"name":"NURI SNACK","short_name":"Nuri Snack","description":"Aplikasi POS Nuri Snack \u2014 Cemilan Seru Buat Semua","start_url":".","display":"standalone","orientation":"portrait","background_color":"#046043","theme_color":"#046043","lang":"id","icons":[{"src":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iZyIgeDE9IjAlIiB5MT0iMCUiIHgyPSIxMDAlIiB5Mj0iMTAwJSI+CiAgICAgIDxzdG9wIG9mZnNldD0iMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiMwNDYwNDMiLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojMmNiOTEwIi8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogIDwvZGVmcz4KICA8cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjExMiIgZmlsbD0idXJsKCNnKSIvPgogIDwhLS0gRGF1biBkZWtvcmFzaSAtLT4KICA8ZWxsaXBzZSBjeD0iNDIwIiBjeT0iODAiIHJ4PSI1NSIgcnk9IjIwIiB0cmFuc2Zvcm09InJvdGF0ZSgtNDAgNDIwIDgwKSIgZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwwLjE1KSIvPgogIDxlbGxpcHNlIGN4PSIzOTAiIGN5PSI1NSIgcng9IjQ1IiByeT0iMTYiIHRyYW5zZm9ybT0icm90YXRlKC02MCAzOTAgNTUpIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMTIpIi8+CiAgPGVsbGlwc2UgY3g9IjkwIiBjeT0iNDMwIiByeD0iNTUiIHJ5PSIyMCIgdHJhbnNmb3JtPSJyb3RhdGUoMTQwIDkwIDQzMCkiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4xNSkiLz4KICA8ZWxsaXBzZSBjeD0iMTIwIiBjeT0iNDU1IiByeD0iNDUiIHJ5PSIxNiIgdHJhbnNmb3JtPSJyb3RhdGUoMTIwIDEyMCA0NTUpIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMTIpIi8+CiAgPCEtLSBUZWtzIE5TIC0tPgogIDx0ZXh0IHg9IjI1NiIgeT0iMzEwIiBmb250LWZhbWlseT0iQXJpYWwgQmxhY2ssc2Fucy1zZXJpZiIgZm9udC13ZWlnaHQ9IjkwMCIKICAgICAgICBmb250LXNpemU9IjIyMCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0id2hpdGUiIGxldHRlci1zcGFjaW5nPSItOCI+TlM8L3RleHQ+CiAgPCEtLSBHYXJpcyBiYXdhaCBkZWtvcmF0aWYgLS0+CiAgPHJlY3QgeD0iMTU2IiB5PSIzMzYiIHdpZHRoPSIyMDAiIGhlaWdodD0iOCIgcng9IjQiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC41KSIvPgogIDwhLS0gVGVrcyBrZWNpbCAtLT4KICA8dGV4dCB4PSIyNTYiIHk9IjM5MCIgZm9udC1mYW1pbHk9IkFyaWFsLHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iNDIiCiAgICAgICAgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwwLjg1KSIgbGV0dGVyLXNwYWNpbmc9IjQiPlNOQUNLPC90ZXh0Pgo8L3N2Zz4=","sizes":"512x512","type":"image/svg+xml","purpose":"any maskable"},{"src":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iZyIgeDE9IjAlIiB5MT0iMCUiIHgyPSIxMDAlIiB5Mj0iMTAwJSI+CiAgICAgIDxzdG9wIG9mZnNldD0iMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiMwNDYwNDMiLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojMmNiOTEwIi8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogIDwvZGVmcz4KICA8cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjExMiIgZmlsbD0idXJsKCNnKSIvPgogIDwhLS0gRGF1biBkZWtvcmFzaSAtLT4KICA8ZWxsaXBzZSBjeD0iNDIwIiBjeT0iODAiIHJ4PSI1NSIgcnk9IjIwIiB0cmFuc2Zvcm09InJvdGF0ZSgtNDAgNDIwIDgwKSIgZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwwLjE1KSIvPgogIDxlbGxpcHNlIGN4PSIzOTAiIGN5PSI1NSIgcng9IjQ1IiByeT0iMTYiIHRyYW5zZm9ybT0icm90YXRlKC02MCAzOTAgNTUpIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMTIpIi8+CiAgPGVsbGlwc2UgY3g9IjkwIiBjeT0iNDMwIiByeD0iNTUiIHJ5PSIyMCIgdHJhbnNmb3JtPSJyb3RhdGUoMTQwIDkwIDQzMCkiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4xNSkiLz4KICA8ZWxsaXBzZSBjeD0iMTIwIiBjeT0iNDU1IiByeD0iNDUiIHJ5PSIxNiIgdHJhbnNmb3JtPSJyb3RhdGUoMTIwIDEyMCA0NTUpIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMTIpIi8+CiAgPCEtLSBUZWtzIE5TIC0tPgogIDx0ZXh0IHg9IjI1NiIgeT0iMzEwIiBmb250LWZhbWlseT0iQXJpYWwgQmxhY2ssc2Fucy1zZXJpZiIgZm9udC13ZWlnaHQ9IjkwMCIKICAgICAgICBmb250LXNpemU9IjIyMCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0id2hpdGUiIGxldHRlci1zcGFjaW5nPSItOCI+TlM8L3RleHQ+CiAgPCEtLSBHYXJpcyBiYXdhaCBkZWtvcmF0aWYgLS0+CiAgPHJlY3QgeD0iMTU2IiB5PSIzMzYiIHdpZHRoPSIyMDAiIGhlaWdodD0iOCIgcng9IjQiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC41KSIvPgogIDwhLS0gVGVrcyBrZWNpbCAtLT4KICA8dGV4dCB4PSIyNTYiIHk9IjM5MCIgZm9udC1mYW1pbHk9IkFyaWFsLHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iNDIiCiAgICAgICAgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwwLjg1KSIgbGV0dGVyLXNwYWNpbmc9IjQiPlNOQUNLPC90ZXh0Pgo8L3N2Zz4=","sizes":"192x192","type":"image/svg+xml","purpose":"any maskable"}]}`;
    var manifestBlob = new Blob([manifestData], {type: 'application/manifest+json'});
    var manifestUrl  = URL.createObjectURL(manifestBlob);
    var linkEl = document.createElement('link');
    linkEl.rel  = 'manifest';
    linkEl.href = manifestUrl;
    document.head.appendChild(linkEl);

    // ‚îÄ‚îÄ Service Worker (cache-first, offline support)
    var SW_CACHE = 'nuri-snack-v1';
    var swCode = `
      var CACHE = 'nuri-snack-v1';
      self.addEventListener('install', function(e) {
        self.skipWaiting();
      });
      self.addEventListener('activate', function(e) {
        e.waitUntil(
          caches.keys().then(function(keys) {
            return Promise.all(keys.filter(function(k){return k!==CACHE;}).map(function(k){return caches.delete(k);}));
          }).then(function(){ return self.clients.claim(); })
        );
      });
      self.addEventListener('fetch', function(e) {
        // Hanya cache request GET
        if (e.request.method !== 'GET') return;
        e.respondWith(
          caches.match(e.request).then(function(cached) {
            if (cached) return cached;
            return fetch(e.request).then(function(resp) {
              if (!resp || resp.status !== 200) return resp;
              var clone = resp.clone();
              caches.open(CACHE).then(function(c){ c.put(e.request, clone); });
              return resp;
            }).catch(function() {
              return new Response('<h2 style="font-family:sans-serif;text-align:center;padding:40px">‚ö†Ô∏è Tidak ada koneksi. Buka ulang saat online.</h2>', {headers:{'Content-Type':'text/html'}});
            });
          })
        );
      });
    `;
    if ('serviceWorker' in navigator) {
      var swBlob = new Blob([swCode], {type: 'application/javascript'});
      var swUrl  = URL.createObjectURL(swBlob);
      navigator.serviceWorker.register(swUrl, {scope: './'
      }).then(function(reg) {
        console.log('[PWA] SW registered, scope:', reg.scope);
      }).catch(function(err) {
        console.warn('[PWA] SW registration failed:', err);
      });
    }

    // ‚îÄ‚îÄ Install prompt
    var deferredPrompt = null;
    var banner = document.getElementById('pwa-banner');
    var dismissed = localStorage.getItem('pwa-dismissed');

    window.addEventListener('beforeinstallprompt', function(e) {
      e.preventDefault();
      deferredPrompt = e;
      if (!dismissed) {
        banner.style.display = 'flex';
      }
    });

    document.getElementById('pwa-install-btn').addEventListener('click', function() {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then(function(choice) {
        deferredPrompt = null;
        banner.style.display = 'none';
      });
    });

    document.getElementById('pwa-dismiss-btn').addEventListener('click', function() {
      banner.style.display = 'none';
      localStorage.setItem('pwa-dismissed', '1');
    });

    window.addEventListener('appinstalled', function() {
      banner.style.display = 'none';
      console.log('[PWA] Installed!');
    });
  })();
  </script>

</body>
</html>